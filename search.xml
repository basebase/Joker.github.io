<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[hadoop Partitionerä½¿ç”¨åŠæ³¨æ„ç‚¹]]></title>
      <url>http://yoursite.com/2017/02/07/hadoop-Partitioner%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%B3%A8%E6%84%8F%E7%82%B9/</url>
      <content type="html"><![CDATA[<p>å‰è¨€<br>hadoopå·²ç»å‡ºæ¥è¿™ä¹ˆé•¿æ—¶é—´äº†ï¼Œåˆ†åŒºçš„æ–‡ç« æ—©å·²ç»å¤šå¦‚ç‰›æ¯›ï¼Œä¸ºä½•ä½ è¿˜è¦å†™å‘¢?<br>å…¶å®å‘¢ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³è¦ä»‹ç»ä¸€ä¸‹ä½¿ç”¨MRè‡ªå®šä¹‰åˆ†åŒºéœ€è¦æ³¨æ„çš„ä¸€äº›ç‚¹ã€‚<br><a id="more"></a></p>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>hadoopå·²ç»å‡ºæ¥è¿™ä¹ˆé•¿æ—¶é—´äº†ï¼Œåˆ†åŒºçš„æ–‡ç« æ—©å·²ç»å¤šå¦‚ç‰›æ¯›ï¼Œä¸ºä½•ä½ è¿˜è¦å†™å‘¢?<br>å…¶å®å‘¢ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³è¦ä»‹ç»ä¸€ä¸‹ä½¿ç”¨MRè‡ªå®šä¹‰åˆ†åŒºéœ€è¦æ³¨æ„çš„ä¸€äº›ç‚¹ã€‚<br>å¯èƒ½æ—©æœ‰å‰è¾ˆå·²ç»æŒ‡å‡ºè¯¥é—®é¢˜äº†ã€‚ä½†è¿˜æ˜¯å®¹æˆ‘è‡ªå·±åšä¸€ä¸ªå°å°çš„è®°å½•ï¼Œå“ˆå“ˆå“ˆ~~~</p>
<p>æˆ‘ä»¬çŸ¥é“mapæ•°æ®ä¼šå†™å…¥åˆ°åˆ†åŒºï¼Œé»˜è®¤çš„åˆ†åŒºåªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯æˆ‘æƒ³è¦10ä¸ªåˆæˆ–è€…æ˜¯100ä¸ªï¼Œå¯ä»¥å—ï¼Ÿ<br>å½“ç„¶æ˜¯å¯ä»¥çš„æ˜¯ã€‚</p>
<p>ä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿org.apache.hadoop.mapreduce.Partitioner<br>ç±»å°±å¯ä»¥å®Œå…¨å®šä¹‰è‡ªå·±æƒ³è¦çš„åˆ†åŒºæ–¹å¼ã€‚<br>ç„¶ååœ¨jobä¸­è®¾ç½®è‡ªå®šä¹‰çš„Partitionerç±»å³å¯ã€‚<br>ä½†æ˜¯ï¼Œè¿™æ ·å†™çœŸçš„å°±ç»“æŸäº†å—ï¼Ÿ</p>
<h3 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h3><p>PartitionMapper.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">        String[] tokens = value.toString().split(<span class="string">","</span>);</div><div class="line">        String gender = tokens[<span class="number">2</span>];</div><div class="line">        String nameAgeScore = tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">1</span>] + <span class="string">","</span> + tokens[<span class="number">3</span>];</div><div class="line">        context.write(<span class="keyword">new</span> Text(gender), <span class="keyword">new</span> Text(nameAgeScore));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>AgePartitioner.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(Text key, Text value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</div><div class="line">        </div><div class="line">        String[] nameAgeScore = value.toString().split(<span class="string">","</span>);</div><div class="line">        String age = nameAgeScore[<span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> ageInt = Integer.parseInt(age);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (numPartitions == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ageInt &lt;= <span class="number">20</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ageInt &gt; <span class="number">20</span> &amp;&amp; ageInt &lt;= <span class="number">50</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span> % numPartitions;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">2</span> % numPartitions;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ParitionReducer.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values, Context context)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> maxScore = Integer.MIN_VALUE;</div><div class="line">        String name = <span class="string">""</span>;</div><div class="line">        String age = <span class="string">""</span>;</div><div class="line">        String gender = <span class="string">""</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> score = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (Text val : values) &#123;</div><div class="line">            String[] valTokens = val.toString().split(<span class="string">","</span>);</div><div class="line">            score = Integer.parseInt(valTokens[<span class="number">2</span>]);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (score &gt; maxScore) &#123;</div><div class="line">                name = valTokens[<span class="number">0</span>];</div><div class="line">                age = valTokens[<span class="number">1</span>];</div><div class="line">                gender = key.toString();</div><div class="line">                maxScore = score;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        context.write(<span class="keyword">new</span> Text(name), <span class="keyword">new</span> Text(<span class="string">"age- "</span> + age + <span class="string">","</span> + gender + <span class="string">","</span> + <span class="string">" score-"</span> + maxScore));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>é©±åŠ¨ç±»ï¼Œå…·ä½“çš„æ¨¡æ¿ä»£ç æˆ‘å°±ä¸å†å†™å…¥ï¼Œåªå°†Partitionerè®¾ç½®å±•ç¤º<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">job.setPartitionerClass(AgePartitioner.class);</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸Šè¿™ä¸ªä¾‹å­ï¼Œæ˜¯æˆ‘åœ¨å…¶å®ƒæ–‡ç« ä¸­æˆªå–ä¸‹æ¥çš„ï¼Œå…·ä½“åœ°å€ï¼Œä¼šåœ¨é“¾æ¥ä¸­ç»™å‡ºã€‚<br>ç°åœ¨ï¼Œä½ å¯ä»¥è¿è¡Œè¯¥ä¾‹å­ï¼Œä½ ä¼šå‘ç°Reduceè¾“å‡ºçš„åªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åä½ è¿˜ä¼šå‘ç°å…¶å®ä½¿ç”¨çš„å¹¶éæ˜¯è‡ªå®šä¹‰<br>çš„Partitionerç±»ã€‚</p>
<p>ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘æœ‰ç‚¹æ‡µé€¼äº†ã€‚whatï¼Ÿæˆ‘çš„è®¾ç½®æ²¡æœ‰ç”Ÿæ•ˆå—ï¼Ÿ<br>ä½ çš„è®¾ç½®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ä½ å´å¿˜è®°äº†ä¸€é¡¹é‡è¦çš„äº‹æƒ…ã€‚ç©¶ç«Ÿæ˜¯ä»€ä¹ˆäº‹æƒ…å‘€ï¼Œå¿«ç‚¹è¯´è¯´å‘€ï¼ˆè‡­é±¼ï¼‰ã€‚<br>åœ¨è¯´å‡ºè¿™ä¸ªç§˜å¯†ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹çœ‹mapçš„context.write()è¿™ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆåšçš„å§ã€‚</p>
<p>MapTask.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(K key, V value)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">      collector.collect(key, value,</div><div class="line">                        partitioner.getPartition(key, value, partitions));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­partitioneræ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„å‘¢ï¼Ÿ<br>åœ¨NewOutputCollectorç±»ä¸­ï¼Œè¯¥ç±»ä½œä¸ºMapTaskå†…éƒ¨ç±»ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NewOutputCollector</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line">    <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">hadoop</span>.<span class="title">mapreduce</span>.<span class="title">RecordWriter</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MapOutputCollector&lt;K,V&gt; collector;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> org.apache.hadoop.mapreduce.Partitioner&lt;K,V&gt; partitioner;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> partitions;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    NewOutputCollector(org.apache.hadoop.mapreduce.JobContext jobContext,</div><div class="line">                       JobConf job,</div><div class="line">                       TaskUmbilicalProtocol umbilical,</div><div class="line">                       TaskReporter reporter</div><div class="line">                       ) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</div><div class="line">      collector = createSortingCollector(job, reporter);</div><div class="line">      partitions = jobContext.getNumReduceTasks();</div><div class="line">      <span class="keyword">if</span> (partitions &gt; <span class="number">1</span>) &#123;</div><div class="line">        partitioner = (org.apache.hadoop.mapreduce.Partitioner&lt;K,V&gt;)</div><div class="line">          ReflectionUtils.newInstance(jobContext.getPartitionerClass(), job);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        partitioner = <span class="keyword">new</span> org.apache.hadoop.mapreduce.Partitioner&lt;K,V&gt;() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(K key, V value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> partitions - <span class="number">1</span>;</div><div class="line">          &#125;</div><div class="line">        &#125;;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ„é€ å‡½æ•°ä¹‹ä¸­ï¼Œå¦‚æœpartitionså¤§äº1å°±ä»é…ç½®ä¸­è¯»å–æˆ‘ä»¬è‡ªå·±çš„Partitionerå¯¹è±¡å¹¶å®ä¾‹åŒ–ç»™å¼•ç”¨ï¼Œå¦åˆ™è‡ªå·±å°±åˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚<br>é‚£partitionsæ˜¯ä»jobContext.getNumReduceTasks();è¯»å–å‡ºæ¥çš„ï¼Œè¿™ä¸ªè¦æ€ä¹ˆé…ç½®å‘¢ï¼Ÿ</p>
<font color="DeepPink" size="3"><br>job.setNumReduceTasks(number);<br></font>

<p>é…ç½®è¯¥å€¼ä¹‹åï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„åˆ†åŒºå‡½æ•°äº†ã€‚<br>å¥½äº†ï¼Œæ–‡ç« åˆ°è¿™é‡Œä¹Ÿå°±ç»“æŸäº†ï¼Œæ¬¢è¿å¤§å®¶æ‹ç –ï¼ï¼ï¼</p>
<h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><p><a color="red" href="https://hadooptutorial.wikispaces.com/Custom+partitioner" target="_blank" rel="external"><br>å°±è¿™é‡Œçš„ä¾‹å­ï¼Œæ•°æ®è¿™é‡Œä¹Ÿæœ‰</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mapreduce join]]></title>
      <url>http://yoursite.com/2017/02/03/mapreduce-join/</url>
      <content type="html"><![CDATA[<p>å‰è¨€<br>æˆ‘ä»¬çŸ¥é“hiveï¼Œmysqlç­‰sqlè¯­è¨€éƒ½å¯ä»¥è¿›è¡Œjoinæ“ä½œã€‚é‚£ä¹ˆmapreduceæ˜¯å¦‚ä½•joinçš„å‘¢ï¼Ÿ<br>åœ¨è¯´æ˜mapreduceè¿›è¡Œjoinå¼€å§‹ï¼Œæˆ‘ä»¬æ¥å…ˆçœ‹çœ‹sqlçš„è¯­æ³•ã€‚</p>
<a id="more"></a>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æˆ‘ä»¬çŸ¥é“hiveï¼Œmysqlç­‰sqlè¯­è¨€éƒ½å¯ä»¥è¿›è¡Œjoinæ“ä½œã€‚é‚£ä¹ˆmapreduceæ˜¯å¦‚ä½•joinçš„å‘¢ï¼Ÿ<br>åœ¨è¯´æ˜mapreduceè¿›è¡Œjoinå¼€å§‹ï¼Œæˆ‘ä»¬æ¥å…ˆçœ‹çœ‹sqlçš„è¯­æ³•ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> </div><div class="line">    tab1.*, </div><div class="line">    tab2.* </div><div class="line"><span class="keyword">FROM</span> </div><div class="line">    table1 tab1</div><div class="line"><span class="keyword">JOIN</span></div><div class="line">    table2 tb2 </div><div class="line">    <span class="keyword">on</span> tab1.id = tab2.id</div></pre></td></tr></table></figure>
<p>ä¸¤å¼ è¡¨å…³è”åœ¨ä¸€èµ·ï¼Œéœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±ä»ä¸åŒçš„è¡¨ä¸­å–å‡ºæ•°æ®å³å¯ã€‚</p>
<h3 id="mapreduceå¦‚ä½•JOIN"><a href="#mapreduceå¦‚ä½•JOIN" class="headerlink" title="mapreduceå¦‚ä½•JOIN"></a>mapreduceå¦‚ä½•JOIN</h3><p>é€šè¿‡å‰é¢çš„é“ºå«ï¼Œæˆ‘ä»¬çŸ¥é“sqlè¿›è¡Œè¡¨å…³è”æ˜¯å¤šä¹ˆçš„ç®€å•ã€‚é‚£ä¹ˆé€šè¿‡ç¨‹åºå¦‚ä½•è¿›è¡Œå…³è”å‘¢ï¼Ÿ<br>æˆ‘ä»¬hiveçš„æ•°æ®æ˜¯ä¸æ˜¯ä»HDFSä¸Šæ¥çš„ï¼ŒHDFSä¸Šæ˜¯ä¸æ˜¯æ–‡ä»¶æ•°æ®ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠè¡¨æ•°æ®çœ‹æˆæ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚<br>é‚£ä¹ˆä¸¤å¼ è¡¨å¯ä¸å¯ä»¥çœ‹æˆä¸¤ä¸ªæ–‡ä»¶ï¼Œhiveä¹Ÿæ˜¯æ‹¿åˆ°è¿™ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œå…³è”çš„ã€‚</p>
<p>ç°åœ¨å¦‚æœä¸ä½¿ç”¨MRè¿›è¡Œè®¡ç®—ï¼Œå†™ä¸€ä¸ªç¨‹åºæ¥è¿›è¡Œè¿æ¥å‘¢ï¼Ÿ<br>æ–‡ä»¶Aå‡è®¾1GBï¼Œæ–‡ä»¶B500MBã€‚<br>æ­¤æ—¶ï¼Œæˆ‘ä¹ˆå¯ä»¥æŠŠæ–‡ä»¶Bè¯»å…¥åˆ°å†…å­˜ä¹‹ä¸­ã€‚<br>æ–‡ä»¶Bçš„æ•°æ®ç»“æ„ï¼š<br>    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Map&lt;String, List&lt;String&gt;&gt;</div></pre></td></tr></table></figure></p>
<p>ç„¶åä¸€è¡Œä¸€è¡Œè¯»å–æ–‡ä»¶Açš„æ•°æ®ï¼Œåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æŠŠæ–‡ä»¶Açš„å€¼+Listçš„å€¼éå†è¾“å‡º<br>æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥å¾—åˆ°å‘¢ã€‚</p>
<p>ä¸Šé¢çš„æ•°æ®å¯ä»¥æ”¾ç½®åœ¨å†…å­˜ä¸­ï¼Œæˆ‘è§‰å¾—æŒºåˆç†çš„ï¼Œåº”ä¸ºå•æœºèƒ½å¤„ç†çš„æ•°æ®è¡¨ç¤ºæ•°æ®é‡æ™®éä¸ç®—å¾ˆå¤§ã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœè¯´ä½ ç°åœ¨çš„æ•°æ®æœ‰1Tå‘¢ï¼Ÿè¿˜æœ‰å¯èƒ½æ”¾ç½®åœ¨å†…å­˜ä¸­å—ï¼Ÿ</p>
<p>æˆ‘çœ‹è¿‡å¤§éƒ¨åˆ†åšå®¢å†…å®¹ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ç›¸åŒçš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values,</span></span></div><div class="line">                Reducer&lt;Text, Text, Text, Text&gt;.Context context)</div><div class="line">                <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line"></div><div class="line">            LinkedList&lt;String&gt; linkU = <span class="keyword">new</span> LinkedList&lt;String&gt;();  <span class="comment">//userså€¼</span></div><div class="line">            LinkedList&lt;String&gt; linkL = <span class="keyword">new</span> LinkedList&lt;String&gt;();  <span class="comment">//login_logså€¼</span></div><div class="line">              </div><div class="line">            <span class="keyword">for</span> (Text tval : values) &#123;</div><div class="line">                String val = tval.toString();  </div><div class="line">                <span class="keyword">if</span>(val.startsWith(<span class="string">"u#"</span>)) &#123;</div><div class="line">                    linkU.add(val.substring(<span class="number">2</span>));</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(val.startsWith(<span class="string">"l#"</span>)) &#123;</div><div class="line">                    linkL.add(val.substring(<span class="number">2</span>));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">              </div><div class="line">            <span class="keyword">for</span> (String u : linkU) &#123;</div><div class="line">                <span class="keyword">for</span> (String l : linkL) &#123;</div><div class="line">                    context.write(key, <span class="keyword">new</span> Text(u + DELIMITER + l));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™ç§å†™æ³•å¯¹å—ï¼Œæ˜¯å¯¹çš„ã€‚ä½†æ˜¯æœ‰æ²¡æœ‰æ›´å¥½çš„ï¼Œæœ‰ã€‚ï¼ˆç¨åè®©ä½ çœ‹ï¼ŒğŸ˜ğŸ˜ğŸ˜ğŸ˜ï¼‰<br>ä½†æ˜¯ï¼Œæˆ‘ä¹ˆé€šå¸¸ä¹Ÿä¼šé‡åˆ°æ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œå¯èƒ½æ˜¯æŸä¸€ç»„å€¼ç‰¹åˆ«çš„å¤§ï¼Œé‚£ä¹ˆå¦‚æœåœ¨JOINçš„æ—¶å€™<br>ä¹Ÿé‡åˆ°äº†ç‰¹åˆ«å¤šç›¸åŒçš„keyå€¼ï¼Œé‚£ä¹ˆå†…å­˜è¿˜æ”¾å¾—ä¸‹å—ï¼Ÿ<br>ä¸è¿‡è¿™ä½ä½¿ç”¨LinkedListä¹Ÿæ˜¯éå¸¸ä¸é”™çš„ï¼Œæ’å…¥åˆ é™¤é€Ÿåº¦ä¹Ÿæ˜¯ä¼˜äºArrayListï¼ˆç‚¹ä¸ªèµï¼‰ã€‚</p>
<p>å¥½äº†ï¼Œè¯´äº†è¿™ä¹ˆå¤šã€‚ä½ çœŸçš„èƒ½æ¯”è¿™äº›äººçš„å†…å®¹å†™çš„å¥½çš„å—ï¼Ÿä¸ä¼šå†å¹ç‰›å§ï¼ˆå°´å°¬è¡¨æƒ…ï¼‰</p>
<p>æ¥è¯´è¯´æˆ‘å¦‚ä½•å»åšã€‚<br>è‡ªå®šä¹‰keyå€¼ä¹‹åï¼Œç”±äºæˆ‘ä¸æ˜¯æ”¾å…¥å†…å­˜çš„ï¼Œæ‰€ä»¥å­—æ®µè¾“å‡ºçš„é¡ºåºå¯èƒ½æ˜¯æœ‰ç‚¹é—®é¢˜çš„<br>æ‰€ä»¥è¿˜è¦è¿›è¡ŒäºŒæ¬¡æ’åºï¼Œåˆ°reduceçš„æ—¶å€™ä¸€ç»„æ•°æ®å·²ç»åœ¨ä¸€èµ·äº†ï¼Œæˆ‘ä¹ˆè®¾ç½®ä¸€ä¸ªbooleanå€¼<br>åœ¨ç¬¬ä¸€æ¬¡éå†å€¼çš„æ—¶å€™ä¸å†™å…¥æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯è®°å½•åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åç¬¬äºŒæ¬¡booleanæ›´æ”¹å<br>æŠŠä¸Šä¸€æ¬¡å’Œè¿™ä¸€æ¬¡çš„å€¼ä¸€èµ·å†™å…¥ã€‚</p>
<p>æ¥çœ‹çœ‹ä»£ç å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">Pair</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Text first;</div><div class="line">    <span class="keyword">private</span> Text second;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(String first, String second)</span> </span>&#123;</div><div class="line">        set(<span class="keyword">new</span> Text(first), <span class="keyword">new</span> Text(second));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">()</span> </span>&#123;</div><div class="line">        set(<span class="keyword">new</span> Text(), <span class="keyword">new</span> Text());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(Text first, String second)</span> </span>&#123;</div><div class="line">        set(first, <span class="keyword">new</span> Text(second));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(String first, Text second)</span> </span>&#123;</div><div class="line">        set(<span class="keyword">new</span> Text(first), second);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Text first, Text second)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.first = first;</div><div class="line">        <span class="keyword">this</span>.second = second;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Text <span class="title">getFirst</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> first;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Text <span class="title">getSecond</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> second;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        first.write(out);</div><div class="line">        second.write(out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        first.readFields(in);</div><div class="line">        second.readFields(in);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> first.hashCode() * <span class="number">163</span> + second.hashCode();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Pair) &#123;</div><div class="line">            Pair pair = (Pair) obj;</div><div class="line">            <span class="keyword">return</span> first.equals(pair.first) &amp;&amp; second.equals(pair.second);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.first.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Pair pair)</span> </span>&#123;</div><div class="line">        <span class="comment">// int cmp = first.compareTo(pair.first);</span></div><div class="line">        <span class="keyword">int</span> cmp = pair.first.compareTo(first);</div><div class="line">        <span class="keyword">if</span> (cmp != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> cmp;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// return second.compareTo(pair.second);</span></div><div class="line">        <span class="keyword">return</span> pair.second.compareTo(second);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Pair pair, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (index == <span class="number">1</span>) &#123;</div><div class="line"><span class="comment">//            return this.first.compareTo(pair.first);</span></div><div class="line">            <span class="keyword">return</span> pair.first.compareTo(<span class="keyword">this</span>.first);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="comment">//            return this.second.compareTo(pair.second);</span></div><div class="line">            <span class="keyword">return</span> pair.second.compareTo(<span class="keyword">this</span>.second);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LJoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Pair</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Text key = <span class="keyword">new</span> Text();</div><div class="line">    <span class="keyword">private</span> Text val = <span class="keyword">new</span> Text();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object line, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">        String[] tokens = value.toString().split(<span class="string">","</span>);</div><div class="line">        <span class="keyword">if</span> (tokens.length &lt; <span class="number">3</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// key</span></div><div class="line">        String k = tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">1</span>];</div><div class="line">        </div><div class="line">        Pair pair = <span class="keyword">new</span> Pair(k, <span class="string">"0"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// val</span></div><div class="line"><span class="comment">//        String v = "left" + "," + tokens[2];</span></div><div class="line">         String v = tokens[<span class="number">2</span>];</div><div class="line"><span class="comment">//        key.set(k);</span></div><div class="line">        val.set(v);</div><div class="line"><span class="comment">//        context.write(key, val);</span></div><div class="line">        context.write(pair, val);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RJoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Pair</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">//    private Text key = new Text();</span></div><div class="line">    <span class="keyword">private</span> Text val = <span class="keyword">new</span> Text();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object line, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">        String[] tokens = value.toString().split(<span class="string">","</span>);</div><div class="line">        <span class="keyword">if</span> (tokens.length &lt; <span class="number">5</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// key</span></div><div class="line">        String k = tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">1</span>];</div><div class="line">        </div><div class="line">        Pair pair = <span class="keyword">new</span> Pair(k, <span class="string">"1"</span>);</div><div class="line">        </div><div class="line">        <span class="comment">// val</span></div><div class="line"><span class="comment">//        String v = "right" + "," + tokens[2] + "," + tokens[3] + "," + tokens[4];</span></div><div class="line">      String v = tokens[<span class="number">2</span>] + <span class="string">","</span> + tokens[<span class="number">3</span>] + <span class="string">","</span> + tokens[<span class="number">4</span>];</div><div class="line"><span class="comment">//        key.set(k);</span></div><div class="line">        val.set(v);</div><div class="line"><span class="comment">//        context.write(key, val);</span></div><div class="line">        context.write(pair, val);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Pair</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Text val = <span class="keyword">new</span> Text();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Pair key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line"></div><div class="line">        String deptName = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">boolean</span> set = <span class="keyword">false</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (Text v : values) &#123;</div><div class="line">            </div><div class="line">            String[] vs = v.toString().split(<span class="string">","</span>);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (!set) &#123;</div><div class="line">                deptName = v.toString();</div><div class="line">                set = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                System.out.println(key.toString() + <span class="string">","</span> + deptName + <span class="string">","</span> + v);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOINGroup</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JOINGroup</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Pair.class, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</div><div class="line">        Pair keyA = (Pair) a;</div><div class="line">        Pair keyB = (Pair) b;</div><div class="line"><span class="comment">//        return keyA.compareTo(keyB, 1);</span></div><div class="line">        <span class="keyword">return</span> keyB.compareTo(keyA, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOINPartition</span> <span class="keyword">extends</span> <span class="title">Partitioner</span>&lt;<span class="title">Pair</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(Pair key, Text value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (key.getFirst().hashCode() % numPartitions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOINSort</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JOINSort</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Pair.class, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</div><div class="line">        Pair compositeKey1 = (Pair) a;</div><div class="line">        Pair compositeKey2 = (Pair) b;</div><div class="line">        <span class="keyword">return</span> compositeKey2.compareTo(compositeKey1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dirver</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (args.length != <span class="number">3</span>) &#123;</div><div class="line">            System.out.printf(<span class="string">"Usage: %s [generic options] &lt;input dir&gt; &lt;output dir&gt;\n"</span>, getClass().getSimpleName());</div><div class="line">            ToolRunner.printGenericCommandUsage(System.out);</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">        Job job = Job.getInstance(conf, <span class="string">"join"</span>);</div><div class="line">        job.setJarByClass(getClass());</div><div class="line"></div><div class="line">        MultipleInputs.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]), TextInputFormat.class, LJoinMapper.class);</div><div class="line">        MultipleInputs.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]), TextInputFormat.class, RJoinMapper.class);</div><div class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">2</span>]));</div><div class="line"></div><div class="line">        job.setReducerClass(JoinReducer.class);</div><div class="line">        </div><div class="line">        job.setGroupingComparatorClass(JOINGroup.class);</div><div class="line">        job.setPartitionerClass(JOINPartition.class);</div><div class="line">        job.setSortComparatorClass(JOINSort.class);</div><div class="line">        </div><div class="line">        job.setMapOutputKeyClass(Pair.class);</div><div class="line">        job.setMapOutputValueClass(Text.class);</div><div class="line"></div><div class="line">        job.setOutputKeyClass(NullWritable.class);</div><div class="line">        job.setOutputValueClass(Text.class);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            args = <span class="keyword">new</span> String[] &#123;<span class="string">"in/l"</span>, <span class="string">"in/r"</span>, <span class="string">"ljoinout"</span>&#125;;</div><div class="line">            ToolRunner.run(<span class="keyword">new</span> Configuration(), <span class="keyword">new</span> Dirver(), args);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æµ‹è¯•æ•°æ®:</p>
<p>l.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1,job,beijing</div><div class="line">2,jue,shanghai</div><div class="line">3,role,shenzhen</div><div class="line">4,jie,guangzhou</div></pre></td></tr></table></figure></p>
<p>r.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1,job,30,man,333330000</div><div class="line">2,jue,90,woman,9384832</div><div class="line">3,role,100,man,9103841038</div><div class="line">4,jie,0,man,103848103474</div><div class="line">1,job,20,man,333330000</div><div class="line">1,job,10,man,333330000</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸‹æ˜¯è¾“å‡ºç»“æœï¼š<br><img src="https://github.com/basebase/img_server/blob/master/mapreduce-join/join-01.png?raw=true" alt="join"></p>
<font color="DeepPink" size="2"><br>ä»¥ä¸Šç¨‹åºä½œä¸ºå†…è”å±•ç¤ºç»™äº†å¤§å®¶ï¼Œå¦‚æœå¯¹æ–‡ç« å†…å®¹æœ‰ç–‘é—®ï¼Œæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œåˆæˆ–è€…æœ‰åœŸè±ªæ‰“èµ<br>éƒ½ä¸è¦åå•¬ã€‚è°¢è°¢ï¼<br></font>


<h3 id="è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥"><a href="#è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥" class="headerlink" title="è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥"></a>è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥</h3><p><a href="http://codingjunkie.net/mapreduce-reduce-joins/" target="_blank" rel="external">http://codingjunkie.net/mapreduce-reduce-joins/</a><br><a href="https://www.safaribooksonline.com/library/view/data-algorithms/9781491906170/ch01.html" target="_blank" rel="external">https://www.safaribooksonline.com/library/view/data-algorithms/9781491906170/ch01.html</a><br><a href="https://chamibuddhika.wordpress.com/2012/02/26/joins-with-map-reduce/" target="_blank" rel="external">https://chamibuddhika.wordpress.com/2012/02/26/joins-with-map-reduce/</a></p>
<p>æ–¹ä¾¿åäººï¼Œæ–¹ä¾¿è‡ªå·±ï¼ï¼ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[eclipseé…ç½®è¿è¡ŒHDFS]]></title>
      <url>http://yoursite.com/2017/01/23/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/</url>
      <content type="html"><![CDATA[<p>å‰è¨€<br>é€šå¸¸æˆ‘ä»¬åœ¨è¿è¡ŒHDFSéƒ½æ˜¯ç¼–è¯‘æºç å¹¶é…ç½®Hadoopç¯å¢ƒå˜é‡ï¼Œç„¶åè¿›å…¥sbinç›®å½•ä¸­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">start-dfs.sh</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>é€šå¸¸æˆ‘ä»¬åœ¨è¿è¡ŒHDFSéƒ½æ˜¯ç¼–è¯‘æºç å¹¶é…ç½®Hadoopç¯å¢ƒå˜é‡ï¼Œç„¶åè¿›å…¥sbinç›®å½•ä¸­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">start-dfs.sh</div></pre></td></tr></table></figure></p>
<p>ç”¨æ¥å¯åŠ¨hdfsçš„ï¼Œå¦‚æœæƒ³è¦çœ‹çœ‹NameNodeçš„å¯åŠ¨æ˜¯ä¸æ˜¯éœ€è¦é…ç½®è¿œç¨‹è°ƒè¯•äº†ã€‚ï¼ˆæˆ‘ä»¥å‰å¼„è¿‡ï¼Œä½†æ˜¯ä¹‹å‰æ²¡æœ‰å†™è¿‡åšå®¢ï¼‰ã€‚</p>
<p>å¦‚æœå¯ä»¥åœ¨æœ¬åœ°å°±å¯ä»¥è°ƒè¯•è¿™äº›å†…å®¹æ˜¯ä¸æ˜¯æ›´èƒ½äº†è§£å†…éƒ¨æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>éœ€è¦å‡†å¤‡ä»€ä¹ˆä¸œä¸œå‘¢ï¼Ÿ<br>hadoopæºç ï¼ˆæˆ‘ç”¨çš„æ˜¯2.7.0ï¼Œä½ ä»¬éšæ„ï¼‰<br>IDEAæˆ–è€…eclipseç­‰ç­‰ç”¨æ¥å¯¼å…¥æºç ï¼Œæ–¹ä¾¿é˜…è¯»ã€‚</p>
<p>å‡è®¾ä»¥ä¸Šå†…å®¹å·²ç»é½å…¨ï¼Œç°åœ¨å¼€å§‹è¿›å…¥ä¸»é¢˜ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mvn install -DskipTests</div><div class="line">mvn eclipse:eclipse -DdownloadSources=<span class="literal">true</span> -DdownloadJavadocs=<span class="literal">true</span></div></pre></td></tr></table></figure>
<p>å¯¼å…¥ä¹‹åï¼Œæ‰¾åˆ°hdfsé¡¹ç›®çš„NameNodeå’ŒDataNodeè¿è¡Œå³å¯ã€‚<br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/01.png?raw=true" alt="é¡¹ç›®å›¾"><br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/02.png?raw=true" alt="NN"><br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/03.png?raw=true" alt="DT"></p>
<p>ä½ ä»¥ä¸ºè¿™å°±ç»“æŸäº†ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥è¯´è¯´åœ¨éƒ¨ç½²å’Œå¯åŠ¨é‡åˆ°çš„é—®é¢˜å§ã€‚</p>
<p>1ã€webapps/hdfs not found in CLASSPATH<br>å‡ºç°è¿™ä¸ªå¼‚å¸¸æ˜¯åœ¨å¯åŠ¨NameNodeçš„æ—¶å€™å‡ºç°çš„ï¼Œä¸‹é¢æ˜¯å…·ä½“æŠ›å‡ºå¼‚å¸¸çš„ä»£ç (hadoop-commoné¡¹ç›®httpåŒ…ä¸‹çš„HttpServer2)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getWebAppsPath</span><span class="params">(String appName)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</div><div class="line">   URL url = getClass().getClassLoader().getResource(<span class="string">"webapps/"</span> + appName);</div><div class="line">   <span class="keyword">if</span> (url == <span class="keyword">null</span>)</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"webapps/"</span> + appName</div><div class="line">         + <span class="string">" not found in CLASSPATH"</span>);</div><div class="line">   String urlString = url.toString();</div><div class="line">   <span class="keyword">return</span> urlString.substring(<span class="number">0</span>, urlString.lastIndexOf(<span class="string">'/'</span>));</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘debugçš„æ—¶å€™ï¼Œä»–ä¸€ç›´æ‰¾æˆ‘çš„hadoop-commonçš„jarçš„webappä¸­çš„hdfsç›®å½•ï¼Œæ‰€ä»¥å¯¼è‡´æˆ‘ä¸€ç›´å‡ºç°<br>æ‰¾ä¸åˆ°çš„å¼‚å¸¸ï¼Œåæ¥æˆ‘é‡å†™ä¸€ä¸ªè¯¥ç±»æŒ‡å®šhdfsé¡¹ç›®çš„è·¯å¾„è§£å†³å¯ä»¥è¿è¡Œï¼ˆå¦‚æœè¿˜æœ‰å…¶ä»–çš„è§£å†³æ–¹æ¡ˆè¯·åœ¨è¯„è®ºä¸‹æ–¹è¯´æ˜ä¸€ä¸‹ï¼Œä¸‡åˆ†æ„Ÿè°¢!ï¼‰, è¿˜æœ‰ä¸ªdatanodeç›®å½•æ²¡æœ‰æ‰¾åˆ°çš„å¼‚å¸¸æ˜¯åœ¨è¿è¡ŒDataNodeå‡ºç°çš„<br>å…·ä½“å‡ºç°çš„ä½ç½®æˆ‘ç»™å¿˜è®°äº†ï¼ŒğŸ˜ğŸ˜ğŸ˜ğŸ˜</p>
<p>2ã€Exception in thread â€œmainâ€ java.lang.IllegalArgumentException: Invalid URI for NameNode address (check fs.defaultFS): file:/// has no authority.</p>
<p>å‡ºç°æ­¤å¼‚å¸¸é¦–å…ˆå»stackoverflowæ‰¾äº†ä¸‹ç­”æ¡ˆï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://10.100.20.168/<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯å¯¹æˆ‘æ˜¯æ— æ•ˆçš„ï¼Œåæ¥çŸ¥é“åŸå› æˆ‘ä½¿ç”¨çš„æ˜¯core-default.xmlçš„é…ç½®æ²¡æœ‰ç”Ÿæ•ˆã€‚<br>ä½†æ˜¯ä¸€å¼€å§‹æˆ‘å°±æ˜¯defualtçš„é…ç½®ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚ã€‚ã€‚ï¼ˆå¥‡æ€ªçš„é—®é¢˜ï¼‰</p>
<p>å¦‚ä¸‹ä»£ç æ˜¯æŠ›å‡ºå¼‚å¸¸çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InetSocketAddress <span class="title">getAddress</span><span class="params">(URI filesystemURI)</span> </span>&#123;</div><div class="line">    String authority = filesystemURI.getAuthority();</div><div class="line">    <span class="keyword">if</span> (authority == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</div><div class="line">          <span class="string">"Invalid URI for NameNode address (check %s): %s has no authority."</span>,</div><div class="line">          FileSystem.FS_DEFAULT_NAME_KEY, filesystemURI.toString()));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!HdfsConstants.HDFS_URI_SCHEME.equalsIgnoreCase(</div><div class="line">        filesystemURI.getScheme())) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</div><div class="line">          <span class="string">"Invalid URI for NameNode address (check %s): %s is not of scheme '%s'."</span>,</div><div class="line">          FileSystem.FS_DEFAULT_NAME_KEY, filesystemURI.toString(),</div><div class="line">          HdfsConstants.HDFS_URI_SCHEME));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> getAddress(authority);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è‡³äºä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œåœ¨FileSystemç±»ä¸­æœ‰è¿™ä¹ˆä¸€æ®µ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FS_DEFAULT_NAME_KEY = </div><div class="line">                   CommonConfigurationKeys.FS_DEFAULT_NAME_KEY;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_FS = </div><div class="line">                   CommonConfigurationKeys.FS_DEFAULT_NAME_DEFAULT;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">    // CommonConfigura.java</div><div class="line">    public static final String  FS_DEFAULT_NAME_KEY = "fs.defaultFS";</div><div class="line">    public static final String  FS_DEFAULT_NAME_DEFAULT = "file:///";</div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URI <span class="title">getDefaultUri</span><span class="params">(Configuration conf)</span> </span>&#123;</div><div class="line">    <span class="comment">// è¿™é‡Œå°±æ˜¯åˆ›å»ºURIå¯¹è±¡, å„ä½å¯ä»¥å•ç‹¬å†™ä¸ªTestæ¥çœ‹çœ‹åˆ›å»ºçš„å¯¹è±¡æ•°æ®ã€‚</span></div><div class="line">    <span class="comment">// URI uri = new URI("file:///");</span></div><div class="line">    <span class="keyword">return</span> URI.create(fixName(conf.get(FS_DEFAULT_NAME_KEY, DEFAULT_FS)));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼Œæˆ‘è¿™é‡Œå°±æŠŠæˆ‘é‡åˆ°çš„é—®é¢˜å…¨éƒ¨è¯´å®Œäº†ã€‚</p>
<p>æœ€åï¼Œåœ¨ç»™å¤§å®¶æ¼”ç¤ºä¸€ä¸‹ï¼Œæˆ‘è¿è¡Œhadoop fs -put localPath hdfsPathæ˜¯å¦‚ä½•æ–­ç‚¹çš„ã€‚<br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/04.png?raw=true" alt="put"><br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/05.png?raw=true" alt="put-d"></p>
<h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><p><a href="https://wiki.apache.org/hadoop/EclipseEnvironment" target="_blank" rel="external">https://wiki.apache.org/hadoop/EclipseEnvironment</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaè‡ªæ—‹é”]]></title>
      <url>http://yoursite.com/2016/11/14/java%E8%87%AA%E6%97%8B%E9%94%81/</url>
      <content type="html"><![CDATA[<p>æ­¤æ–‡ç« ä¸æ¶‰åŠä¸äº’æ–¥é”ç­‰æ¯”æ¯”è¾ƒï¼Œåªæ˜¯å•çº¯çš„ä»‹ç»ä¸€ä¸ªè‡ªæ—‹é”ï¼Œå¦‚æœæƒ³è¦äº†è§£æ›´å¤šå¯ä»¥ç‚¹å‡»å‚è€ƒé“¾æ¥<br><a id="more"></a></p>
<h3 id="ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­"><a href="#ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­" class="headerlink" title="ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­"></a>ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­</h3><p>è‡ªæ—‹é”çš„ä»‹ç»åŸç†ç­‰è¿‡ç¨‹æˆ‘å°±ä¸åœ¨æ­¤ä»‹ç»äº†ï¼Œä¸‹é¢çš„å‚è€ƒå·²ç»å†™çš„éå¸¸ä¸é”™äº†ï¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/***</span></div><div class="line"> * è‡ªæ—‹é”</div><div class="line"> * <span class="doctag">@author</span> Joker</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinLock</span> </span>&#123;</div><div class="line">	</div><div class="line">	AtomicReference&lt;Thread&gt; owner = <span class="keyword">new</span> AtomicReference&lt;Thread&gt;();</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> count ;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">		Thread currentThread = Thread.currentThread();</div><div class="line">		System.out.println(<span class="string">"lock() -&gt; "</span> + currentThread.getName());</div><div class="line">		<span class="keyword">if</span> (currentThread == owner.get()) &#123;</div><div class="line">			count++; <span class="comment">// è·å–é”çš„æ¬¡æ•°</span></div><div class="line">			<span class="keyword">return</span> ;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="comment">// å½“çº¿ç¨‹è¶Šæ¥è¶Šå¤šç”±äºwhileå¾ªç¯ä¼šæµªè´¹cpuæ—¶é—´ç‰‡ï¼ŒcompareAndSetéœ€è¦å¤šæ¬¡å¯¹åŒä¸€å†…å­˜è¿›è¡Œè®¿é—®</span></div><div class="line">		<span class="keyword">while</span> (!owner.compareAndSet(<span class="keyword">null</span>, currentThread)) &#123;</div><div class="line">			</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span> </span>&#123;</div><div class="line">		Thread currentThread = Thread.currentThread();</div><div class="line">		System.out.println(<span class="string">"unLock() -&gt; "</span> + currentThread.getName());</div><div class="line">		<span class="keyword">if</span> (currentThread == owner.get()) &#123;</div><div class="line">			<span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">				count--;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				owner.compareAndSet(currentThread, <span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinLockTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> sum ;</div><div class="line">	<span class="keyword">private</span> SpinLock lock;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SpinLockTest</span><span class="params">(SpinLock lock)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.lock = lock;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.lock.lock();</div><div class="line">		<span class="keyword">this</span>.lock.lock();</div><div class="line">		System.out.println(<span class="string">"å½“å‰çº¿ç¨‹ "</span> + Thread.currentThread().getName() + <span class="string">" start..."</span>);</div><div class="line">		sum++;</div><div class="line">		System.out.println(<span class="string">"å½“å‰çº¿ç¨‹ "</span> + Thread.currentThread().getName() + <span class="string">" end..."</span>);</div><div class="line">		</div><div class="line">		<span class="keyword">this</span>.lock.unLock();</div><div class="line">		<span class="keyword">this</span>.lock.unLock();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		SpinLock lock = <span class="keyword">new</span> SpinLock();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">			SpinLockTest lockTest = <span class="keyword">new</span> SpinLockTest(lock);</div><div class="line">			Thread t = <span class="keyword">new</span> Thread(lockTest, <span class="string">"thread-lock-"</span>+i);</div><div class="line">			t.start();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Thread.sleep(<span class="number">1000</span>);</div><div class="line">		System.out.println(sum);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åé™„ä¸Šä¸€å¼ æˆ‘è‡ªå·±ç”»çš„ä¸€å¼ è¿è¡Œå›¾</p>
<p><img src="https://github.com/basebase/img_server/blob/master/java%E8%87%AA%E6%97%8B%E9%94%81/java%E8%87%AA%E6%97%8B%E9%94%81.png?raw=true" alt="javaè‡ªæ—‹é”"></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.cnblogs.com/cposture/p/SpinLock.html#_label0" target="_blank" rel="external">http://www.cnblogs.com/cposture/p/SpinLock.html#_label0</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaè¿”å›å¼•ç”¨å’Œè¿”å›å¯¹è±¡]]></title>
      <url>http://yoursite.com/2016/09/06/java%E8%BF%94%E5%9B%9E%E5%BC%95%E7%94%A8%E5%92%8C%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?<br>åœ¨å†™java finalizeæ–‡ç« çš„æ—¶æˆ‘è¯´è¿‡ï¼Œæœ‰ä¸€ä¸ªåŒäº‹é—®äº†ä¸€ä¸ªé—®é¢˜ã€‚ä»Šå¤©è¿™ç¯‡æ–‡ç« å°±æ˜¯è®°å½•æ­¤é—®é¢˜ã€‚<br>é‚£ä¹ˆç©¶ç«Ÿæ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<a id="more"></a>
<h3 id="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« "><a href="#ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« " class="headerlink" title="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?"></a>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?</h3><p>åœ¨å†™java finalizeæ–‡ç« çš„æ—¶æˆ‘è¯´è¿‡ï¼Œæœ‰ä¸€ä¸ªåŒäº‹é—®äº†ä¸€ä¸ªé—®é¢˜ã€‚ä»Šå¤©è¿™ç¯‡æ–‡ç« å°±æ˜¯è®°å½•æ­¤é—®é¢˜ã€‚<br>é‚£ä¹ˆç©¶ç«Ÿæ˜¯ä»€ä¹ˆé—®é¢˜å‘¢ï¼Ÿ</p>
<h3 id="é—®é¢˜çš„äº§ç”Ÿ"><a href="#é—®é¢˜çš„äº§ç”Ÿ" class="headerlink" title="é—®é¢˜çš„äº§ç”Ÿ"></a>é—®é¢˜çš„äº§ç”Ÿ</h3><p>äº‹æƒ…å‘ç”Ÿåœ¨ä¸­åˆï¼Œå½“æ—¶æˆ‘æ­£åœ¨å†™codeï¼Œç„¶åè®¨è®ºç»„é‡Œé¢å‘å‡ºä¸€ä¸ªé—®é¢˜è¯´</p>
<font color="DeepPink"><br>    javaæ–¹æ³•ä¸­ç›´æ¥newå¯¹è±¡è¿”å›å’Œèµ‹å€¼è¿”å›æœ‰ä»€ä¹ˆåŒºåˆ«å•Šï¼Ÿ<br></font>

<p>ç„¶è€Œï¼Œå°±æœ‰ä¸€ä½åŒäº‹è¯´å‡ºäº†gcï¼Œç„¶åå°±æ²¡ç„¶åäº†ï¼<br>åŒ…æ‹¬æˆ‘å½“æ—¶ä¹Ÿåªæ˜¯è¯´åˆ°å¯¹è±¡æ²¡æœ‰è¢«å¼•ç”¨å°±è¢«å›æ”¶ï¼ˆå…¶å®è¿™é‡Œè¯´çš„ä¹Ÿè¿˜æ˜¯æœ‰é—®é¢˜ï¼Œåªèƒ½è¯´ä¼šè¢«åŠ å…¥åˆ°F-Queueä¸­ï¼Œç„¶åç­‰å¾…å¤„ç†ï¼‰ã€‚</p>
<p>å› ä¸ºGCåˆ°åº•ä»€ä¹ˆæ—¶å€™æ‰§è¡Œæˆ‘ä¹ˆæ˜¯ä¸æ¸…æ¥šçš„ï¼Œä¸åŒçš„jvmæœ‰ä¸åŒçš„ç®—æ³•ã€‚</p>
<p>æˆ‘æœ¬ç€ä¸€é¢—æœç´¢çš„å¿ƒï¼Œå‘ç°æœ‰äººè¯´javaçš„newè¿”å›çš„æ˜¯ä¸€ä¸ªä¸´æ—¶å¯¹è±¡ï¼Œç„¶åæˆ‘å°±å„ç§æœç´¢ä¸´æ—¶å¯¹è±¡çš„èµ„æ–™<br>æ— æœï¼Œå…¨éƒ¨éƒ½æ˜¯C/C++çš„æè¿°ï¼Œç”±äºæˆ‘æ²¡æœ‰æ¥è§¦C/C++æ‰€ä»¥çœ‹çš„ä¹Ÿæœ‰ç‚¹äº‘é‡Œé›¾é‡Œ!</p>
<p>åæ¥ç»è¿‡å¤§ç‰›çš„æŒ‡ç‚¹ï¼Œå¦‚ä¸‹ï¼š</p>
<font color="DeepPink"><br>    å…¶å®javaæ²¡æœ‰ä¸´æ—¶çš„æ¦‚å¿µï¼Œä¸åƒcæœ‰æ ˆç©ºé—´ä¸Šçš„å¯¹è±¡ã€‚Javaå¯¹è±¡éƒ½æ˜¯å †ä¸Šçš„ï¼Œé€šè¿‡å¼•ç”¨æ“ä½œå¯¹è±¡<br></font><br>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯ä¸€ç›®äº†ç„¶äº†ğŸ˜<br><br>å½“çº¿ç¨‹æ‰§è¡Œä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œå°±ä¼šéšä¹‹åˆ›å»ºä¸€ä¸ªå¯¹åº”çš„æ ˆå¸§ï¼Œå¹¶å°†å»ºç«‹çš„æ ˆå¸§å‹æ ˆã€‚å½“æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä¾¿ä¼šå°†æ ˆå¸§å‡ºæ ˆã€‚æˆ‘ä»¬çŸ¥é“å±€éƒ¨å˜é‡éƒ½æ˜¯æ”¾åœ¨æ ˆä¸­çš„ã€‚<br><br>æ¥ï¼Œçœ‹çœ‹ä¸‹å›¾<br><br><img src="https://github.com/basebase/img_server/blob/master/java%E8%BF%94%E5%9B%9E%E5%BC%95%E7%94%A8%E5%92%8C%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/11111.png?raw=true" alt="jvm stack"><br><br>é‚£ä¹ˆå½“æ–¹æ³•è¿”å›ç»“æŸäº†ï¼Œè¿™ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯æ²¡æœ‰è¢«å¼•ç”¨äº†ï¼Œä¹Ÿå°±åŠ å…¥åˆ°F-Queueä¸­ç­‰å¾…å¤„ç†äº†ã€‚<br>è€Œåœ¨returnç›´æ¥newè¿”å›ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚<br><br>è¯´åˆ°è¿™é‡Œï¼Œæˆ‘ä¹ˆåŸºæœ¬ä¸Šå¯ä»¥è®¤ä¸ºäºŒè€…æ²¡æœ‰åŒºåˆ«ï¼Œå¦‚æœæœ‰ä¹Ÿæ˜¯å¾®ä¹å…¶å¾®çš„äº†ã€‚<br><br>### å®è·µ<br><br><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title">getDate</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">new</span> Date();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		System.out.println(<span class="string">"1"</span>);</div><div class="line">		Date date = getDate();</div><div class="line">		<span class="comment">//System.gc();</span></div><div class="line">		Thread.sleep(<span class="number">10000</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure><br><br>ä¸‹å›¾æ˜¯æ²¡æœ‰è¿›è¡Œgcæ—¶å€™è¿è¡Œæƒ…å†µã€‚<br><img src="https://github.com/basebase/img_server/blob/master/java%E8%BF%94%E5%9B%9E%E5%BC%95%E7%94%A8%E5%92%8C%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/usedmem.png?raw=true" alt="jvm stack"><br><br>ä¸Šå›¾ç¨‹åºæˆ‘è¿è¡Œäº†å¥½å‡ æ¬¡ï¼Œä½†æ˜¯å¤§éƒ¨åˆ†ä½¿ç”¨æƒ…å†µéƒ½å¦‚ä¸Šï¼Œä½ ä¹ˆåœ¨è¿è¡Œçš„æ—¶å€™å¯ä»¥å¤šæµ‹è¯•çœ‹çœ‹ã€‚<br><br>ç„¶åæŠŠSystem.gc()çš„æ³¨é‡Šè§£å¼€ï¼Œåœ¨æ¥è§‚å¯Ÿä¸€ä¸‹ã€‚<br><br>è¿è¡Œæƒ…å†µè‰¯å¥½çš„ä¸€æ¬¡ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="https://github.com/basebase/img_server/blob/master/java%E8%BF%94%E5%9B%9E%E5%BC%95%E7%94%A8%E5%92%8C%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/gc1.png?raw=true" alt="jvm gc"><br><br>å¯ä»¥çœ‹åˆ°å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œgcç¡®å®æ‰§è¡Œäº†ã€‚<br><br>ç„¶è€Œï¼Œæˆ‘ä»¬åœ¨çœ‹çœ‹è¿è¡ŒNæ¬¡åçš„æƒ…å†µï¼Œä¸ºäº†ä¸‹å›¾æˆ‘ä¹Ÿæ˜¯æ¶ˆè€—äº†ä¸€äº›æ—¶é—´ï¼ï¼ï¼<br><img src="https://github.com/basebase/img_server/blob/master/java%E8%BF%94%E5%9B%9E%E5%BC%95%E7%94%A8%E5%92%8C%E8%BF%94%E5%9B%9E%E5%AF%B9%E8%B1%A1/gc2.png?raw=true" alt="jvm gc2"><br><br>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å†…å­˜ä½¿ç”¨æƒ…å†µï¼Œæ˜¯ä¸æ˜¯è¿˜å¾ˆé«˜ï¼Œè¿™å°±è¯´æ˜äº†<br><font color="DeepPink"><br>    è°ƒç”¨javaçš„System.gc()ä¸ä¸€å®šä¼šæ‰§è¡ŒGCæ“ä½œ<br></font>

<p>å¥½äº†ï¼Œåˆ°è¿™é‡Œå°±å·²ç»ç»“æŸäº†ï¼Œè¿™é‡Œæˆ‘å†™çš„æ˜¯return newçš„è¿”å›ï¼Œè¿”å›å¼•ç”¨æ²¡æœ‰å·®åˆ«ï¼Œå½“ç„¶ä½ ä¹ˆè‡ªå·±<br>ä¹Ÿå¯ä»¥æµ‹è¯•ä¸€ä¸‹ğŸ˜</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å…¶å®ä¹Ÿä¸ç®—æ˜¯æ€»ç»“å§ï¼Œä¹Ÿæ˜¯ä»Šå¤©çœ‹åˆ°çš„ï¼Œåœ¨ç¼–å†™ç¨‹åºçš„æ—¶å€™å°½é‡ä½¿ç”¨å±€éƒ¨å˜é‡ï¼Œè¿™æ ·å¯ä»¥æœ‰æ•ˆçš„<br>æ§åˆ¶å†…å­˜ï¼Œåœ¨æ–¹æ³•ç»“æŸçš„æ—¶å€™ï¼Œæ ˆä¸­çš„æ•°æ®ä¼šè‡ªåŠ¨é‡Šæ”¾è€Œä¸ç”¨æˆ‘ä»¬æ“å¿ƒäº†ï¼ï¼ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java finalizeæ–¹æ³•]]></title>
      <url>http://yoursite.com/2016/08/27/java-finalize%E6%96%B9%E6%B3%95/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?<br>è¦è¯´finalizeæ–¹æ³•æˆ‘æƒ³åšjavaçš„éƒ½çŸ¥é“ï¼Œé‚£ä¹ˆfinalizeæ–¹æ³•ä¼šä¸ä¼šæ‰§è¡Œï¼Œå¦‚æœä¼šä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿå¦‚æœé‡å†™finalizeæ–¹æ³•åˆæœ‰ä»€ä¹ˆä¸¥é‡çš„åæœ? </p>
<a id="more"></a>
<h3 id="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« "><a href="#ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« " class="headerlink" title="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?"></a>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?</h3><p>è¦è¯´finalizeæ–¹æ³•æˆ‘æƒ³åšjavaçš„éƒ½çŸ¥é“ï¼Œé‚£ä¹ˆfinalizeæ–¹æ³•ä¼šä¸ä¼šæ‰§è¡Œï¼Œå¦‚æœä¼šä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿå¦‚æœé‡å†™finalizeæ–¹æ³•åˆæœ‰ä»€ä¹ˆä¸¥é‡çš„åæœ? </p>
<p>é¢˜å¤–è¯ï¼šä»¥å‰çœ‹Java GCç›¸å…³å†…å®¹ä¸»è¦ä¸ºçš„æ˜¯åº”ä»˜é¢è¯•è€Œå·²ï¼Œä¸è¿‡æœ€è¿‘æœ‰ä¸ªåŒäº‹æäº†ä¸ªé—®é¢˜(é—®é¢˜ä½ ä¹ˆå…ˆYY)ï¼Œä½†ä»–åªè¯´äº†å¯¹è±¡ä¼šè¢«å›æ”¶ï¼Œå…·ä½“ç»†èŠ‚å¹¶æ²¡æœ‰è¯´å‡ºï¼Œè¿›è€Œå¼•å‘æˆ‘å†æ¬¡æ¢ç©¶GC<br>ä¼°è®¡ä¸‹æ¬¡ä¼šä»¥æ­¤é—®é¢˜å±•å¼€è®¨è®ºï¼Œç”±äºæˆ‘ä¹Ÿæ˜¯ä¸ªèœé¸Ÿéœ€è¦å¤§å®¶æŒ‡å‡ºæ–‡ç« ä¸­çš„ä¸è¶³ï¼Œè°¢è°¢ï¼</p>
<h3 id="Java-finalizeæ–¹æ³•"><a href="#Java-finalizeæ–¹æ³•" class="headerlink" title="Java finalizeæ–¹æ³•"></a>Java finalizeæ–¹æ³•</h3><p>finalizeæ–¹æ³•æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œä»»ä½•ç±»éƒ½æ˜¯é‡å†™finalizeæ–¹æ³•ï¼Œå®ç°è‡ªå·±æƒ³è¦çš„åŠŸèƒ½ã€‚<br>é»˜è®¤çš„finalizeæ–¹æ³•ä»€ä¹ˆä¹Ÿæ²¡åš</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123; &#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä¸€èˆ¬éƒ½ä¸å»ºè®®è‡ªå·±é‡å†™finalizeæ–¹æ³•ï¼Œç”±äºåœ¨æ¸…ç†å¯¹è±¡æ—¶å€™æ— æ³•ä¿è¯finalizeæ–¹æ³•ä¸€å®šä¼šè¢«æ‰§è¡Œã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€æ®µå°ç¨‹åºéå¸¸çš„ç®€å•ï¼Œå°±æ˜¯æ‰“å°ä¸€å¥è¯ï¼Œç„¶åç¨‹åºå°±ç»“æŸäº†ã€‚<br>é‚£ä¹ˆï¼Œå¯¹è±¡ä¼šè¢«å›æ”¶å—ï¼Ÿ</p>
<p>ä»€ä¹ˆæ—¶å€™æ‰§è¡ŒGCæˆ‘ä¹ˆæ˜¯ä¸æ¸…æ¥šçš„ï¼Œæ ¹æ®ä¸åŒçš„ç®—æ³•æœ‰ä¸åŒçš„è°ƒåº¦ï¼Œæœ‰çš„æ˜¯æ ¹æ®æ—¶é—´è°ƒåº¦ï¼Œæœ‰çš„æ˜¯æ ¹æ®<br>å†…å­˜ä½¿ç”¨çš„æƒ…å†µè¿›è¡Œè°ƒåº¦ã€‚</p>
<p>ä¸è¿‡è®©æˆ‘æ¥åšçš„è¯ï¼Œæˆ‘æ›´å€¾å‘äºåè€…ï¼Œä¸ç®¡è¿è¡Œå¤šé•¿æ—¶é—´åªè¦å†…å­˜æ²¡åˆ°æˆ‘æŒ‡å®šçš„é˜ˆå€¼å¤§å°æˆ‘å°±ä¸æ‰§è¡Œï¼Œ<br>ç°åœ¨çš„è¿™ä¸ªæƒ³æ³•æ¥æºhadoopçš„spillï¼Œå‡è®¾æœ‰100mçš„å†…å­˜ä½¿ç”¨ä½†æ˜¯åªè¦è¾¾åˆ°ä¸Šé™80mçš„å†…å­˜ç”¨é‡ï¼Œ<br>é‚£ä¹ˆæˆ‘å°±å¼€å§‹æ‰§è¡ŒGCã€‚ã€åªæ˜¯æˆ‘çš„æƒ³æ³•ï¼Œå“ˆå“ˆ~ã€‘</p>
<p>é‚£å¥½ï¼Œæ— è®ºæ˜¯æ ¹æ®æ—¶é—´åˆæˆ–è€…æ˜¯å†…å­˜å¤§å°è¿›è¡ŒGCï¼Œä½†æ˜¯æˆ‘ä¹ˆå°±ä¸€æ®µè¾“å‡ºä»£ç ï¼Œç¨‹åºç»“æŸäº†ä¼°è®¡ä¹Ÿä¸ä¼š<br>æ‰§è¡ŒGCçº¿ç¨‹è¿›è¡Œæ¸…ç†å§ï¼</p>
<p>æ²¡æœ‰æ‰§è¡ŒGCä¹Ÿå°±æ˜¯æ— æ³•æ‰§è¡Œåˆ°finalizeæ–¹æ³•äº†ã€‚</p>
<p>é‚£ä¹ˆï¼Œæœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥æ‰§è¡Œgcå‘¢ï¼Ÿæ–¹æ³•æ˜¯æœ‰çš„ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½ä¿è¯ä¸€å®šä¼šæ‰§è¡Œgcï¼Œåªèƒ½è¯´ä¼šå‚¬ä¿ƒè¿›è€Œæ‰§è¡Œ<br>GCã€‚</p>
<p>è¿™ä¹Ÿå°±æ˜¯æˆ‘ä¹ˆå¸¸è¯´çš„<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.gc()</div></pre></td></tr></table></figure></p>
<p>å½“ç„¶è¿˜å­˜åœ¨å…¶å®ƒæ–¹æ³•ï¼Œåœ¨æœ€åæˆ‘ä¼šå°†æˆ‘å‚è€ƒé“¾æ¥å‘å‡ºã€‚<br>é‚£ä¹ˆï¼Œä»€ä¹ˆæ ·çš„å¯¹è±¡ä¼šè¢«æ‰§è¡Œfinalizeæ–¹æ³•å‘¢ï¼Ÿfinalizeæ–¹æ³•åˆä¼šè¢«æ‰§è¡Œå¤šå°‘æ¬¡å‘¢ï¼Ÿ</p>
<h3 id="å¯¹è±¡é”€æ¯è¿‡ç¨‹"><a href="#å¯¹è±¡é”€æ¯è¿‡ç¨‹" class="headerlink" title="å¯¹è±¡é”€æ¯è¿‡ç¨‹"></a>å¯¹è±¡é”€æ¯è¿‡ç¨‹</h3><p>å¯¹è±¡çš„é”€æ¯è¿‡ç¨‹ä¸­ï¼ŒæŒ‰ç…§å¯¹è±¡çš„finalizeæ‰§è¡Œæƒ…å†µï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼Œç³»ç»Ÿä¼šè®°å½•å¯¹è±¡çš„<br>å¯¹åº”çŠ¶æ€ã€‚</p>
<p>1ã€unfinalized æ²¡æœ‰æ‰§è¡Œfinalizeï¼Œç³»ç»Ÿä¹Ÿä¸å‡†å¤‡æ‰§è¡Œã€‚<br>2ã€finalizable å¯ä»¥æ‰§è¡Œfinalizeäº†ï¼Œç³»ç»Ÿä¼šåœ¨éšåçš„æŸä¸ªæ—¶é—´æ‰§è¡Œfinalizeã€‚<br>3ã€finalizedè¯¥å¯¹è±¡çš„finalizeå·²ç»è¢«æ‰§è¡Œäº†ã€‚ </p>
<p>GCæ€ä¹ˆæ¥ä¿æŒå¯¹finalizableçš„å¯¹è±¡çš„è¿½è¸ªå‘¢ã€‚GCæœ‰ä¸€ä¸ªQueueï¼Œ<br>å«åšF-Queueï¼Œæ‰€æœ‰å¯¹è±¡åœ¨å˜ä¸ºfinalizableçš„æ—¶å€™ä¼šåŠ å…¥åˆ°è¯¥Queueï¼Œç„¶åç­‰å¾…GCæ‰§è¡Œå®ƒçš„<br>finalizeæ–¹æ³•ã€‚</p>
<p>è¿™æ—¶æˆ‘ä»¬å¼•å…¥äº†å¯¹å¯¹è±¡çš„å¦å¤–ä¸€ç§è®°å½•åˆ†ç±»ï¼Œç³»ç»Ÿå¯ä»¥æ£€æŸ¥åˆ°ä¸€ä¸ªå¯¹è±¡å±äºå“ªä¸€ç§ã€‚</p>
<p>a.reachableï¼šæ´»åŠ¨çš„å¯¹è±¡å¼•ç”¨é“¾å¯ä»¥åˆ°è¾¾çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬æ‰€æœ‰çº¿ç¨‹å½“å‰æ ˆçš„å±€éƒ¨å˜é‡ï¼Œ<br>æ‰€æœ‰çš„é™æ€å˜é‡ç­‰ç­‰ã€‚ </p>
<p>b.finalizer-reachableé™¤äº†reachableå¤–ï¼Œä»F-Queueå¯ä»¥é€šè¿‡å¼•ç”¨åˆ°è¾¾çš„å¯¹è±¡ã€‚<br>c.unreachableå…¶å®ƒçš„å¯¹è±¡</p>
<p><img src="https://github.com/basebase/img_server/blob/master/java-finalize%E6%96%B9%E6%B3%95/gc.gif?raw=true" alt="è½¬æ¢è¿‡ç¨‹"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">1.é¦–å…ˆï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ä»Reachable+Unfinalizedèµ°å‘æ­»äº¡ä¹‹è·¯çš„ã€‚</div><div class="line"></div><div class="line">2.å½“å‰æ´»åŠ¨å¯¹è±¡ä¸å¯è¾¾æ—¶ï¼Œå¯¹è±¡å¯ä»¥ä»ReachableçŠ¶æ€å˜åˆ°F-Reachableæˆ–è€…UnreachableçŠ¶æ€ã€‚</div><div class="line"></div><div class="line">3.å½“å¯¹è±¡ä¸ºéReachable+Unfinalizedæ—¶ï¼ŒGCä¼šæŠŠå®ƒç§»å…¥F-Queueï¼Œ</div><div class="line">  çŠ¶æ€å˜ä¸ºF-Reachable+Finalizableã€‚</div><div class="line"></div><div class="line">4.å¥½äº†ï¼Œå…³é”®çš„æ¥äº†ï¼Œä»»ä½•æ—¶å€™ï¼ŒGCéƒ½å¯ä»¥ä»F-Queueä¸­æ‹¿åˆ°ä¸€ä¸ªFinalizableçš„å¯¹è±¡ï¼Œ</div><div class="line">  æ ‡è®°å®ƒä¸ºFinalizedï¼Œç„¶åæ‰§è¡Œå®ƒçš„finalizeæ–¹æ³•ï¼Œç”±äºè¯¥å¯¹è±¡åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­åˆå¯è¾¾äº†ï¼Œ</div><div class="line">  äºæ˜¯è¯¥å¯¹è±¡å˜æˆReachableäº†ï¼ˆå¹¶ä¸”Finalizedï¼‰ã€‚è€Œfinalizeæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œåˆæœ‰å¯èƒ½æŠŠå…¶å®ƒçš„F-Reachableçš„å¯¹è±¡å˜ä¸ºä¸€ä¸ªReachableçš„ï¼Œè¿™ä¸ªå«åšå¯¹è±¡å†ç”Ÿã€‚</div><div class="line"></div><div class="line">5.å½“ä¸€ä¸ªå¯¹è±¡åœ¨Unreachable+Unfinalizedæ—¶ï¼Œå¦‚æœè¯¥å¯¹è±¡ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„Objectçš„finalizeï¼Œ</div><div class="line">  æˆ–è€…è™½ç„¶é‡å†™äº†ï¼Œä½†æ˜¯æ–°çš„å®ç°ä»€ä¹ˆä¹Ÿä¸å¹²ã€‚ä¸ºäº†æ€§èƒ½ï¼ŒGCå¯ä»¥æŠŠè¯¥å¯¹è±¡ç›´æ¥å˜åˆ°ReclaimedçŠ¶æ€ç›´æ¥é”€æ¯ï¼Œè€Œä¸ç”¨åŠ å…¥åˆ°F-Queueç­‰å¾…GCåšè¿›ä¸€æ­¥å¤„ç†ã€‚</div><div class="line"></div><div class="line">6.ä»çŠ¶æ€å›¾çœ‹å‡ºï¼Œä¸ç®¡æ€ä¹ˆæŠ˜è…¾ï¼Œä»»æ„ä¸€ä¸ªå¯¹è±¡çš„finalizeåªè‡³å¤šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸€æ—¦å¯¹è±¡å˜ä¸ºFinalized</div><div class="line">  å°±æ€ä¹ˆä¹Ÿä¸ä¼šåœ¨å›åˆ°F-Queueå»äº†ã€‚å½“ç„¶æ²¡æœ‰æœºä¼šå†æ‰§è¡Œfinalizeäº†ã€‚ </div><div class="line"></div><div class="line">7.å½“å¯¹è±¡å¤„äºUnreachable+Finalizedæ—¶ï¼Œè¯¥å¯¹è±¡ç¦»çœŸæ­£çš„æ­»äº¡ä¸è¿œäº†ã€‚GCå¯ä»¥å®‰å…¨çš„å›æ”¶è¯¥å¯¹è±¡çš„</div><div class="line">  å†…å­˜äº†ã€‚è¿›å…¥Reclaimedã€‚</div></pre></td></tr></table></figure>
<h3 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test1</span> </span>&#123;</div><div class="line">	Test2 t2 ;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Test1</span><span class="params">(Test2 t2)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.t2 = t2;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Test1 finalize..."</span>);</div><div class="line">		Test3.t1 = <span class="keyword">this</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</div><div class="line">	String name;</div><div class="line">	<span class="keyword">int</span> age;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Test2</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Test2 finalize..."</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">"is "</span> + age;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test3</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> Test1 t1;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		</div><div class="line">		Test1 t1 = <span class="keyword">new</span> Test1(<span class="keyword">new</span> Test2(<span class="string">"joker"</span>, <span class="number">18</span>));</div><div class="line">		System.out.println(t1);</div><div class="line">		t1 = <span class="keyword">null</span>;</div><div class="line">		</div><div class="line">		System.gc();</div><div class="line">		Thread.sleep(<span class="number">10000</span>);</div><div class="line">		System.out.println(Test3.t1);</div><div class="line">		System.out.println(Test3.t1.t2);</div><div class="line">		</div><div class="line">		t1 = <span class="keyword">null</span>;</div><div class="line">		System.gc();</div><div class="line">		System.out.println(<span class="string">"done."</span>);</div><div class="line">		</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºå¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cn.base.gc.test.Test1@6b04d3c8</div><div class="line">[GC 2642K-&gt;437K(251392K), 0.0012310 secs]</div><div class="line">[Full GC 437K-&gt;350K(251392K), 0.0102620 secs]</div><div class="line">Test1 finalize...</div><div class="line">Test2 finalize...</div><div class="line">cn.base.gc.test.Test1@6b04d3c8</div><div class="line">jokeris 18</div><div class="line">[GC 2992K-&gt;446K(251392K), 0.0006800 secs]</div><div class="line">[Full GC 446K-&gt;350K(251392K), 0.0069980 secs]</div><div class="line">done.</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯æˆ‘ä»¬åœ¨é‡Šæ”¾test1çš„æ—¶å€™æˆå‘˜å¯¹è±¡test2ä¹Ÿä¸€èµ·è¢«å›æ”¶äº†ï¼Œç”±äºtest1é‡å†™äº†finalize<br>æ–¹æ³•ï¼Œåœ¨æœ€åtest1åˆå¤æ´»äº†ã€‚</p>
<p>ç”±äºåœ¨GC Rootä¸­åˆæœ‰å¼•ç”¨é“¾èµ·æ­»å›ç”Ÿï¼Œä½†æ˜¯æˆ‘ä¹ˆå†ä¸€æ¬¡è®¾ç½®nullå¹¶æ‰§è¡Œgcå¯ä»¥çœ‹åˆ°test1å¯¹è±¡<br>æ²¡æœ‰åœ¨è¿›å…¥finalizeæ–¹æ³•äº†ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>finalizeæ–¹æ³•ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œçš„ï¼Œä½¿ç”¨System.gc()<br>ä¹Ÿåªä¸è¿‡æ˜¯åŠ å¿«gcè°ƒç”¨ï¼Œå¹¶ä¸”é‡å†™finalizeæ–¹æ³•æœ€å¥½ä¸è¦ä½¿å¯¹è±¡å†ç”Ÿï¼Œè¿™æ ·å®¹æ˜“é€ æˆ<br>å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ··ä¹±ï¼</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://mazhuang.org/2015/12/15/java-object-finalize/" target="_blank" rel="external">http://mazhuang.org/2015/12/15/java-object-finalize/</a><br><a href="http://bijian1013.iteye.com/blog/2289661" target="_blank" rel="external">http://bijian1013.iteye.com/blog/2289661</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mapreduceè®¡ç®—uv]]></title>
      <url>http://yoursite.com/2016/08/23/mapreduce%E8%AE%A1%E7%AE%97uv/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶?<br>æˆ‘ä»¬åœ¨ç»Ÿè®¡çš„æ—¶å€™pvå’Œuvå¯ä»¥è¯´çš„æœ€åŸºç¡€çš„ä¹Ÿæ˜¯æœ€å¸¸è§çš„ï¼Œç›¸ä¿¡åšæ•°æ®çš„éƒ½çŸ¥é“ã€‚è¿™ç§éœ€æ±‚<br>æˆ‘ä»¬ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨hiveè¿›è¡Œç»Ÿè®¡å°±å®Œäº‹äº†ï¼Œéå¸¸çš„ç®€å•ã€‚<br>æ ¹æ®urlè®¡ç®—æ¯ä¸ªé¡µé¢çš„è®¿é—®æ¬¡æ•°å’Œç‹¬ç«‹è®¿å®¢ç”¨æˆ·æ•°ã€‚</p>
<a id="more"></a>
<h3 id="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶"><a href="#ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶" class="headerlink" title="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶?"></a>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶?</h3><p>æˆ‘ä»¬åœ¨ç»Ÿè®¡çš„æ—¶å€™pvå’Œuvå¯ä»¥è¯´çš„æœ€åŸºç¡€çš„ä¹Ÿæ˜¯æœ€å¸¸è§çš„ï¼Œç›¸ä¿¡åšæ•°æ®çš„éƒ½çŸ¥é“ã€‚è¿™ç§éœ€æ±‚<br>æˆ‘ä»¬ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨hiveè¿›è¡Œç»Ÿè®¡å°±å®Œäº‹äº†ï¼Œéå¸¸çš„ç®€å•ã€‚<br>æ ¹æ®urlè®¡ç®—æ¯ä¸ªé¡µé¢çš„è®¿é—®æ¬¡æ•°å’Œç‹¬ç«‹è®¿å®¢ç”¨æˆ·æ•°ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(gi) <span class="keyword">as</span> <span class="string">'pv'</span>, <span class="keyword">count</span>(<span class="keyword">distinct</span> gi) <span class="keyword">as</span> <span class="string">'uv'</span> <span class="keyword">from</span> </div><div class="line"><span class="keyword">table</span> <span class="keyword">where</span> cdate = <span class="string">'2016-06-01'</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">url</span></div></pre></td></tr></table></figure>
<p>é‚£å¥½ï¼Œæˆ‘ä»¬é€šè¿‡mapreduceå¦‚ä½•è®¡ç®—å‘¢?<br>æˆ‘æƒ³æˆ‘å¤§å¤šæ•°äººéƒ½æ˜¯é€šè¿‡åœ¨reduceä¸­ä½¿ç”¨Setæˆ–è€…Listè¿›è¡Œåˆ¤æ–­æ˜¯å¦åœ¨é›†åˆä¸­å­˜åœ¨ï¼Œ<br>å¦‚æœä¸å­˜åœ¨é‚£ä¹ˆå°±åŠ 1ã€‚<br>äº‹å®å´æ˜¯å¦‚æ­¤ï¼Œæˆ‘æœç´¢å‘ç°å¾ˆå¤šblogéƒ½æ˜¯æ­¤æ–¹æ³•å¹¶ä¸”å†…å®¹å¤§è‡´ç›¸åŒï¼ŒåŒ…æ‹¬æˆ‘æœ€å¼€å§‹å†™çš„mapreduceä¹Ÿæ˜¯<br>æŒ‰ç…§è¿™ç§æ–¹æ³•åšçš„ã€‚</p>
<p>ä½†æ˜¯ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•åšæ•°æ®é‡å°çœ‹ä¸å‡ºé—®é¢˜ï¼Œä½†æ˜¯æ•°æ®é‡ä¸€æ—¦éå¸¸å¤§å°±é©¬ä¸Šå‡ºç°é—®é¢˜ã€‚<br>å› ä¸ºä½ çš„æ•°æ®æ”¾åœ¨äº†å†…å­˜ï¼Œå¾ˆå®¹æ˜“å°±oomäº†ã€‚</p>
<p>å…¶å®æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸¤ä¸ªmapreduceè¿›è¡Œè®¡ç®—ã€‚<br>ç¬¬ä¸€ä¸ªmapå°±æ˜¯åˆ†å‰²url+uidä½œä¸ºkeyï¼Œvalueä¸º1<br>æ•°æ®æ ¼å¼å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://www.google.com,zhangsan 1</div><div class="line">http://www.google.com,zhangsan 1</div><div class="line">http://www.google.com,zhangsan 1</div></pre></td></tr></table></figure>
<p>ç›¸åŒçš„keyå€¼å‘é€åˆ°åŒä¸€ä¸ªreduceä¸­ï¼Œè¿™æ ·çš„è¯zhangsançš„æ•°æ®éƒ½ä¸º1äº†ï¼Œreduceä¸ç”¨åšä»€ä¹ˆå°±æ˜¯<br>æŠŠkeyå†™å…¥å°±è¡Œã€‚</p>
<p>ç„¶ååˆ°äº†ç¬¬äºŒä¸ªmapä¸­ï¼Œæˆ‘ä»¬å°†ç¬¬ä¸€ä¸ªreduceçš„æ•°æ®è¿›è¡Œæ‹†è§£å°±å¾—åˆ°äº†urlå’Œuidçš„æ•°æ®äº†<br>ç”±äºåœ¨ç¬¬ä¸€ä¸ªmrä¸­å·²ç»å°†ç›¸åŒçš„uidå’Œurlå½’ä¸ºä¸€ç±»ï¼Œæ‰€ä»¥ä¸ä¼šå­˜åœ¨é‡å¤æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œå°±å’Œ<br>wordcountä¸€æ ·è®¡ç®—å°±è¡Œäº†ã€‚</p>
<h3 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h3><p>ä¸Šé¢å·²ç»è¯´äº†è¿™ä¹ˆå¤šäº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆä¹å‘³äº†ã€‚æ¥çœ‹çœ‹ä»£ç é†’é†’è„‘å§ï¼Œå˜¿å˜¿å˜¿~</p>
<p>ä½¿ç”¨hadoop2.7.0</p>
<p>æµ‹è¯•æ•°æ®:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">http://www.google.com,2016-01-02,dsadasd-dasd-as-das</div><div class="line">https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/,2016-01-02,000-111-11-22</div><div class="line">http://www.jd.com/?keyword=dadas&amp;keywordid=34879410794&amp;re_dcp=202m0QjIIg==&amp;traffic_source=1004&amp;test=1&amp;enc=utf8&amp;cu=true&amp;utm_source=baidu-search&amp;utm_medium=cpc&amp;utm_campaign=t_262767352_baidusearch&amp;utm_term=34879410794_0_b0d37d1995654fdb9c013c4eb7544071,2016-01-02,dasdsa-ds-ad-as-da</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsddddd-dsss</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://item.jd.com/3148810.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://item.jd.com/3148810.html,2016-01-02,d99dsa-dsdasdasda-sadas</div><div class="line">http://item.jd.com/3148762.html,2016-01-02,d99dsa-dsdasdsa-xxxx</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Text k = <span class="keyword">new</span> Text();</div><div class="line">	<span class="keyword">private</span> LongWritable v = <span class="keyword">new</span> LongWritable(<span class="number">1</span>);</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">		</div><div class="line">		String line = value.toString();</div><div class="line">		String[] tokens = line.split(<span class="string">","</span>);</div><div class="line">		</div><div class="line">		<span class="comment">// url + uid</span></div><div class="line">		k.set(tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">2</span>]);</div><div class="line">		context.write(k, v);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;LongWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">		context.write(key, NullWritable.get());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVMapperUp</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Text k = <span class="keyword">new</span> Text();</div><div class="line">	<span class="keyword">private</span> LongWritable v = <span class="keyword">new</span> LongWritable(<span class="number">1</span>);</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">		</div><div class="line">		String line = value.toString();</div><div class="line">		String[] tokens = line.split(<span class="string">","</span>);</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (tokens.length != <span class="number">2</span>) &#123;</div><div class="line">			<span class="keyword">return</span> ;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		String url = tokens[<span class="number">0</span>];</div><div class="line">		</div><div class="line">		k.set(url);</div><div class="line">		context.write(k, v);</div><div class="line">		</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVReducerUp</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> LongWritable res = <span class="keyword">new</span> LongWritable();</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;LongWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">		<span class="keyword">long</span> sum = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (LongWritable val : values) &#123;</div><div class="line">			sum += val.get();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		res.set(sum);</div><div class="line">		</div><div class="line">		context.write(key, res);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configured;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVApp</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			</div><div class="line">			args = <span class="keyword">new</span> String[]&#123;<span class="string">"in/browse.txt"</span>, <span class="string">"uv_out"</span>, <span class="string">"f_uv_out"</span>&#125;;</div><div class="line">			ToolRunner.run(<span class="keyword">new</span> Configuration(), <span class="keyword">new</span> UVApp(), args);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		</div><div class="line">		</div><div class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">		Job job1 = Job.getInstance(conf, <span class="string">"uv"</span>);</div><div class="line">		Job job2 = Job.getInstance(conf, <span class="string">"uv"</span>);</div><div class="line">		</div><div class="line">		job1.setJarByClass(UVApp.class);</div><div class="line">		job2.setJarByClass(UVApp.class);</div><div class="line">		</div><div class="line">		job1.setMapperClass(UVMapper.class);</div><div class="line">		job1.setReducerClass(UVReducer.class);</div><div class="line">		</div><div class="line">		job2.setMapperClass(UVMapperUp.class);</div><div class="line">		job2.setReducerClass(UVReducerUp.class);</div><div class="line">		</div><div class="line">		job1.setMapOutputKeyClass(Text.class);</div><div class="line">		job1.setMapOutputValueClass(LongWritable.class);</div><div class="line">		</div><div class="line">		job2.setMapOutputKeyClass(Text.class);</div><div class="line">		job2.setOutputValueClass(LongWritable.class);</div><div class="line">		</div><div class="line">		job1.setOutputKeyClass(Text.class);</div><div class="line">		job1.setOutputValueClass(NullWritable.class);</div><div class="line">		</div><div class="line">		job2.setOutputKeyClass(Text.class);</div><div class="line">		job2.setOutputValueClass(LongWritable.class);</div><div class="line">		</div><div class="line">		FileInputFormat.addInputPath(job1, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</div><div class="line">		FileOutputFormat.setOutputPath(job1, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line">		</div><div class="line">		FileInputFormat.addInputPath(job2, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line">		FileOutputFormat.setOutputPath(job2, <span class="keyword">new</span> Path(args[<span class="number">2</span>]));</div><div class="line">		</div><div class="line">		<span class="keyword">int</span> code = job1.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span>(code != <span class="number">0</span>)&#123;</div><div class="line">			System.exit(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">return</span> job2.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p> ä¸€èˆ¬ä½¿ç”¨åˆ†å¸ƒå¼æ¡†æ¶è¡¨ç¤ºæˆ‘ä»¬æ•°æ®æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ”¾å†…å­˜è‚¯å®šæ˜¯ä¸åˆç†çš„ã€‚<br> çœ‹æ¥ä»£ç è´¨é‡æœ‰å¾…æé«˜ï¼ï¼ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[stormæ•´åˆkafkaé‡å¤æ¶ˆè´¹é—®é¢˜åˆ†æ]]></title>
      <url>http://yoursite.com/2016/08/11/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?<br>æœ€è¿‘åœ¨æ•´åˆstorm+kafkaä¸€ç›´çº ç»“äºé‡å¤æ•°æ®çš„è¯»å–ï¼Œé‡æ–°å¯åŠ¨topologyæ›´æ˜¯æŠŠkafkaçš„æ•°æ®æ‰«æä¸€éï¼Œ<br>ã€å¦‚æœçº¿ä¸Šé€»è¾‘è¾ƒé‡ï¼Œå¹¶ä¸”è¿˜è¦å¾€æ•°æ®åº“é‡Œé¢æ’å…¥æ•°æ®æ˜¯ä¸æ˜¯æœ‰å¾ˆå¤šé‡å¤æ•°æ®äº†ï¼ã€‘</p>
<a id="more"></a>
<h3 id="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« "><a href="#ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« " class="headerlink" title="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?"></a>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?</h3><p>æœ€è¿‘åœ¨æ•´åˆstorm+kafkaä¸€ç›´çº ç»“äºé‡å¤æ•°æ®çš„è¯»å–ï¼Œé‡æ–°å¯åŠ¨topologyæ›´æ˜¯æŠŠkafkaçš„æ•°æ®æ‰«æä¸€éï¼Œ<br>ã€å¦‚æœçº¿ä¸Šé€»è¾‘è¾ƒé‡ï¼Œå¹¶ä¸”è¿˜è¦å¾€æ•°æ®åº“é‡Œé¢æ’å…¥æ•°æ®æ˜¯ä¸æ˜¯æœ‰å¾ˆå¤šé‡å¤æ•°æ®äº†ï¼ã€‘</p>
<h3 id="è½¯ä»¶ç¯å¢ƒ"><a href="#è½¯ä»¶ç¯å¢ƒ" class="headerlink" title="è½¯ä»¶ç¯å¢ƒ"></a>è½¯ä»¶ç¯å¢ƒ</h3><p>zookeeper-3.4.6.tar.gz<br>kafka_2.9.2-0.8.1.1<br>apache-storm-1.0.1.tar.gz</p>
<h3 id="å®è·µå‡ºçœŸçŸ¥"><a href="#å®è·µå‡ºçœŸçŸ¥" class="headerlink" title="å®è·µå‡ºçœŸçŸ¥"></a>å®è·µå‡ºçœŸçŸ¥</h3><p>é‚£æˆ‘ä»¬çŸ¥é“è¿™kafkaå’Œstorméƒ½æ˜¯ä¾èµ–zkçš„ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨åˆ›å»ºtopologyçš„æ—¶å€™ä¹Ÿæ˜¯æŠŠoffsetå†™å…¥åˆ°zk<br>ä½†æ˜¯ä¸€å¼€å§‹çš„ç¨‹åºæ˜¯éå¸¸å¥‡æ€ªçš„ï¼Œzkå¹¶æ²¡æœ‰åˆ›å»ºæˆ‘æ‰€æŒ‡å®šçš„ç›®å½•å’Œidã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸ªâ€é”™è¯¯â€çš„ä¾‹å­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> cn.base.sk.ex03;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1380001209433177193L</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> OutputCollector collector = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map stormConf, TopologyContext context, OutputCollector collector)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.collector = collector;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input)</span> </span>&#123;</div><div class="line">		String word = input.getString(<span class="number">0</span>);</div><div class="line">		System.out.println(<span class="string">"source data =&gt; "</span> + word);</div><div class="line">		<span class="comment">//collector.ack(input);</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.base.sk.ex03;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.storm.Config;</div><div class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.BrokerHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.KafkaSpout;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.SpoutConfig;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.StringScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.ZkHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.spout.SchemeAsMultiScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</div><div class="line"></div><div class="line"><span class="keyword">import</span> cn.base.sk.ex02.MyKafkaTopology;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaTopology</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		String zks = <span class="string">"localhost:2181/kafka"</span>;</div><div class="line">		String topic = <span class="string">"topic2"</span>;</div><div class="line">		String zkRoot = <span class="string">"/topic2"</span>;</div><div class="line">		String id = <span class="string">"split"</span>;</div><div class="line"></div><div class="line">		BrokerHosts brokerHosts = <span class="keyword">new</span> ZkHosts(zks);</div><div class="line">		SpoutConfig spoutConf = <span class="keyword">new</span> SpoutConfig(brokerHosts, topic, zkRoot, id);</div><div class="line">		spoutConf.scheme = <span class="keyword">new</span> SchemeAsMultiScheme(<span class="keyword">new</span> StringScheme());</div><div class="line">		spoutConf.zkServers = Arrays.asList(<span class="keyword">new</span> String[] &#123;<span class="string">"localhost"</span>&#125;);</div><div class="line">		spoutConf.zkPort = <span class="number">2181</span>;</div><div class="line"></div><div class="line"></div><div class="line">		TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">		builder.setSpout(<span class="string">"kafka-spoutx"</span>, <span class="keyword">new</span> KafkaSpout(spoutConf));</div><div class="line">		builder.setBolt(<span class="string">"word-splitx"</span>, <span class="keyword">new</span> SplitBolt()).shuffleGrouping(<span class="string">"kafka-spoutx"</span>);</div><div class="line"></div><div class="line">		Config conf = <span class="keyword">new</span> Config();</div><div class="line">		String name = MyKafkaTopology.class.getSimpleName();</div><div class="line">		conf.setMaxTaskParallelism(<span class="number">3</span>);</div><div class="line"></div><div class="line">		LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</div><div class="line">		cluster.submitTopology(name, conf, builder.createTopology());</div><div class="line"></div><div class="line"><span class="comment">//		Utils.sleep(10000);</span></div><div class="line"><span class="comment">//		cluster.shutdown();</span></div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯æ— æ³•åœ¨zkä¸­åˆ›å»º/topic2/splitçš„ï¼Œè‡³äºä¸ºä»€ä¹ˆæˆ‘åœ¨åé¢ä¼šè¯´æ˜ã€‚<br>ç”±äºä¹Ÿæ˜¯æœ€è¿‘å‡ å¤©æ‰å¼€å§‹æ’¸èµ·æ¥çš„æ‰€ä»¥æˆ‘å°±å„ç§æœç´¢ï¼Œåœ¨ä¸€ä¸ªblogä¸­æ‰¾åˆ°äº†è¯´æ˜</p>
<p><font color="DeepPink" size="2">åŸæ–‡<br>    æ­¤å¤„éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¦ä½¿ç”¨backtype.storm.topology.base.BaseBasicBoltå¯¹è±¡ä½œä¸ºçˆ¶ç±»ï¼Œå¦åˆ™ä¸ä¼šåœ¨zkè®°å½•åç§»é‡offsetæ•°æ®ã€‚<br></font><br>åæ¥æˆ‘ä¿®æ”¹boltç»§æ‰¿è¯¥ç±»ç¡®å®åœ¨zkä¸­åˆ›å»ºå‡ºäº†topicï¼Œä½†æ˜¯è‡³äºä¸ºä»€ä¹ˆå¹¶æ²¡æœ‰è¯¦ç»†è¯´æ˜ã€‚<br>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¿®æ”¹åçš„codeã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> cn.base.sk.ex02;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</div><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.BasicOutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseBasicBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaWordSplitter</span> <span class="keyword">extends</span> <span class="title">BaseBasicBolt</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Log logger = LogFactory.getLog(KafkaWordSplitter.class);</div><div class="line">	<span class="keyword">private</span> OutputCollector collector;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input, BasicOutputCollector collector)</span> </span>&#123;</div><div class="line">		String line = input.getString(<span class="number">0</span>);</div><div class="line">		System.out.println(<span class="string">"RECV[kafka -&gt; splitter] "</span> + line);</div><div class="line"></div><div class="line">		String[] words = line.split(<span class="string">","</span>);</div><div class="line">		<span class="keyword">for</span> (String word : words) &#123;</div><div class="line">			System.out.println(<span class="string">"EMIT[splitter -&gt; counter] "</span> + word);</div><div class="line">			collector.emit(<span class="keyword">new</span> Values(word, <span class="number">1</span>));</div><div class="line">		&#125;</div><div class="line"></div><div class="line"><span class="comment">//		collector.ack(input);</span></div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">		declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>, <span class="string">"count"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.base.sk.ex02;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Map.Entry;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.BasicOutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseBasicBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCounter</span> <span class="keyword">extends</span> <span class="title">BaseBasicBolt</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Log logger = LogFactory.getLog(WordCounter.class);</div><div class="line">	<span class="keyword">private</span> OutputCollector collector;</div><div class="line">	<span class="keyword">private</span> Map&lt;String, AtomicInteger&gt; countMap;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map stormConf, TopologyContext context)</span> </span>&#123;</div><div class="line">		countMap = <span class="keyword">new</span> HashMap&lt;String, AtomicInteger&gt;();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"The final result:"</span>);</div><div class="line">		Iterator&lt;Entry&lt;String, AtomicInteger&gt;&gt; iter = <span class="keyword">this</span>.countMap.entrySet().iterator();</div><div class="line">		<span class="keyword">while</span> (iter.hasNext()) &#123;</div><div class="line"></div><div class="line">			Entry&lt;String, AtomicInteger&gt; entry = iter.next();</div><div class="line">			System.out.println(entry.getKey() + <span class="string">"\t:\t"</span> + entry.getValue().get());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input, BasicOutputCollector collector)</span> </span>&#123;</div><div class="line">		String word = input.getString(<span class="number">0</span>);</div><div class="line">		Integer count = input.getInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"RECV[splitter -&gt; counter] "</span> + word + <span class="string">" : "</span> + count);</div><div class="line">		AtomicInteger ai = <span class="keyword">this</span>.countMap.get(word);</div><div class="line">		<span class="keyword">if</span> (ai == <span class="keyword">null</span>) &#123;</div><div class="line">			ai = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">			<span class="keyword">this</span>.countMap.put(word, ai);</div><div class="line">		&#125;<span class="keyword">else</span> &#123;</div><div class="line">			ai.addAndGet(count);</div><div class="line"><span class="comment">//			collector.ack(input);</span></div><div class="line">			System.out.println(<span class="string">"CHECK statistics map: "</span> + <span class="keyword">this</span>.countMap);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.base.sk.ex02;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.utils.Utils;</div><div class="line"><span class="keyword">import</span> org.apache.storm.Config;</div><div class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.BrokerHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.KafkaSpout;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.SpoutConfig;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.StringScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.ZkHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.spout.SchemeAsMultiScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</div><div class="line"></div><div class="line"><span class="keyword">import</span> scala.actors.threadpool.Arrays;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyKafkaTopology</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		String zks = <span class="string">"localhost:2181/kafka"</span>;</div><div class="line">		String topic = <span class="string">"topic1"</span>;</div><div class="line">		String zkRoot = <span class="string">"/topic1"</span>;</div><div class="line">		String id = <span class="string">"word"</span>;</div><div class="line"></div><div class="line">		BrokerHosts brokerHosts = <span class="keyword">new</span> ZkHosts(zks);</div><div class="line">		SpoutConfig spoutConf = <span class="keyword">new</span> SpoutConfig(brokerHosts, topic, zkRoot, id);</div><div class="line">		spoutConf.scheme = <span class="keyword">new</span> SchemeAsMultiScheme(<span class="keyword">new</span> StringScheme());</div><div class="line">		spoutConf.zkServers = Arrays.asList(<span class="keyword">new</span> String[] &#123;<span class="string">"localhost"</span>&#125;);</div><div class="line">		spoutConf.zkPort = <span class="number">2181</span>;</div><div class="line"></div><div class="line"></div><div class="line">		TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">		builder.setSpout(<span class="string">"kafka-spout"</span>, <span class="keyword">new</span> KafkaSpout(spoutConf));</div><div class="line">		builder.setBolt(<span class="string">"word-split"</span>, <span class="keyword">new</span> KafkaWordSplitter()).shuffleGrouping(<span class="string">"kafka-spout"</span>);</div><div class="line">		builder.setBolt(<span class="string">"word-count"</span>, <span class="keyword">new</span> WordCounter()).fieldsGrouping(<span class="string">"word-split"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div><div class="line"></div><div class="line">		Config conf = <span class="keyword">new</span> Config();</div><div class="line">		String name = MyKafkaTopology.class.getSimpleName();</div><div class="line">		conf.setMaxTaskParallelism(<span class="number">3</span>);</div><div class="line"></div><div class="line">		LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</div><div class="line">		cluster.submitTopology(name, conf, builder.createTopology());</div><div class="line"></div><div class="line"><span class="comment">//		Utils.sleep(10000);</span></div><div class="line"><span class="comment">//		cluster.shutdown();</span></div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŸè°…æˆ‘å†™äº†ä¸¤ä¸ªä¾‹å­å§!<br>å¥½çš„ï¼Œä¸Šé¢ä¸€å¤§æ®µä»£ç æ˜¯ä¿®æ”¹è¿‡çš„ã€‚æ­¤æ—¶è¿›å…¥zkcliå·²ç»åˆ›å»ºå‡ºæ¥äº†æˆ‘ä»¬æ‰€éœ€çš„è·¯å¾„<br>å¹¶ä¸”å·²ç»è®°å½•äº†offset</p>
<p><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/01.png?raw=true" alt="zkæ•°æ®"></p>
<p>è¯»å–æ•°æ®çš„æ—¶å€™å°±ä»è¿™é‡Œå¼€å§‹äº†ã€‚<br>é‚£å¥½ï¼Œä¸ºå•¥ç»§æ‰¿äº†BaseBasicBoltç±»å°±å¯ä»¥ï¼Œè€ŒBaseRichBoltç±»å°±ä¸è¡Œå‘¢ã€‚</p>
<h3 id="èµ°è¿›æºç "><a href="#èµ°è¿›æºç " class="headerlink" title="èµ°è¿›æºç "></a>èµ°è¿›æºç </h3><p>é¦–å…ˆçœ‹çœ‹KafkaSpoutç±»çš„openæ–¹æ³•åšäº†ä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ<br>ä¸‹å›¾æ‰æ˜¯æˆ‘ä¹ˆè¦çœ‹çš„</p>
<p><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/02.png?raw=true" alt="kafkaSpout!nextTuple"></p>
<p>ä¸ç”¨åœ¨æ„å…¶å®ƒæ–¹æ³•ï¼Œç›´æ¥è¿›å…¥commit()æ–¹æ³•<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/03.png?raw=true" alt="kafkaSpout!commit"></p>
<p>çœ‹åˆ°æ²¡ï¼Œ åªè¦ifæˆç«‹å°±ä¼šåœ¨zkä¸­åˆ›å»ºæ•°æ®ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½è¿›å…¥å‘¢ï¼Œæ¥çœ‹çœ‹lastCompletedOffset<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/04.png?raw=true" alt="kafkaSpout!lastCompletedOffset"></p>
<p>å½“ä½ debugåˆ°è¿™é‡Œçš„æ—¶å€™é¦–å…ˆè·å–çš„æ˜¯ç¬¬ä¸€ä¸ªkeyï¼Œè¿™ä¸ªmapçš„keyæ˜¯offsetï¼Œvalueæ˜¯timestamp<br>è¯»ä¸€æ¬¡ä¼šå’Œä¸Šä¸€æ¬¡è¿›è¡Œæ¯”è¾ƒï¼Œæœ€ç»ˆåœ¨é‡Œé¢é‡æ–°èµ‹å€¼æœ€æ–°çš„offsetã€‚</p>
<p>ä»”ç»†è§‚å¯Ÿï¼Œå¦‚æœç»§æ‰¿BaseRichSpoutç±»ï¼Œè°ƒç”¨è¿‡åmapçš„keyä¾æ—§å­˜åœ¨ï¼Œè€ŒBaseBasicBoltä¼šè¿›è¡Œåˆ é™¤ï¼Œå¦‚æœä¸åˆ é™¤çš„è¯ä¼šåœ¨commitåˆ¤æ–­æ—¶å€™ä¸€ç›´ç›¸ç­‰ã€‚</p>
<p>é‚£ä¹ˆï¼Œæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¿›è¡Œåˆ é™¤çš„å‘¢ï¼Ÿå¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šæƒ³åœ¨ä»€ä¹ˆæ—¶å€™æŠŠè¿™ä»½æ•°æ®è¿›è¡Œåˆ é™¤ï¼Ÿ<br>å¯¹çš„ï¼Œå½“æˆ‘ä»¬ç¡®è®¤å®Œæ¯•è¿™æ¡æ•°æ®è¢«æ¶ˆè´¹åï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆ é™¤äº†ã€‚</p>
<p>åœ¨è¿›è¡Œackä¹‹åï¼Œæˆ‘ä»¬çœ‹åˆ°åˆ é™¤mapçš„æ•°æ®ï¼Œè¿™æ ·å°±é¡ºåˆ©çš„åœ¨zké‡Œé¢åˆ›å»ºå¹¶å†™å…¥æ•°æ®ã€‚<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/05.png?raw=true" alt="kafkaSpout!ack"></p>
<p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘å°±æƒ³ç»§æ‰¿è‡ªBaseRichBoltç±»ï¼Œé‚£æœ‰åŠæ³•å®ç°å—ï¼Ÿè‚¯å®šçš„ï¼Œä½ åªéœ€è¦è‡ªå·±ackä¸€ä¸‹å°±è¡Œäº†<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/06.png?raw=true" alt="UserBolt!ack"></p>
<p>okï¼Œæ­¤æ—¶ä½ åœ¨æ¬¡æ‰“å¼€zkcliæŸ¥çœ‹å°±å­˜åœ¨æŒ‡å®šçš„ç›®å½•å’Œidï¼Œå¹¶ä¸”é‡å¯topologyä¹Ÿä¸ä¼šé‡æ–°è¯»å–å†å²ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>BaseBasicBoltæ²¡æœ‰æä¾›ackè€Œæ˜¯éšç¤ºè¿›è¡Œäº†è°ƒç”¨ï¼Œè€ŒBaseRichSpoutéœ€è¦æ˜¾ç¤ºè°ƒç”¨ã€‚</p>
<h3 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h3><p>å‚è€ƒï¼š<a href="http://www.howardliu.cn/a-few-notes-about-storm/" target="_blank" rel="external">http://www.howardliu.cn/a-few-notes-about-storm/</a></p>
]]></content>
    </entry>
    
  
  
</search>
