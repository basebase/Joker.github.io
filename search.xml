<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[Hadoop NameNodeå¯åŠ¨ä¹‹FSDirectiry]]></title>
      <url>http://yoursite.com/2017/12/19/Hadoop-NameNode%E5%90%AF%E5%8A%A8%E4%B9%8BFSDirectiry/</url>
      <content type="html"><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>ä½œä¸ºHadoop NameNodeç±»å¯åŠ¨åˆ†æç¯‡çš„èµ·å§‹ç¯‡ç« ã€‚<br>æˆ‘ä»¬å…ˆæ¥äº†è§£ä¸€ä¸‹FSDirectiryåšäº†å“ªäº›åŠŸèƒ½ç‚¹ã€‚</p>
<p>ä¸€åˆ‡éƒ½å› ä¸‹é¢è¿™æ®µä»£ç å¼€å§‹(ä¸€åˆ‡çš„æ˜¯å‘½è¿ä¹‹é—¨çš„é€‰æ‹©, æ»‘ç¨½)</p>
<a id="more"></a>
<h3 id="è¿›å…¥ä¸»é¢˜"><a href="#è¿›å…¥ä¸»é¢˜" class="headerlink" title="è¿›å…¥ä¸»é¢˜"></a>è¿›å…¥ä¸»é¢˜</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹NameNodeçš„æ„é€ æ–¹æ³•å§ã€‚<br>å¯ä»¥å‘ç°ä¼šåˆ›å»ºä¸€ä¸ªFSNamesystemå¯¹è±¡ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">     * Create a NameNode at the default location</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NameNode</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">this</span>(getDir(conf), <span class="comment">// è·å–namenodeå­˜æ”¾è·¯å¾„æ–‡ä»¶å¤¹</span></div><div class="line">             DataNode.createSocketAddr <span class="comment">// è·å–datanodeç«¯å£ä¿¡æ¯</span></div><div class="line">             (conf.get(<span class="string">"fs.default.name"</span>, <span class="string">"local"</span>)).getPort(), conf);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Create a NameNode at the specified location and start it.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NameNode</span><span class="params">(File dir, <span class="keyword">int</span> port, Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.namesystem = <span class="keyword">new</span> FSNamesystem(dir, conf);</div><div class="line">        <span class="keyword">this</span>.handlerCount = conf.getInt(<span class="string">"dfs.namenode.handler.count"</span>, <span class="number">10</span>); <span class="comment">// NameNodeç”¨æ¥å¤„ç†æ¥è‡ªDataNodeçš„RPCè¯·æ±‚çš„çº¿ç¨‹æ•°é‡ </span></div><div class="line">        <span class="keyword">this</span>.server = RPC.getServer(<span class="keyword">this</span>, port, handlerCount, <span class="keyword">false</span>, conf);</div><div class="line">        <span class="keyword">this</span>.server.start();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ä¹‹åæˆ‘ä»¬è¿›å…¥FSNamesystemè§‚å¯Ÿ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FSNamesystem</span><span class="params">(File dir, Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="keyword">this</span>.dir = <span class="keyword">new</span> FSDirectory(dir); <span class="comment">// fsimgå’Œeditsçš„åˆå§‹åŒ–</span></div><div class="line">        <span class="keyword">this</span>.hbthread = <span class="keyword">new</span> Daemon(<span class="keyword">new</span> HeartbeatMonitor()); <span class="comment">// å¿ƒè·³ç›‘æ§</span></div><div class="line">        <span class="keyword">this</span>.lmthread = <span class="keyword">new</span> Daemon(<span class="keyword">new</span> LeaseMonitor()); <span class="comment">// ç§Ÿçº¦ç›‘æ§</span></div><div class="line">        hbthread.start(); <span class="comment">// å¯åŠ¨å¿ƒè·³çº¿ç¨‹</span></div><div class="line">        lmthread.start(); <span class="comment">// å¯åŠ¨ç§Ÿçº¦ç›‘æ§çº¿ç¨‹</span></div><div class="line">        <span class="keyword">this</span>.systemStart = System.currentTimeMillis();</div><div class="line">        <span class="keyword">this</span>.conf = conf;</div><div class="line">        </div><div class="line">        <span class="keyword">this</span>.desiredReplication = conf.getInt(<span class="string">"dfs.replication"</span>, <span class="number">3</span>); <span class="comment">// å¤‡ä»½æ•°ä¸º3</span></div><div class="line">        <span class="keyword">this</span>.maxReplication = desiredReplication;</div><div class="line">        <span class="keyword">this</span>.maxReplicationStreams = conf.getInt(<span class="string">"dfs.max-repl-streams"</span>, <span class="number">2</span>);</div><div class="line">        <span class="keyword">this</span>.minReplication = <span class="number">1</span>; <span class="comment">// æœ€å°å¤‡ä»½æ•°é‡</span></div><div class="line">        <span class="keyword">this</span>.heartBeatRecheck= <span class="number">1000</span>; <span class="comment">// 1ç§’å‘é€ä¸€æ¬¡å¿ƒè·³</span></div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬åªå…³æ³¨FSDirectoryç±»åšäº†å“ªäº›åŠŸèƒ½å³å¯ã€‚<br>ä¸ºäº†è§‚å¯Ÿæ–¹ä¾¿, æˆ‘æŠŠéœ€è¦ç ”ç©¶çš„ä»£ç æŠ½ç¦»å‡ºæ¥äº†ï¼Œå¹¶ä¸”å†™æˆä¸€ä¸ªæµ‹è¯•ç±»æ–¹ä¾¿è¿›è¡Œæµ‹è¯•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FSDirectory</span><span class="params">(File dir)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        <span class="comment">// configurationä¸­é…ç½®nameçš„dirè·¯å¾„</span></div><div class="line">        File fullimage = <span class="keyword">new</span> File(dir, <span class="string">"image"</span>);</div><div class="line">        <span class="comment">// å¦‚æœä¸å­˜åœ¨åˆ™è¡¨ç¤ºæ²¡æœ‰å¯¹NameNodeè¿›è¡Œè¿‡åˆå§‹åŒ–</span></div><div class="line">        <span class="keyword">if</span> (! fullimage.exists()) &#123;</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"NameNode not formatted: "</span> + dir);</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">// editsæ–‡ä»¶</span></div><div class="line">        File edits = <span class="keyword">new</span> File(dir, <span class="string">"edits"</span>);</div><div class="line">        <span class="comment">// åŠ è½½å’Œä¿å­˜</span></div><div class="line">        <span class="keyword">if</span> (loadFSImage(fullimage, edits)) &#123;</div><div class="line">            saveFSImage(fullimage, edits);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">this</span>.ready = <span class="keyword">true</span>;</div><div class="line">            <span class="keyword">this</span>.notifyAll();</div><div class="line">            <span class="keyword">this</span>.editlog = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> FileOutputStream(edits));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FSDirectorTest</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">INode</span> </span>&#123;</div><div class="line">        <span class="keyword">public</span> String name;</div><div class="line">        <span class="keyword">public</span> INode parent;</div><div class="line">        <span class="keyword">public</span> TreeMap children = <span class="keyword">new</span> TreeMap();</div><div class="line">        <span class="keyword">public</span> Block blocks[];</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         */</div><div class="line">        INode(String name, INode parent, Block blocks[]) &#123;</div><div class="line">            <span class="keyword">this</span>.name = name;</div><div class="line">            <span class="keyword">this</span>.parent = parent;</div><div class="line">            <span class="keyword">this</span>.blocks = blocks;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">/**</span></div><div class="line">         * æ·»åŠ æ–‡ä»¶å—, å…¶å®å°±æ˜¯æŠŠblk_idå†™å…¥åˆ°childrenä¸­(åˆ°æ—¶å€™åœ¨saveImageä¸­ä½¿ç”¨)</div><div class="line">         * <span class="doctag">@param</span> target</div><div class="line">         * <span class="doctag">@param</span> blks</div><div class="line">         * <span class="doctag">@return</span></div><div class="line">         */</div><div class="line">        <span class="function">INode <span class="title">addNode</span><span class="params">(String target, Block blks[])</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (getNode(target) != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                String parentName = DFSFile.getDFSParent(target);</div><div class="line">                <span class="keyword">if</span> (parentName == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                INode parentNode = getNode(parentName);</div><div class="line">                <span class="keyword">if</span> (parentNode == <span class="keyword">null</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    <span class="comment">// è¯»å–çš„fsimagæ–‡ä»¶æ•°æ®, è¿™é‡Œçš„targetNameå…¶å®å°±æ˜¯æˆ‘ä»¬HDFSä¸Šçš„æ–‡ä»¶å</span></div><div class="line">                    <span class="comment">// blkså°±æ˜¯å­˜å‚¨åœ¨DataNodeä¸Šçš„blkæ–‡ä»¶åå­—</span></div><div class="line">                    <span class="comment">// parentNodeæ˜¯æˆ‘ä»¬çš„çˆ¶èŠ‚ç‚¹(å¤´ç»“ç‚¹)</span></div><div class="line">                    String targetName = <span class="keyword">new</span> File(target).getName();</div><div class="line">                    INode newItem = <span class="keyword">new</span> INode(targetName, parentNode, blks);</div><div class="line">                    <span class="comment">// ä¹‹åä¼šè¢«saveImageè¿›è¡Œä½¿ç”¨</span></div><div class="line">                    parentNode.children.put(targetName, newItem);</div><div class="line">                    <span class="keyword">return</span> newItem;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">int</span> <span class="title">numItemsInTree</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">int</span> total = <span class="number">0</span>;</div><div class="line">            <span class="keyword">for</span> (Iterator it = children.values().iterator(); it.hasNext();) &#123;</div><div class="line">                INode child = (INode) it.next();</div><div class="line">                total += child.numItemsInTree();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> total + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * This is the external interface</div><div class="line">         */</div><div class="line">        <span class="function">INode <span class="title">getNode</span><span class="params">(String target)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!target.startsWith(<span class="string">"/"</span>) || target.length() == <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parent == <span class="keyword">null</span> &amp;&amp; <span class="string">"/"</span>.equals(target)) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Vector components = <span class="keyword">new</span> Vector();</div><div class="line">                <span class="keyword">int</span> start = <span class="number">0</span>;</div><div class="line">                <span class="keyword">int</span> slashid = <span class="number">0</span>;</div><div class="line">                <span class="keyword">while</span> (start &lt; target.length() &amp;&amp; (slashid = target.indexOf(<span class="string">'/'</span>, start)) &gt;= <span class="number">0</span>) &#123;</div><div class="line">                    components.add(target.substring(start, slashid));</div><div class="line">                    start = slashid + <span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (start &lt; target.length()) &#123;</div><div class="line">                    components.add(target.substring(start));</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">return</span> getNode(components, <span class="number">0</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         */</div><div class="line">        <span class="function">INode <span class="title">getNode</span><span class="params">(Vector components, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (!name.equals((String) components.elementAt(index))) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (index == components.size() - <span class="number">1</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="comment">// Check with children</span></div><div class="line">            INode child = (INode) children.get(components.elementAt(index + <span class="number">1</span>));</div><div class="line">            <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">return</span> child.getNode(components, index + <span class="number">1</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/**</span></div><div class="line">         * é€šè¿‡é€’å½’è°ƒç”¨æŠŠå…ƒæ•°æ®ä¿¡æ¯å†™å…¥åˆ°fsimage.newæ–‡ä»¶ä¸­</div><div class="line">         * å…¶å®å°±æ˜¯æŠŠloadFSImageæ–¹æ³•åŠ è½½åˆ°å†…å­˜çš„æ•°æ®è¯»å–å‡ºæ¥ç„¶åå†™å…¥è¿›å»</div><div class="line">         */</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">saveImage</span><span class="params">(String parentPrefix, DataOutputStream out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">            String fullName = <span class="string">""</span>;</div><div class="line">            <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">                fullName = parentPrefix + <span class="string">"/"</span> + name;</div><div class="line">                <span class="keyword">new</span> UTF8(fullName).write(out);</div><div class="line">                <span class="keyword">if</span> (blocks == <span class="keyword">null</span>) &#123;</div><div class="line">                    out.writeInt(<span class="number">0</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    out.writeInt(blocks.length);</div><div class="line">                    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; blocks.length; i++) &#123;</div><div class="line">                        blocks[i].write(out);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">for</span> (Iterator it = children.values().iterator(); it.hasNext();) &#123;</div><div class="line">                INode child = (INode) it.next();</div><div class="line">                child.saveImage(fullName, out);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">static</span> String FS_IMAGE = <span class="string">"fsimage"</span>;</div><div class="line">    <span class="keyword">static</span> String NEW_FS_IMAGE = <span class="string">"fsimage.new"</span>;</div><div class="line">    <span class="keyword">static</span> String OLD_FS_IMAGE = <span class="string">"fsimage.old"</span>;</div><div class="line"></div><div class="line">    <span class="comment">// å³æˆ‘ä»¬çš„å¤´ç»“ç‚¹</span></div><div class="line">    INode rootDir = <span class="keyword">new</span> INode(<span class="string">""</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">    TreeSet activeBlocks = <span class="keyword">new</span> TreeSet();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">unprotectedAddFile</span><span class="params">(UTF8 name, Block blocks[])</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (rootDir) &#123;</div><div class="line">            <span class="keyword">if</span> (blocks != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="comment">// Add file-&gt;block mapping</span></div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; blocks.length; i++) &#123;</div><div class="line">                    activeBlocks.add(blocks[i]);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> (rootDir.addNode(name.toString(), blocks) != <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">loadFSImage</span><span class="params">(File fsdir, File edits)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        File curFile = <span class="keyword">new</span> File(fsdir, FS_IMAGE);</div><div class="line">        File newFile = <span class="keyword">new</span> File(fsdir, NEW_FS_IMAGE);</div><div class="line">        File oldFile = <span class="keyword">new</span> File(fsdir, OLD_FS_IMAGE);</div><div class="line"></div><div class="line">        <span class="comment">// è¿™é‡Œçš„åˆ¤æ–­æŒºæœ‰æ„æ€çš„</span></div><div class="line">        <span class="comment">// saveFSImageä¸­é€”å¤±è´¥è¿˜æ²¡ä»å‘½åæˆ–è€…ä¸€äº›å·²ç»å‘½åå¥½äº†çš„æ–‡ä»¶,é€šè¿‡ä¸åŒåˆ¤æ–­è¿›è¡Œä¿®å¤</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> (oldFile.exists() &amp;&amp; curFile.exists()) &#123;</div><div class="line">            oldFile.delete();</div><div class="line">            <span class="keyword">if</span> (edits.exists()) &#123;</div><div class="line">                edits.delete();</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oldFile.exists() &amp;&amp; newFile.exists()) &#123;</div><div class="line">            newFile.renameTo(curFile);</div><div class="line">            oldFile.delete();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (curFile.exists() &amp;&amp; newFile.exists()) &#123;</div><div class="line">            newFile.delete();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (curFile.exists()) &#123;</div><div class="line">            DataInputStream in = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(<span class="keyword">new</span> FileInputStream(curFile)));</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">int</span> numFiles = in.readInt();</div><div class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numFiles; i++) &#123;</div><div class="line">                    UTF8 name = <span class="keyword">new</span> UTF8();</div><div class="line">                    name.readFields(in);</div><div class="line">                    <span class="keyword">int</span> numBlocks = in.readInt();</div><div class="line">                    <span class="keyword">if</span> (numBlocks == <span class="number">0</span>) &#123;</div><div class="line">                        unprotectedAddFile(name, <span class="keyword">null</span>);</div><div class="line">                    &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        Block blocks[] = <span class="keyword">new</span> Block[numBlocks];</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; numBlocks; j++) &#123;</div><div class="line">                            blocks[j] = <span class="keyword">new</span> Block();</div><div class="line">                            blocks[j].readFields(in);</div><div class="line">                        &#125;</div><div class="line">                        unprotectedAddFile(name, blocks);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                in.close();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line"></div><div class="line">        <span class="comment">// if (edits.exists() &amp;&amp; loadFSEdits(edits) &gt; 0) &#123;</span></div><div class="line">        <span class="comment">// return true;</span></div><div class="line">        <span class="comment">// &#125; else &#123;</span></div><div class="line">        <span class="comment">// return false;</span></div><div class="line">        <span class="comment">// &#125;</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveFSImage</span><span class="params">(File fullimage, File edits)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        File curFile = <span class="keyword">new</span> File(fullimage, FS_IMAGE);</div><div class="line">        File newFile = <span class="keyword">new</span> File(fullimage, NEW_FS_IMAGE);</div><div class="line">        File oldFile = <span class="keyword">new</span> File(fullimage, OLD_FS_IMAGE);</div><div class="line"></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="comment">// Write out data</span></div><div class="line">        <span class="comment">//</span></div><div class="line">        DataOutputStream out = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(<span class="keyword">new</span> FileOutputStream(newFile)));</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            out.writeInt(rootDir.numItemsInTree() - <span class="number">1</span>);</div><div class="line">            rootDir.saveImage(<span class="string">""</span>, out);</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            out.close();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">//</span></div><div class="line">        <span class="comment">// Atomic move sequence(è¿™é‡Œè¯´çš„åŸå­æ“ä½œæˆ‘ä¹‹å‰æƒ³æˆæ˜¯ç±»ä¼¼äº‹åŠ¡çš„åŠŸèƒ½äº†ï¼Œæ‰€åœ¨è‡ªå·±æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ï¼Œçœ‹çœ‹æ˜¯å¦ä¼šå›é€€,ç»“æœå¹¶æ²¡æœ‰)</span></div><div class="line"></div><div class="line">        <span class="comment">// 1-4æ­¥ï¼šæŠŠå½“å‰fsimageä¿®æ”¹ä¸ºoldæ–‡ä»¶ï¼Œå¹¶å°†saveImageæ–¹æ³•å†™å…¥æ•°æ®çš„æ–‡ä»¶é‡å‘½åä¸ºfsimageï¼Œä¹‹ååˆ é™¤editså’Œoldæ–‡ä»¶</span></div><div class="line">        <span class="comment">// 1. Move cur to old</span></div><div class="line">        curFile.renameTo(oldFile);</div><div class="line">        </div><div class="line"><span class="comment">//        int i = 1 / 0; // æµ‹è¯•åŸå­æ€§</span></div><div class="line"></div><div class="line">        <span class="comment">// 2. Move new to cur</span></div><div class="line">        newFile.renameTo(curFile);</div><div class="line"></div><div class="line">        <span class="comment">// 3. Remove pending-edits file (it's been integrated with newFile)</span></div><div class="line">        edits.delete();</div><div class="line"></div><div class="line">        <span class="comment">// 4. Delete old</span></div><div class="line">        oldFile.delete();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        File dir = <span class="keyword">new</span> File(<span class="string">"tmp/hadoopx/dfs/name"</span>);</div><div class="line">        File fullimage = <span class="keyword">new</span> File(dir, <span class="string">"image"</span>);</div><div class="line">        File edits = <span class="keyword">new</span> File(dir, <span class="string">"edits"</span>);</div><div class="line">        FSDirectorTest fsDirectorTest = <span class="keyword">new</span> FSDirectorTest();</div><div class="line">        <span class="keyword">boolean</span> loadFSImage = fsDirectorTest.loadFSImage(fullimage, edits);</div><div class="line">        System.out.println(loadFSImage);</div><div class="line">        <span class="keyword">if</span> (loadFSImage) &#123;</div><div class="line">            fsDirectorTest.saveFSImage(fullimage, edits);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æµç¨‹å›¾"><a href="#æµç¨‹å›¾" class="headerlink" title="æµç¨‹å›¾?"></a>æµç¨‹å›¾?</h3><p>ä¹Ÿç®—ä¸ä¸Šæ˜¯ä¸€ä¸ªæµç¨‹å›¾ï¼Œåªä¸è¿‡æŠŠä»£ç ä¸Šä¸€äº›å†…å®¹ä»¥å›¾ç‰‡æ–¹å¼å‘ˆç°ã€‚</p>
<p><img src="https://github.com/basebase/img_server/blob/master/Hadoop-NameNode%E5%90%AF%E5%8A%A8%E4%B9%8BFSDirectiry/addNode.png?raw=true" alt="addNode"></p>
<p>å†™å…¥åˆ°.newçš„æ–‡ä»¶åç„¶åé‡å‘½åä¸ºfsimageä¹‹åå†åˆ é™¤.oldçš„æ–‡ä»¶è¿™æ ·å°±ç®—åŠ è½½å®Œæ¯•äº†ã€‚</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Javaçº¿ç¨‹ä»‹ç»åŠå®‰å…¨]]></title>
      <url>http://yoursite.com/2017/04/16/Java%E7%BA%BF%E7%A8%8B%E4%BB%8B%E7%BB%8D%E5%8F%8A%E5%AE%89%E5%85%A8/</url>
      <content type="html"><![CDATA[<h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><p><a href="https://github.com/forhappy/Cplusplus-Concurrency-In-Practice/blob/master/zh/chapter1-Introduction/1.1%20What%20is%20concurrency.md" target="_blank" rel="external">https://github.com/forhappy/Cplusplus-Concurrency-In-Practice/blob/master/zh/chapter1-Introduction/1.1%20What%20is%20concurrency.md</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mysqlå­¦ä¹ ç¬”è®°-äº‹åŠ¡éš”ç¦»çº§åˆ«]]></title>
      <url>http://yoursite.com/2017/03/05/mysql%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0-%E4%BA%8B%E5%8A%A1%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB/</url>
      <content type="html"><![CDATA[<p>äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ<br>  äº‹åŠ¡å°±æ˜¯ä¸€ç»„åŸå­æ€§çš„SQLæŸ¥è¯¢ï¼Œæˆ–è€…è¯´ä¸€ä¸ªç‹¬ç«‹çš„å·¥ä½œå•å…ƒã€‚å¦‚æœæ•°æ®åº“å¼•æ“èƒ½å¤Ÿ<br>  æˆåŠŸçš„å¯¹æ•°æ®åº“åº”ç”¨è¯¥ç»„æŸ¥è¯¢çš„å…¨éƒ¨è¯­å¥ï¼Œé‚£ä¹ˆæ‰§è¡Œè¯¥ç»„æŸ¥è¯¢ã€‚å¦‚æœå…¶ä¸­æœ‰ä»»ä½•ä¸€æ¡è¯­å¥å› ä¸ºå´©æºƒ<br>  æˆ–è€…å…¶å®ƒåŸå› æ— æ³•æ‰§è¡Œï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¯­å¥éƒ½ä¸ä¼šæ‰§è¡Œã€‚ä¹Ÿå°±è¯´ï¼Œäº‹åŠ¡å†…çš„è¯­å¥ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œ<br>  è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥ã€‚</p>
<a id="more"></a>
<h3 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h3><h4 id="äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ"></a>äº‹åŠ¡æ˜¯ä»€ä¹ˆï¼Ÿ</h4><p>  äº‹åŠ¡å°±æ˜¯ä¸€ç»„åŸå­æ€§çš„SQLæŸ¥è¯¢ï¼Œæˆ–è€…è¯´ä¸€ä¸ªç‹¬ç«‹çš„å·¥ä½œå•å…ƒã€‚å¦‚æœæ•°æ®åº“å¼•æ“èƒ½å¤Ÿ<br>  æˆåŠŸçš„å¯¹æ•°æ®åº“åº”ç”¨è¯¥ç»„æŸ¥è¯¢çš„å…¨éƒ¨è¯­å¥ï¼Œé‚£ä¹ˆæ‰§è¡Œè¯¥ç»„æŸ¥è¯¢ã€‚å¦‚æœå…¶ä¸­æœ‰ä»»ä½•ä¸€æ¡è¯­å¥å› ä¸ºå´©æºƒ<br>  æˆ–è€…å…¶å®ƒåŸå› æ— æ³•æ‰§è¡Œï¼Œé‚£ä¹ˆæ‰€æœ‰çš„è¯­å¥éƒ½ä¸ä¼šæ‰§è¡Œã€‚ä¹Ÿå°±è¯´ï¼Œäº‹åŠ¡å†…çš„è¯­å¥ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡ŒæˆåŠŸï¼Œ<br>  è¦ä¹ˆå…¨éƒ¨æ‰§è¡Œå¤±è´¥ã€‚</p>
<h3 id="äº‹åŠ¡çš„ç‰¹æ€§ACID"><a href="#äº‹åŠ¡çš„ç‰¹æ€§ACID" class="headerlink" title="äº‹åŠ¡çš„ç‰¹æ€§ACID"></a>äº‹åŠ¡çš„ç‰¹æ€§ACID</h3><p>é“¶è¡Œçš„ä¾‹å­æ˜¯è§£é‡Šäº‹åŠ¡æœ€å¥½çš„ä¾‹å­ï¼Œå‡è®¾ä¸€ä¸ªé“¶è¡Œçš„æ•°æ®åº“æœ‰ä¸¤å¼ è¡¨ï¼šæ”¯ç¥¨(checking)å’Œå‚¨è“„(savings)<br>è¡¨ã€‚ç°åœ¨è¦ä»ç”¨æˆ·å°å¢¨é±¼çš„æ”¯ç¥¨è´¦æˆ·è½¬ç§»200å…ƒåˆ°å°ç¾çš„å‚¨è“„è´¦æˆ·ï¼Œé‚£ä¹ˆè‡³å°‘éœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼š</p>
<p>1ã€æ£€æŸ¥æ”¯ç¥¨è´¦æˆ·çš„ä½™é¢é«˜äº200å…ƒ<br>2ã€ä¸›æ”¯ç¥¨è´¦æˆ·ä½™é¢ä¸­å‡å»200å…ƒ<br>3ã€åœ¨å‚¨è“„è´¦æˆ·è´¦æˆ·ä¸­å¢åŠ 200å…ƒ</p>
<p>ä¸Šè¿°ä¸‰ä¸ªæ­¥éª¤å¿…é¡»æ‰“åŒ…åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œä»»ä½•ä¸€ä¸ªæ­¥éª¤å¤±è´¥ï¼Œåˆ™å¿…é¡»å›æ»šæ‰€æœ‰çš„æ­¥éª¤ã€‚</p>
<p>æˆ‘ä¹ˆå¯ä»¥ä½¿ç”¨<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">start</span> <span class="keyword">transaction</span></div></pre></td></tr></table></figure></p>
<p>å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œç„¶åä½¿ç”¨COMMITæäº¤äº‹åŠ¡å°†ä¿®æ”¹çš„æ•°æ®æŒä¹…ä¿ç•™ï¼Œè¦ä¹ˆä½¿ç”¨ROLLBACKæ’¤é”€<br>æ‰€æœ‰çš„ä¿®æ”¹ã€‚äº‹åŠ¡SQLçš„æ ·æœ¬å¦‚ä¸‹:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line"><span class="keyword">select</span> balance <span class="keyword">from</span> checking <span class="keyword">where</span> customer_id = <span class="number">111</span>;</div><div class="line"><span class="keyword">update</span> checking <span class="keyword">set</span> balance = balance - <span class="number">200</span> <span class="keyword">where</span> customer_id = <span class="number">111</span>;</div><div class="line"><span class="keyword">update</span> savings <span class="keyword">set</span> balance = balance + <span class="number">200</span> <span class="keyword">where</span> customer_id = <span class="number">111</span>;</div></pre></td></tr></table></figure>
<p>å•çº¯çš„äº‹åŠ¡æ¦‚å¿µå¹¶ä¸æ˜¯æ•…äº‹çš„å…¨éƒ¨ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œå¦‚æœæ‰§è¡Œåˆ°ç¬¬å››æ¡è¯­å¥çš„æ—¶å€™æœåŠ¡å™¨å´©æºƒäº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆ?<br>å¤©çŸ¥é“ç”¨æˆ·ä¼šæŸå¤±200å…ƒã€‚å†å‡å¦‚ï¼Œåœ¨æ‰§è¡Œåˆ°ç¬¬ä¸‰æ¡ç¬¬å››æ¡è¯­å¥ä¹‹é—´æ—¶ï¼Œå¦å¤–ä¸€ä¸ªè¿›ç¨‹è¦åˆ é™¤æ”¯ç¥¨è´¦æˆ·<br>ä¸Šçš„æ‰€æœ‰ä½™é¢ï¼Œé‚£ä¹ˆç»“æœå¯èƒ½å°±æ˜¯é“¶è¡Œåœ¨ä¸çŸ¥é“è¿™ä¸ªé€»è¾‘çš„æƒ…å†µä¸‹ç™½é€200å…ƒã€‚</p>
<p>é™¤éç³»ç»Ÿé€šè¿‡ä¸¥æ ¼çš„ACIDæµ‹è¯•ï¼Œå¦åˆ™ç©ºè°ˆäº‹åŠ¡çš„æ¦‚å¿µæ˜¯ä¸å¤Ÿçš„ã€‚<br>ACIDè¡¨ç¤ºåŸå­æ€§(Atomicity)ã€ä¸€è‡´æ€§(consistency)ã€éš”ç¦»æ€§(isolation)å’ŒæŒä¹…æ€§(durability)<br>ä¸€ä¸ªè¿è¡Œè‰¯å¥½çš„äº‹åŠ¡å¤„ç†ç³»ç»Ÿï¼Œå¿…é¡»å…·å¤‡è¿™äº›æ ‡å‡†çš„ç‰¹å¾ã€‚</p>
<p><font color="DeepPink" size="2"> åŸå­æ€§: </font><br>  ä¸€ä¸ªäº‹åŠ¡å¿…é¡»è¢«è§†ä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æœ€å°å·¥ä½œå•å…ƒï¼Œæ•´ä¸ªäº‹åŠ¡ä¸­çš„æ‰€æœ‰æ“ä½œè¦ä¹ˆå…¨éƒ¨æäº¤æˆåŠŸï¼Œ<br>  è¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šï¼Œå¯¹äºä¸€ä¸ªäº‹åŠ¡æ¥è¯´ï¼Œä¸å¯èƒ½åªæ‰§è¡Œå…¶ä¸­çš„ä¸€éƒ¨åˆ†æ“ä½œï¼Œè¿™å°±æ˜¯äº‹åŠ¡çš„åŸå­æ€§ã€‚</p>
<p><font color="DeepPink" size="2"> ä¸€è‡´æ€§: </font><br>  æ•°æ®åº“æ€»æ˜¯ä»ä¸€ä¸ªä¸€è‡´æ€§çš„çŠ¶æ€è½¬æ¢åˆ°å¦ä¸€ä¸ªä¸€è‡´æ€§çŠ¶æ€ã€‚åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œä¸€è‡´æ€§ç¡®ä¿äº†ï¼Œå³ä½¿<br>  æ‰§è¡Œç¬¬ä¸‰ã€å››æ¡è¯­å¥ä¹‹é—´ç³»ç»Ÿå´©æºƒï¼Œæ”¯ç¥¨çš„è´¦æˆ·ä¸­ä¹Ÿä¸ä¼šæœ‰æŸå¤±ï¼Œå› ä¸ºäº‹åŠ¡æœ€ç»ˆæ²¡æœ‰æäº¤ï¼Œæ‰€ä»¥<br>  äº‹åŠ¡ä¸­æ‰€åšçš„ä¿®æ”¹ä¹Ÿä¸ä¼šä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚</p>
<p><font color="DeepPink" size="2"> éš”ç¦»æ€§:</font><br>  é€šå¸¸æ¥è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡æ‰€åšçš„ä¿®æ”¹åœ¨æœ€ç»ˆæäº¤ä»¥å‰ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚åœ¨å‰é¢çš„ä¾‹å­ä¸­ï¼Œå½“æ‰§è¡Œ<br>  å®Œç¬¬ä¸‰æ¡è¯­å¥ã€ç¬¬å››æ¡è¯­å¥è¿˜æœªå¼€å§‹æ—¶ï¼Œæ­¤æ—¶æœ‰å¦å¤–ä¸€ä¸ªè´¦æˆ·æ±‡æ€»ç¨‹åºå¼€å§‹è¿è¡Œï¼Œåˆ™å…¶çœ‹åˆ°çš„æ”¯ç¥¨è´¦æˆ·çš„<br>  ä½™é¢å¹¶æ²¡æœ‰è¢«å‡å»200å…ƒã€‚</p>
<p><font color="DeepPink" size="2"> æŒä¹…æ€§: </font><br>  ä¸€æ—¦äº‹åŠ¡æäº¤ï¼Œåˆ™å…¶æ‰€åšçš„ä¿®æ”¹å°±ä¼šæ°¸ä¹…ä¿å­˜åˆ°æ•°æ®åº“ä¸­ã€‚æ­¤æ—¶å³ä½¿ç³»ç»Ÿå´©æºƒï¼Œä¿®æ”¹çš„æ•°æ®ä¹Ÿä¸ä¼š<br>  ä¸¢å¤±ã€‚æŒä¹…æ€§æ˜¯ä¸ªæœ‰ç‚¹æ¨¡ç³Šçš„æ¦‚å¿µï¼Œå› ä¸ºå®é™…ä¸ŠæŒä¹…æ€§ä¹Ÿåˆ†å¾ˆå¤šä¸åŒçº§åˆ«ã€‚æœ‰äº›æŒä¹…æ€§ç­–ç•¥èƒ½å¤Ÿæä¾›<br>  éå¸¸å¼ºçš„å®‰å…¨ä¿éšœï¼Œè€Œæœ‰äº›åˆ™æœªå¿…ã€‚è€Œä¸”ä¸å¯èƒ½æœ‰åšåˆ°100%çš„æŒä¹…æ€§ä¿éšœç­–ç•¥ã€‚</p>
<p>ä¸€ä¸ªå®ç°äº†ACIDçš„æ•°æ®åº“ï¼Œç›¸æ¯”æ²¡æœ‰å®ç°ACIDçš„æ•°æ®åº“ï¼Œé€šå¸¸ä¼šéœ€è¦æ›´å¼ºçš„CPUå¤„ç†èƒ½åŠ›ã€æ›´å¤§çš„<br>å†…å­˜å’Œæ›´å¤šçš„ç£ç›˜ç©ºé—´ã€‚</p>
<h3 id="éš”ç¦»çº§åˆ«"><a href="#éš”ç¦»çº§åˆ«" class="headerlink" title="éš”ç¦»çº§åˆ«"></a>éš”ç¦»çº§åˆ«</h3><p>éš”ç¦»æ€§å…¶å®æ¯”æƒ³è±¡çš„è¦å¤æ‚ï¼Œåœ¨SQLæ ‡å‡†ä¸­å®šä¹‰äº†å››ç§éš”ç¦»çº§åˆ«ï¼Œæ¯ä¸€ç§çº§åˆ«éƒ½è§„å®šäº†ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰€<br>åšçš„ä¿®æ”¹ï¼Œå“ªäº›åœ¨äº‹åŠ¡å†…å’Œäº‹åŠ¡é—´å¯è§çš„ï¼Œå“ªäº›æ˜¯ä¸å¯è§çš„ã€‚è¾ƒä½çº§åˆ«çš„éš”ç¦»é€šå¸¸å¯ä»¥æ‰§è¡Œæ›´é«˜çš„å¹¶å‘ï¼Œ<br>ç³»ç»Ÿçš„å¼€é”€ä¹Ÿæ¯”è¾ƒä½ã€‚</p>
<p>æ¯ç§å­˜å‚¨å¼•æ“å®ç°çš„éš”ç¦»çº§åˆ«ä¸å°½ç›¸åŒã€‚å¦‚æœç†Ÿæ‚‰å…¶å®ƒçš„æ•°æ®åº“äº§å“ï¼Œå¯èƒ½ä¼šå‘ç°æŸäº›ç‰¹æ€§å’Œä½ æœŸæœ›çš„<br>ä¼šæœ‰ä¸€äº›ä¸åŒï¼Œå¯ä»¥æ ¹æ®æ‰€é€‰æ‹©çš„å¼•æ“æŸ¥é˜…ç›¸å…³çš„æ‰‹å†Œã€‚</p>
<p>ä¸‹é¢ç®€å•çš„ä»‹ç»ä¸€ä¸‹å››ç§éš”ç¦»çº§åˆ«ã€‚</p>
<p><font color="DeepPink" size="2"> READ UNCOMMITTED(æœªæäº¤è¯») </font><br>  åœ¨READ UNCOMMITTEDçº§åˆ«ï¼Œäº‹åŠ¡ä¸­çš„ä¿®æ”¹ï¼Œå³ä½¿æ²¡æœ‰æäº¤ï¼Œå¯¹å…¶å®ƒäº‹åŠ¡ä¹Ÿæ˜¯å¯è§çš„ã€‚<br>  äº‹åŠ¡å¯ä»¥è¯»å–ä¸ºæäº¤çš„æ•°æ®ï¼Œè¿™ä¹Ÿè¢«ç§°ä¸ºâ€œè„è¯»â€ã€‚è¿™ä¸ªçº§åˆ«ä¼šå¯¼è‡´å¾ˆå¤šé—®é¢˜ï¼Œä»æ€§èƒ½ä¸Š<br>  æ¥è¯´ï¼ŒREAD UNCOMMITTEDä¸ä¼šæ¯”å…¶å®ƒçš„çº§åˆ«å¥½å¤ªå¤šï¼Œä½†ç¼ºä¹å…¶å®ƒçº§åˆ«çš„å¾ˆå¤šå¥½å¤„ï¼Œé™¤é<br>  çœŸçš„æœ‰éå¸¸å¿…è¦çš„ç†ç”±ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ä¸€èˆ¬å¾ˆå°‘ä½¿ç”¨ã€‚</p>
<p><font color="DeepPink" size="2"> READ COMMITTED(æäº¤è¯») </font><br>  å¤§å¤šæ•°æ•°æ®åº“çš„é»˜è®¤éš”ç¦»çº§åˆ«éƒ½æ˜¯READ COMMITTEDï¼ˆä½†mysqlä¸æ˜¯ï¼‰ã€‚READ COMMITTEDæ»¡è¶³<br>  å‰é¢æåˆ°çš„éš”ç¦»æ€§çš„ç®€å•å®šä¹‰ï¼šä¸€ä¸ªäº‹åŠ¡å¼€å§‹æ—¶ï¼Œåªèƒ½â€œçœ‹è§â€å·²ç»æäº¤çš„äº‹åŠ¡æ‰€åšçš„æ”¹å˜ã€‚<br>  æ¢å¥è¯è¯´ï¼Œä¸€ä¸ªäº‹åŠ¡ä»å¼€å§‹ç›´åˆ°æäº¤ä¹‹å‰ï¼Œæ‰€åšçš„ä»»ä½•ä¿®æ”¹å¯¹å…¶å®ƒäº‹åŠ¡æ˜¯ä¸å¯è§çš„ã€‚è¿™ä¸ªçº§åˆ«<br>  æœ‰æ—¶å€™ä¹Ÿå«â€œä¸å¯é‡å¤è¯»â€ï¼Œå› ä¸ºä¸¤æ¬¡æ‰§è¡ŒåŒæ ·çš„æŸ¥è¯¢ï¼Œå¯èƒ½ä¼šå¾—åˆ°ä¸ä¸€æ ·çš„ç»“æœã€‚</p>
<p><font color="DeepPink" size="2"> REPEATABLE READ(å¯é‡å¤è¯») </font><br>  REPEATABLE READè§£å†³äº†è„è¯»çš„é—®é¢˜ï¼Œè¯¥çº§åˆ«ä¿è¯äº†åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­å¤šæ¬¡è¯»å–åŒæ ·è®°å½•çš„ç»“æœæ˜¯<br>  ä¸€è‡´çš„ã€‚ä½†æ˜¯ç†è®ºä¸Šï¼Œå¯é‡å¤è¯»éš”ç¦»çº§åˆ«è¿˜æ˜¯æ— æ³•è§£å†³å¦å¤–ä¸€ä¸ªå¹»è¯»çš„é—®é¢˜ã€‚æ‰€è°“çš„å¹»è¯»ï¼ŒæŒ‡çš„æ˜¯<br>  å½“æŸä¸ªäº‹åŠ¡åœ¨è¯»å–æŸä¸ªèŒƒå›´å†…çš„è®°å½•æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡åˆåœ¨è¯¥èŒƒå›´å†…æ’å…¥äº†æ–°çš„è®°å½•ï¼Œå½“ä¹‹å‰çš„äº‹åŠ¡<br>  å†æ¬¡è¯»å–è¯¥èŒƒå›´çš„è®°å½•æ—¶ï¼Œä¼šäº§ç”Ÿå¹»è¡Œã€‚InnoDBå’ŒXtraDBå­˜å‚¨å¼•æ“é€šè¿‡å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)<br>  è§£å†³äº†å¹»è¯»çš„é—®é¢˜ã€‚å¯é‡å¤è¯»æ˜¯mysqlé»˜è®¤äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚</p>
<p><font color="DeepPink" size="2"> SERIALIZABLE(å¯ä¸²è¡ŒåŒ–) </font><br>  SERIALIZABLEæ˜¯æœ€é«˜çš„éš”ç¦»çº§åˆ«ã€‚å®ƒé€šè¿‡å¼ºåˆ¶äº‹åŠ¡ä¸²è¡Œæ‰§è¡Œï¼Œé¿å…äº†å‰é¢è¯´çš„å¹»è¯»é—®é¢˜ã€‚<br>  ç®€å•æ¥è¯´ï¼ŒSERIALIZABLEä¼šåœ¨è¯»å–çš„æ¯ä¸€è¡Œæ•°æ®ä¸Šéƒ½åŠ é”ï¼Œæ‰€ä»¥å¯èƒ½å¯¼è‡´å¤§é‡çš„è¶…æ—¶å’Œé”<br>  äº‰ç”¨çš„æƒ…å†µã€‚å®é™…åº”ç”¨ä¸­ä¹Ÿå¾ˆå°‘ç”¨åˆ°è¿™ä¸ªéš”ç¦»çº§åˆ«ï¼Œåªæœ‰åœ¨éå¸¸éœ€è¦ç¡®ä¿æ•°æ®ä¸€è‡´æ€§è€Œä¸”å¯ä»¥æ¥å—<br>  æ²¡æœ‰å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œæ‰è€ƒè™‘é‡‡ç”¨è¯¥çº§åˆ«ã€‚</p>
<p>å…¶å®ï¼Œæ–‡ç« åˆ°è¿™é‡Œå·²ç»å°±è¦ç»“æŸçš„ã€‚<br>ä¸è¿‡è¿˜è¦ä¸€äº›å†…å®¹é¡ºå¸¦ä¸€èµ·å†™ä¸Šå»ğŸ˜ã€‚ã€‚ã€‚</p>
<h3 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h3><p>æ­»é”æŒ‡çš„æ˜¯ä¸¤ä¸ªæˆ–è€…å¤šä¸ªäº‹åŠ¡åœ¨åŒä¸€èµ„æºä¸Šç›¸äº’å ç”¨ï¼Œå¹¶è¯·æ±‚é”å®šå¯¹æ–¹å ç”¨çš„èµ„æºï¼Œä»è€Œå¯¼è‡´<br>è€Œè¡Œå¾ªç¯ç°è±¡ã€‚å½“å¤šä¸ªäº‹åŠ¡è§†å›¾ä»¥ä¸åŒé¡ºåºé”å®šèµ„æºæ—¶ï¼Œå°±å¯èƒ½ä¼šäº§ç”Ÿæ­»é”ã€‚<br>å¤šä¸ªäº‹åŠ¡åŒäº‹é”å®šåŒä¸€ä¸ªèµ„æºæ—¶ï¼Œä¹Ÿä¼šäº§ç”Ÿæ­»é”ã€‚ä¾‹å¦‚ï¼Œè®¾æƒ³ä¸‹é¢ä¸¤ä¸ªäº‹åŠ¡åŒæ—¶å¤„ç†StockPriceè¡¨ï¼š</p>
<p>äº‹åŠ¡1</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line"><span class="keyword">update</span> stockprice <span class="keyword">set</span> <span class="keyword">close</span> = <span class="number">22</span> <span class="keyword">where</span> stock_id = <span class="number">4</span> <span class="keyword">and</span> <span class="built_in">date</span> = <span class="string">'2017-01-01'</span></div><div class="line"><span class="keyword">update</span> stockprice <span class="keyword">set</span> <span class="keyword">close</span> = <span class="number">11</span> <span class="keyword">where</span> stock_id = <span class="number">3</span> <span class="keyword">and</span> <span class="built_in">date</span> = <span class="string">'2017-02-03'</span></div><div class="line"><span class="keyword">commit</span>;</div></pre></td></tr></table></figure>
<p>äº‹åŠ¡2</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">start</span> <span class="keyword">transaction</span>;</div><div class="line"><span class="keyword">update</span> stockprice <span class="keyword">set</span> <span class="keyword">high</span> = <span class="number">20.12</span> <span class="keyword">where</span> stock_id = <span class="number">3</span> <span class="keyword">and</span> <span class="built_in">date</span> = <span class="string">'2017-02-03'</span></div><div class="line"><span class="keyword">update</span> stockprice <span class="keyword">set</span> <span class="keyword">high</span> = <span class="number">47.20</span> <span class="keyword">where</span> stock_id = <span class="number">4</span> <span class="keyword">and</span> <span class="built_in">date</span> = <span class="string">'2017-01-01'</span></div><div class="line"><span class="keyword">commit</span>;</div></pre></td></tr></table></figure>
<p>å¦‚æœå‡‘å·§ï¼Œä¸¤ä¸ªäº‹åŠ¡éƒ½æ‰§è¡Œäº†ç¬¬ä¸€æ¡UPDATEè¯­å¥ï¼Œæ›´æ–°äº†ä¸€è¡Œæ•°æ®ï¼ŒåŒæ—¶ä¹Ÿé”å®šäº†è¯¥è¡Œæ•°æ®ï¼Œæ¥ç€<br>æ¯ä¸ªäº‹åŠ¡éƒ½å°è¯•å»æ‰§è¡Œç¬¬äºŒæ¡UPDATEè¯­å¥ï¼Œå´å‘ç°æ”¹è¡Œå·²ç»è¢«å¯¹æ–¹é”å®šï¼Œç„¶åä¸¤ä¸ªäº‹åŠ¡éƒ½ç­‰å¾…å¯¹æ–¹<br>é‡Šæ”¾é”ï¼ŒåŒäº‹åˆæŒæœ‰å¯¹æ–¹éœ€è¦çš„é”ï¼Œåˆ™é™·å…¥æ­»å¾ªç¯ã€‚é™¤éæœ‰å¤–éƒ¨å› ç´ ä»‹å…¥æ‰å¯èƒ½è§£é™¤æ­»é”ã€‚</p>
<p>InnoDBç›®å‰è§£å†³æ­»é”çš„æ–¹æ³•æ˜¯ï¼Œå°†æŒæœ‰æœ€å°‘è¡Œçº§æ’å®ƒé”çš„äº‹åŠ¡è¿›è¡Œå›æ»šã€‚</p>
<p>é”å®šè¡Œä¸ºå’Œé¡ºåºæ˜¯å’Œå­˜å‚¨å¼•æ“æœ‰å…³çš„ã€‚åŒæ ·çš„é¡ºåºæ‰§è¡Œè¯­å¥ï¼Œæœ‰äº›å­˜å‚¨å¼•æ“ä¼šäº§ç”Ÿæ­»é”ï¼Œæœ‰äº›åˆ™ä¸ä¼šã€‚<br>æ­»é”äº§ç”Ÿæœ‰åŒé‡åŸå› ï¼šæœ‰äº›æ˜¯å› ä¸ºçœŸæ­£çš„æ•°æ®å†²çªï¼Œè¿™ç§æƒ…å†µé€šå¸¸å¾ˆéš¾é¿å…ï¼Œä½†æœ‰äº›åˆ™å®Œå…¨æ˜¯ç”±å­˜å‚¨å¼•æ“<br>çš„å®ç°æ–¹å¼å¯¼è‡´çš„ã€‚</p>
<p>æ­»é”å‘ç”Ÿä»¥åï¼Œåªæœ‰éƒ¨åˆ†æˆ–è€…å®Œå…¨å›æ»šå…¶ä¸­ä¸€ä¸ªäº‹åŠ¡ï¼Œæ‰èƒ½æ‰“ç ´æ­»é”ã€‚å¯¹äºäº‹åŠ¡å‹çš„ç³»ç»Ÿï¼Œè¿™æ˜¯æ— æ³•é¿å…çš„ï¼Œ<br>æ‰€ä»¥åº”ç”¨ç¨‹åºåœ¨è®¾è®¡æ—¶å¿…é¡»è€ƒè™‘å¦‚ä½•å¤„ç†æ­»é”ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹åªéœ€è¦é‡æ–°æ‰§è¡Œå› æ­»é”çš„å›æ»šäº‹åŠ¡ã€‚</p>
<h3 id="å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"><a href="#å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶" class="headerlink" title="å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"></a>å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</h3><p>MySQLçš„å¤§å¤šæ•°äº‹åŠ¡å‹å­˜å‚¨å¼•æ“å®ç°çš„éƒ½ä¸æ˜¯ç®€å•çš„è¡Œçº§é”ã€‚åŸºäºæå‡å¹¶å‘æ€§èƒ½çš„è€ƒè™‘ï¼Œä»–ä»¬ä¸€èˆ¬<br>éƒ½åŒæ—¶å®ç°äº†å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶(MVCC)ã€‚ä¸ä»…æ˜¯MySQLï¼ŒåŒ…æ‹¬Oracleã€PostgreSQLç­‰å…¶ä»–æ•°æ®åº“<br>ä¹Ÿéƒ½å®ç°äº†MVCCï¼Œä½†å„è‡ªçš„å®ç°æœºåˆ¶ä¸å°½ç›¸åŒï¼Œå› ä¸ºMVCCæ²¡æœ‰ä¸€ä¸ªç»Ÿä¸€çš„çš„å®ç°æ ‡å‡†ã€‚</p>
<p>å¯ä»¥è®¤ä¸ºMVCCæ˜¯è¡Œçº§é”çš„ä¸€ä¸ªå˜ç§ï¼Œä½†æ˜¯å®ƒåœ¨å¾ˆå¤šæƒ…å†µä¸‹é¿å…äº†åŠ é”çš„æ“ä½œï¼Œå› æ­¤å¼€é”€æ›´ä½ã€‚<br>è™½ç„¶å®ç°æœºåˆ¶æœ‰æ‰€ä¸åŒï¼Œä½†å¤§å¤šå®ç°äº†éé˜»å¡çš„è¯»æ“ä½œï¼Œå†™æ“ä½œä¹Ÿåªé”å®šå¿…è¦çš„è¡Œã€‚</p>
<p>MVCCçš„å®ç°ï¼Œæ˜¯é€šè¿‡ä¿å­˜æ•°æ®åœ¨æŸä¸ªæ—¶é—´ç‚¹çš„å¿«ç…§æ¥å®ç°çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸ç®¡éœ€è¦æ‰§è¡Œå¤šé•¿æ—¶é—´ï¼Œ<br>æ¯ä¸ªäº‹åŠ¡çœ‹åˆ°çš„æ•°æ®éƒ½æ˜¯ä¸€è‡´çš„ã€‚æ ¹æ®äº‹åŠ¡å¼€å§‹çš„ä¸åŒï¼Œæ¯ä¸ªäº‹åŠ¡å¯¹åŒä¸€å¼ è¡¨ï¼ŒåŒä¸€æ—¶åˆ»çœ‹åˆ°çš„æ•°æ®<br>å¯èƒ½æ˜¯ä¸ä¸€æ ·çš„(å› ä¸ºä¸åŒçš„æ—¶é—´ç‚¹å¯èƒ½æ•°æ®å°±å·²ç»äº§ç”Ÿäº†ä¸åŒçš„å¿«ç…§ç‰ˆæœ¬ï¼Œè€Œæ¯ä¸ªäº‹åŠ¡åœ¨é»˜è®¤çš„RRéš”ç¦»çº§åˆ«ä¸‹åªèƒ½çœ‹åˆ°äº‹åŠ¡å¼€å§‹æ—¶çš„æ•°æ®å¿«ç…§)ã€‚</p>
<p>å‰é¢è¯´åˆ°ä¸åŒå­˜å‚¨å¼•æ“çš„MVCCå®ç°æ˜¯ä¸åŒçš„ï¼Œå…¸å‹çš„æœ‰ä¹è§‚(optimistic)å¹¶å‘æ§åˆ¶å’Œ<br>æ‚²è§‚(pessimistic)å¹¶å‘æ§åˆ¶ã€‚ä¸‹é¢é€šè¿‡InnoDBçš„ç®€åŒ–ç‰ˆè¡Œä¸ºæ¥è¯´æ˜MVCCæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚</p>
<p>InnoDBçš„MVCCï¼Œæ˜¯é€šè¿‡æ¯è¡Œè®°å½•åé¢ä¿å­˜ä¸¤ä¸ªéšè—çš„åˆ—æ¥å®ç°çš„ã€‚è¿™ä¸¤ä¸ªåˆ—ï¼šä¸€ä¸ªæ˜¯ä¿å­˜äº†è¡Œçš„åˆ›å»ºæ—¶é—´ï¼Œ<br>ä¸€ä¸ªä¿å­˜è¡Œçš„è¿‡æœŸæ—¶é—´(æˆ–åˆ é™¤æ—¶é—´)ã€‚å½“ç„¶å­˜å‚¨çš„å¹¶ä¸æ˜¯å®é™…çš„æ—¶é—´å€¼ï¼Œè€Œæ˜¯ç³»ç»Ÿç‰ˆæœ¬å·ã€‚æ²¡å¼€å§‹ä¸€ä¸ª<br>æ–°çš„äº‹åŠ¡ï¼Œç³»ç»Ÿç‰ˆæœ¬å·ä¼šè‡ªåŠ¨å¢åŠ ã€‚äº‹åŠ¡å¼€å§‹æ—¶åˆ»çš„ç³»ç»Ÿç‰ˆæœ¬å·ä¼šä½œä¸ºäº‹åŠ¡çš„ç‰ˆæœ¬å·ï¼Œç”¨æ¥å’ŒæŸ¥è¯¢åˆ°çš„<br>æ¯è¡Œè®°å½•çš„ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒã€‚ä¸‹é¢çœ‹ä¸€ä¸‹åœ¨REPEATABLE READéš”ç¦»çº§åˆ«ä¸‹ï¼ŒMVCCå…·ä½“æ˜¯å¦‚ä½•æ“ä½œçš„ã€‚</p>
<p>SELECT<br>  InnoDBä¼šæ ¹æ®ä»¥ä¸‹ä¸¤ä¸ªæ¡ä»¶æ£€æŸ¥æ¯è¡Œè®°å½•ï¼š<br>    a) InnoDBåªæŸ¥æ‰¾ç‰ˆæœ¬æ—©äºå½“å‰äº‹åŠ¡ç‰ˆæœ¬çš„æ•°æ®è¡Œ(ä¹Ÿå°±æ˜¯ï¼Œè¡Œçš„ç‰ˆæœ¬å·å°äºæˆ–ç­‰äºäº‹åŠ¡çš„ç³»ç»Ÿç‰ˆæœ¬å·)<br>       è¿™æ ·å¯ä»¥ç¡®ä¿äº‹åŠ¡è¯»å–çš„è¡Œï¼Œè¦ä¹ˆæ˜¯åœ¨äº‹åŠ¡å¼€å§‹ä¹‹å‰å·²ç»å­˜åœ¨çš„ï¼Œè¦ä¹ˆæ˜¯äº‹åŠ¡è‡ªèº«æ’å…¥æˆ–è€…ä¿®æ”¹è¿‡çš„ã€‚</p>
<pre><code>b) è¡Œçš„åˆ é™¤ç‰ˆæœ¬è¦ä¹ˆæœªå®šä¹‰ï¼Œè¦ä¹ˆå¤§äºå½“å‰äº‹åŠ¡ç‰ˆæœ¬å·ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿äº‹åŠ¡è¯»å–åˆ°çš„è¡Œï¼Œåœ¨
   äº‹åŠ¡å¼€å§‹ä¹‹å‰ä¸ºè¢«åˆ é™¤ã€‚
</code></pre><p>INSERT<br>  InnoDBä¸ºæ–°æ’å…¥çš„æ¯ä¸€è¡Œä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºè¡Œç‰ˆæœ¬å·ã€‚</p>
<p>DELETE<br>  InnoDBä¸ºåˆ é™¤çš„æ¯ä¸€è¡Œä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·ä½œä¸ºåˆ é™¤æ ‡è¯†ã€‚</p>
<p>UPDATE<br>  InnoDBä¸ºæ’å…¥ä¸€è¡Œæ–°è®°å½•ï¼Œä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·åšä¸ºè¡Œç‰ˆæœ¬å·ï¼ŒåŒæ—¶ä¿å­˜å½“å‰ç³»ç»Ÿç‰ˆæœ¬å·<br>  åˆ°åŸæ¥çš„è¡Œä¸ºä½œä¸ºåˆ é™¤æ ‡è¯†ã€‚</p>
<p>ä¿å­˜ç€ä¸¤ä¸ªé¢å¤–ç³»ç»Ÿç‰ˆæœ¬å·ï¼Œä½¿å¤§å¤šæ•°è¯»æ“ä½œéƒ½å¯ä»¥ä¸ç”¨åŠ é”ã€‚è¿™æ ·è®¾è®¡ä½¿å¾—è¯»æ•°æ®æ“ä½œå¾ˆç®€å•ï¼Œ<br>æ€§èƒ½å¾ˆå¥½ï¼Œå¹¶ä¸”ä¹Ÿèƒ½ä¿è¯åªä¼šè¯»å–åˆ°ç¬¦åˆæ ‡å‡†çš„è¡Œã€‚ä¸è¶³ä¹‹å¤„å°±æ˜¯æ¯è¡Œè®°å½•éƒ½éœ€è¦é¢å¤–çš„å­˜å‚¨ç©ºé—´ï¼Œ<br>éœ€è¦åšæ›´å¤šæ£€æŸ¥å·¥ä½œï¼Œä»¥åŠä¸€äº›é¢å¤–çš„ç»´æŠ¤å·¥ä½œã€‚</p>
<p>MVCCåªåœ¨PEPEATABLE READ å’Œ READ COMMITTEDä¸¤ä¸ªéš”ç¦»çº§åˆ«ä¸‹å·¥ä½œã€‚<br>å…¶å®ƒä¸¤ä¸ªéš”ç¦»çº§åˆ«éƒ½å’ŒMVCCä¸å…¼å®¹ï¼Œå› ä¸ºREAD UNCOMMITTEDæ€»æ˜¯è¯»å–åˆ°æœ€æ–°çš„æ•°æ®è¡Œï¼Œè€Œä¸æ˜¯<br>ç¬¦åˆå½“å‰äº‹åŠ¡ç‰ˆæœ¬çš„æ•°æ®è¡Œã€‚è€ŒSERIALIZABLEåˆ™ä¼šå¯¹æ‰€æœ‰è¯»å–çš„è¡Œéƒ½åŠ é”ã€‚</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.jianshu.com/p/8d735db9c2c0" target="_blank" rel="external">http://www.jianshu.com/p/8d735db9c2c0</a>  ã€éš”ç¦»çº§åˆ«å®æˆ˜ã€‘<br><a href="http://tech.meituan.com/innodb-lock.html" target="_blank" rel="external">http://tech.meituan.com/innodb-lock.html</a>  ã€ç¾å›¢çš„åšå®¢è´¨é‡å‘æ¥éƒ½æ¯”è¾ƒé«˜ã€‘</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[hadoop Partitionerä½¿ç”¨åŠæ³¨æ„ç‚¹]]></title>
      <url>http://yoursite.com/2017/02/07/hadoop-Partitioner%E4%BD%BF%E7%94%A8%E5%8F%8A%E6%B3%A8%E6%84%8F%E7%82%B9/</url>
      <content type="html"><![CDATA[<p>å‰è¨€<br>hadoopå·²ç»å‡ºæ¥è¿™ä¹ˆé•¿æ—¶é—´äº†ï¼Œåˆ†åŒºçš„æ–‡ç« æ—©å·²ç»å¤šå¦‚ç‰›æ¯›ï¼Œä¸ºä½•ä½ è¿˜è¦å†™å‘¢?<br>å…¶å®å‘¢ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³è¦ä»‹ç»ä¸€ä¸‹ä½¿ç”¨MRè‡ªå®šä¹‰åˆ†åŒºéœ€è¦æ³¨æ„çš„ä¸€äº›ç‚¹ã€‚<br><a id="more"></a></p>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>hadoopå·²ç»å‡ºæ¥è¿™ä¹ˆé•¿æ—¶é—´äº†ï¼Œåˆ†åŒºçš„æ–‡ç« æ—©å·²ç»å¤šå¦‚ç‰›æ¯›ï¼Œä¸ºä½•ä½ è¿˜è¦å†™å‘¢?<br>å…¶å®å‘¢ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯æƒ³è¦ä»‹ç»ä¸€ä¸‹ä½¿ç”¨MRè‡ªå®šä¹‰åˆ†åŒºéœ€è¦æ³¨æ„çš„ä¸€äº›ç‚¹ã€‚<br>å¯èƒ½æ—©æœ‰å‰è¾ˆå·²ç»æŒ‡å‡ºè¯¥é—®é¢˜äº†ã€‚ä½†è¿˜æ˜¯å®¹æˆ‘è‡ªå·±åšä¸€ä¸ªå°å°çš„è®°å½•ï¼Œå“ˆå“ˆå“ˆ~~~</p>
<p>æˆ‘ä»¬çŸ¥é“mapæ•°æ®ä¼šå†™å…¥åˆ°åˆ†åŒºï¼Œé»˜è®¤çš„åˆ†åŒºåªæœ‰ä¸€ä¸ªï¼Œä½†æ˜¯æˆ‘æƒ³è¦10ä¸ªåˆæˆ–è€…æ˜¯100ä¸ªï¼Œå¯ä»¥å—ï¼Ÿ<br>å½“ç„¶æ˜¯å¯ä»¥çš„æ˜¯ã€‚</p>
<p>ä½ åªéœ€è¦åˆ›å»ºä¸€ä¸ªç±»ç»§æ‰¿org.apache.hadoop.mapreduce.Partitioner<br>ç±»å°±å¯ä»¥å®Œå…¨å®šä¹‰è‡ªå·±æƒ³è¦çš„åˆ†åŒºæ–¹å¼ã€‚<br>ç„¶ååœ¨jobä¸­è®¾ç½®è‡ªå®šä¹‰çš„Partitionerç±»å³å¯ã€‚<br>ä½†æ˜¯ï¼Œè¿™æ ·å†™çœŸçš„å°±ç»“æŸäº†å—ï¼Ÿ</p>
<h3 id="ä¸€ä¸ªä¾‹å­"><a href="#ä¸€ä¸ªä¾‹å­" class="headerlink" title="ä¸€ä¸ªä¾‹å­"></a>ä¸€ä¸ªä¾‹å­</h3><p>PartitionMapper.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">        String[] tokens = value.toString().split(<span class="string">","</span>);</div><div class="line">        String gender = tokens[<span class="number">2</span>];</div><div class="line">        String nameAgeScore = tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">1</span>] + <span class="string">","</span> + tokens[<span class="number">3</span>];</div><div class="line">        context.write(<span class="keyword">new</span> Text(gender), <span class="keyword">new</span> Text(nameAgeScore));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>AgePartitioner.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(Text key, Text value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</div><div class="line">        </div><div class="line">        String[] nameAgeScore = value.toString().split(<span class="string">","</span>);</div><div class="line">        String age = nameAgeScore[<span class="number">1</span>];</div><div class="line">        <span class="keyword">int</span> ageInt = Integer.parseInt(age);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (numPartitions == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ageInt &lt;= <span class="number">20</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (ageInt &gt; <span class="number">20</span> &amp;&amp; ageInt &lt;= <span class="number">50</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="number">1</span> % numPartitions;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">2</span> % numPartitions;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>ParitionReducer.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values, Context context)</span></span></div><div class="line">            <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> maxScore = Integer.MIN_VALUE;</div><div class="line">        String name = <span class="string">""</span>;</div><div class="line">        String age = <span class="string">""</span>;</div><div class="line">        String gender = <span class="string">""</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">int</span> score = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (Text val : values) &#123;</div><div class="line">            String[] valTokens = val.toString().split(<span class="string">","</span>);</div><div class="line">            score = Integer.parseInt(valTokens[<span class="number">2</span>]);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (score &gt; maxScore) &#123;</div><div class="line">                name = valTokens[<span class="number">0</span>];</div><div class="line">                age = valTokens[<span class="number">1</span>];</div><div class="line">                gender = key.toString();</div><div class="line">                maxScore = score;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        context.write(<span class="keyword">new</span> Text(name), <span class="keyword">new</span> Text(<span class="string">"age- "</span> + age + <span class="string">","</span> + gender + <span class="string">","</span> + <span class="string">" score-"</span> + maxScore));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>é©±åŠ¨ç±»ï¼Œå…·ä½“çš„æ¨¡æ¿ä»£ç æˆ‘å°±ä¸å†å†™å…¥ï¼Œåªå°†Partitionerè®¾ç½®å±•ç¤º<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">job.setPartitionerClass(AgePartitioner.class);</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸Šè¿™ä¸ªä¾‹å­ï¼Œæ˜¯æˆ‘åœ¨å…¶å®ƒæ–‡ç« ä¸­æˆªå–ä¸‹æ¥çš„ï¼Œå…·ä½“åœ°å€ï¼Œä¼šåœ¨é“¾æ¥ä¸­ç»™å‡ºã€‚<br>ç°åœ¨ï¼Œä½ å¯ä»¥è¿è¡Œè¯¥ä¾‹å­ï¼Œä½ ä¼šå‘ç°Reduceè¾“å‡ºçš„åªæœ‰ä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åä½ è¿˜ä¼šå‘ç°å…¶å®ä½¿ç”¨çš„å¹¶éæ˜¯è‡ªå®šä¹‰<br>çš„Partitionerç±»ã€‚</p>
<p>ä¸€å¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘æœ‰ç‚¹æ‡µé€¼äº†ã€‚whatï¼Ÿæˆ‘çš„è®¾ç½®æ²¡æœ‰ç”Ÿæ•ˆå—ï¼Ÿ<br>ä½ çš„è®¾ç½®æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†æ˜¯ä½ å´å¿˜è®°äº†ä¸€é¡¹é‡è¦çš„äº‹æƒ…ã€‚ç©¶ç«Ÿæ˜¯ä»€ä¹ˆäº‹æƒ…å‘€ï¼Œå¿«ç‚¹è¯´è¯´å‘€ï¼ˆè‡­é±¼ï¼‰ã€‚<br>åœ¨è¯´å‡ºè¿™ä¸ªç§˜å¯†ä¹‹å‰ï¼Œæˆ‘ä»¬çœ‹çœ‹mapçš„context.write()è¿™ä¸ªæ–¹æ³•æ˜¯æ€ä¹ˆåšçš„å§ã€‚</p>
<p>MapTask.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(K key, V value)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">      collector.collect(key, value,</div><div class="line">                        partitioner.getPartition(key, value, partitions));</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>å…¶ä¸­partitioneræ˜¯åœ¨å“ªé‡Œå®šä¹‰çš„å‘¢ï¼Ÿ<br>åœ¨NewOutputCollectorç±»ä¸­ï¼Œè¯¥ç±»ä½œä¸ºMapTaskå†…éƒ¨ç±»ã€‚<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">NewOutputCollector</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt;</span></div><div class="line">    <span class="keyword">extends</span> <span class="title">org</span>.<span class="title">apache</span>.<span class="title">hadoop</span>.<span class="title">mapreduce</span>.<span class="title">RecordWriter</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; &#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MapOutputCollector&lt;K,V&gt; collector;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> org.apache.hadoop.mapreduce.Partitioner&lt;K,V&gt; partitioner;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> partitions;</div><div class="line"></div><div class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</div><div class="line">    NewOutputCollector(org.apache.hadoop.mapreduce.JobContext jobContext,</div><div class="line">                       JobConf job,</div><div class="line">                       TaskUmbilicalProtocol umbilical,</div><div class="line">                       TaskReporter reporter</div><div class="line">                       ) <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</div><div class="line">      collector = createSortingCollector(job, reporter);</div><div class="line">      partitions = jobContext.getNumReduceTasks();</div><div class="line">      <span class="keyword">if</span> (partitions &gt; <span class="number">1</span>) &#123;</div><div class="line">        partitioner = (org.apache.hadoop.mapreduce.Partitioner&lt;K,V&gt;)</div><div class="line">          ReflectionUtils.newInstance(jobContext.getPartitionerClass(), job);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        partitioner = <span class="keyword">new</span> org.apache.hadoop.mapreduce.Partitioner&lt;K,V&gt;() &#123;</div><div class="line">          <span class="meta">@Override</span></div><div class="line">          <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(K key, V value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> partitions - <span class="number">1</span>;</div><div class="line">          &#125;</div><div class="line">        &#125;;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    ...</div></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬æ¥çœ‹çœ‹æ„é€ å‡½æ•°ä¹‹ä¸­ï¼Œå¦‚æœpartitionså¤§äº1å°±ä»é…ç½®ä¸­è¯»å–æˆ‘ä»¬è‡ªå·±çš„Partitionerå¯¹è±¡å¹¶å®ä¾‹åŒ–ç»™å¼•ç”¨ï¼Œå¦åˆ™è‡ªå·±å°±åˆ›å»ºä¸€ä¸ªå®ä¾‹ã€‚<br>é‚£partitionsæ˜¯ä»jobContext.getNumReduceTasks();è¯»å–å‡ºæ¥çš„ï¼Œè¿™ä¸ªè¦æ€ä¹ˆé…ç½®å‘¢ï¼Ÿ</p>
<font color="DeepPink" size="3"><br>job.setNumReduceTasks(number);<br></font>

<p>é…ç½®è¯¥å€¼ä¹‹åï¼Œé‚£ä¹ˆå°±å¯ä»¥ä½¿ç”¨æˆ‘ä»¬è‡ªå·±å®šä¹‰çš„åˆ†åŒºå‡½æ•°äº†ã€‚<br>å¥½äº†ï¼Œæ–‡ç« åˆ°è¿™é‡Œä¹Ÿå°±ç»“æŸäº†ï¼Œæ¬¢è¿å¤§å®¶æ‹ç –ï¼ï¼ï¼</p>
<h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><p><a color="red" href="https://hadooptutorial.wikispaces.com/Custom+partitioner" target="_blank" rel="external"><br>å°±è¿™é‡Œçš„ä¾‹å­ï¼Œæ•°æ®è¿™é‡Œä¹Ÿæœ‰</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mapreduce join]]></title>
      <url>http://yoursite.com/2017/02/03/mapreduce-join/</url>
      <content type="html"><![CDATA[<p>å‰è¨€<br>æˆ‘ä»¬çŸ¥é“hiveï¼Œmysqlç­‰sqlè¯­è¨€éƒ½å¯ä»¥è¿›è¡Œjoinæ“ä½œã€‚é‚£ä¹ˆmapreduceæ˜¯å¦‚ä½•joinçš„å‘¢ï¼Ÿ<br>åœ¨è¯´æ˜mapreduceè¿›è¡Œjoinå¼€å§‹ï¼Œæˆ‘ä»¬æ¥å…ˆçœ‹çœ‹sqlçš„è¯­æ³•ã€‚</p>
<a id="more"></a>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>æˆ‘ä»¬çŸ¥é“hiveï¼Œmysqlç­‰sqlè¯­è¨€éƒ½å¯ä»¥è¿›è¡Œjoinæ“ä½œã€‚é‚£ä¹ˆmapreduceæ˜¯å¦‚ä½•joinçš„å‘¢ï¼Ÿ<br>åœ¨è¯´æ˜mapreduceè¿›è¡Œjoinå¼€å§‹ï¼Œæˆ‘ä»¬æ¥å…ˆçœ‹çœ‹sqlçš„è¯­æ³•ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> </div><div class="line">    tab1.*, </div><div class="line">    tab2.* </div><div class="line"><span class="keyword">FROM</span> </div><div class="line">    table1 tab1</div><div class="line"><span class="keyword">JOIN</span></div><div class="line">    table2 tb2 </div><div class="line">    <span class="keyword">on</span> tab1.id = tab2.id</div></pre></td></tr></table></figure>
<p>ä¸¤å¼ è¡¨å…³è”åœ¨ä¸€èµ·ï¼Œéœ€è¦ä»€ä¹ˆæ•°æ®ï¼Œå°±ä»ä¸åŒçš„è¡¨ä¸­å–å‡ºæ•°æ®å³å¯ã€‚</p>
<h3 id="mapreduceå¦‚ä½•JOIN"><a href="#mapreduceå¦‚ä½•JOIN" class="headerlink" title="mapreduceå¦‚ä½•JOIN"></a>mapreduceå¦‚ä½•JOIN</h3><p>é€šè¿‡å‰é¢çš„é“ºå«ï¼Œæˆ‘ä»¬çŸ¥é“sqlè¿›è¡Œè¡¨å…³è”æ˜¯å¤šä¹ˆçš„ç®€å•ã€‚é‚£ä¹ˆé€šè¿‡ç¨‹åºå¦‚ä½•è¿›è¡Œå…³è”å‘¢ï¼Ÿ<br>æˆ‘ä»¬hiveçš„æ•°æ®æ˜¯ä¸æ˜¯ä»HDFSä¸Šæ¥çš„ï¼ŒHDFSä¸Šæ˜¯ä¸æ˜¯æ–‡ä»¶æ•°æ®ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æŠŠè¡¨æ•°æ®çœ‹æˆæ˜¯ä¸€ä¸ªæ–‡ä»¶ã€‚<br>é‚£ä¹ˆä¸¤å¼ è¡¨å¯ä¸å¯ä»¥çœ‹æˆä¸¤ä¸ªæ–‡ä»¶ï¼Œhiveä¹Ÿæ˜¯æ‹¿åˆ°è¿™ä¸¤ä¸ªæ–‡ä»¶è¿›è¡Œå…³è”çš„ã€‚</p>
<p>ç°åœ¨å¦‚æœä¸ä½¿ç”¨MRè¿›è¡Œè®¡ç®—ï¼Œå†™ä¸€ä¸ªç¨‹åºæ¥è¿›è¡Œè¿æ¥å‘¢ï¼Ÿ<br>æ–‡ä»¶Aå‡è®¾1GBï¼Œæ–‡ä»¶B500MBã€‚<br>æ­¤æ—¶ï¼Œæˆ‘ä¹ˆå¯ä»¥æŠŠæ–‡ä»¶Bè¯»å…¥åˆ°å†…å­˜ä¹‹ä¸­ã€‚<br>æ–‡ä»¶Bçš„æ•°æ®ç»“æ„ï¼š<br>    <figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Map&lt;String, List&lt;String&gt;&gt;</div></pre></td></tr></table></figure></p>
<p>ç„¶åä¸€è¡Œä¸€è¡Œè¯»å–æ–‡ä»¶Açš„æ•°æ®ï¼Œåˆ¤æ–­keyæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨ï¼Œåˆ™æŠŠæ–‡ä»¶Açš„å€¼+Listçš„å€¼éå†è¾“å‡º<br>æ˜¯ä¸æ˜¯ä¹Ÿå¯ä»¥å¾—åˆ°å‘¢ã€‚</p>
<p>ä¸Šé¢çš„æ•°æ®å¯ä»¥æ”¾ç½®åœ¨å†…å­˜ä¸­ï¼Œæˆ‘è§‰å¾—æŒºåˆç†çš„ï¼Œåº”ä¸ºå•æœºèƒ½å¤„ç†çš„æ•°æ®è¡¨ç¤ºæ•°æ®é‡æ™®éä¸ç®—å¾ˆå¤§ã€‚<br>ä½†æ˜¯ï¼Œå¦‚æœè¯´ä½ ç°åœ¨çš„æ•°æ®æœ‰1Tå‘¢ï¼Ÿè¿˜æœ‰å¯èƒ½æ”¾ç½®åœ¨å†…å­˜ä¸­å—ï¼Ÿ</p>
<p>æˆ‘çœ‹è¿‡å¤§éƒ¨åˆ†åšå®¢å†…å®¹ï¼Œå¤§éƒ¨åˆ†éƒ½æ˜¯ç›¸åŒçš„å†™æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;Text&gt; values,</span></span></div><div class="line">                Reducer&lt;Text, Text, Text, Text&gt;.Context context)</div><div class="line">                <span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line"></div><div class="line">            LinkedList&lt;String&gt; linkU = <span class="keyword">new</span> LinkedList&lt;String&gt;();  <span class="comment">//userså€¼</span></div><div class="line">            LinkedList&lt;String&gt; linkL = <span class="keyword">new</span> LinkedList&lt;String&gt;();  <span class="comment">//login_logså€¼</span></div><div class="line">              </div><div class="line">            <span class="keyword">for</span> (Text tval : values) &#123;</div><div class="line">                String val = tval.toString();  </div><div class="line">                <span class="keyword">if</span>(val.startsWith(<span class="string">"u#"</span>)) &#123;</div><div class="line">                    linkU.add(val.substring(<span class="number">2</span>));</div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(val.startsWith(<span class="string">"l#"</span>)) &#123;</div><div class="line">                    linkL.add(val.substring(<span class="number">2</span>));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">              </div><div class="line">            <span class="keyword">for</span> (String u : linkU) &#123;</div><div class="line">                <span class="keyword">for</span> (String l : linkL) &#123;</div><div class="line">                    context.write(key, <span class="keyword">new</span> Text(u + DELIMITER + l));</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>è¿™ç§å†™æ³•å¯¹å—ï¼Œæ˜¯å¯¹çš„ã€‚ä½†æ˜¯æœ‰æ²¡æœ‰æ›´å¥½çš„ï¼Œæœ‰ã€‚ï¼ˆç¨åè®©ä½ çœ‹ï¼ŒğŸ˜ğŸ˜ğŸ˜ğŸ˜ï¼‰<br>ä½†æ˜¯ï¼Œæˆ‘ä¹ˆé€šå¸¸ä¹Ÿä¼šé‡åˆ°æ•°æ®å€¾æ–œçš„é—®é¢˜ï¼Œå¯èƒ½æ˜¯æŸä¸€ç»„å€¼ç‰¹åˆ«çš„å¤§ï¼Œé‚£ä¹ˆå¦‚æœåœ¨JOINçš„æ—¶å€™<br>ä¹Ÿé‡åˆ°äº†ç‰¹åˆ«å¤šç›¸åŒçš„keyå€¼ï¼Œé‚£ä¹ˆå†…å­˜è¿˜æ”¾å¾—ä¸‹å—ï¼Ÿ<br>ä¸è¿‡è¿™ä½ä½¿ç”¨LinkedListä¹Ÿæ˜¯éå¸¸ä¸é”™çš„ï¼Œæ’å…¥åˆ é™¤é€Ÿåº¦ä¹Ÿæ˜¯ä¼˜äºArrayListï¼ˆç‚¹ä¸ªèµï¼‰ã€‚</p>
<p>å¥½äº†ï¼Œè¯´äº†è¿™ä¹ˆå¤šã€‚ä½ çœŸçš„èƒ½æ¯”è¿™äº›äººçš„å†…å®¹å†™çš„å¥½çš„å—ï¼Ÿä¸ä¼šå†å¹ç‰›å§ï¼ˆå°´å°¬è¡¨æƒ…ï¼‰</p>
<p>æ¥è¯´è¯´æˆ‘å¦‚ä½•å»åšã€‚<br>è‡ªå®šä¹‰keyå€¼ä¹‹åï¼Œç”±äºæˆ‘ä¸æ˜¯æ”¾å…¥å†…å­˜çš„ï¼Œæ‰€ä»¥å­—æ®µè¾“å‡ºçš„é¡ºåºå¯èƒ½æ˜¯æœ‰ç‚¹é—®é¢˜çš„<br>æ‰€ä»¥è¿˜è¦è¿›è¡ŒäºŒæ¬¡æ’åºï¼Œåˆ°reduceçš„æ—¶å€™ä¸€ç»„æ•°æ®å·²ç»åœ¨ä¸€èµ·äº†ï¼Œæˆ‘ä¹ˆè®¾ç½®ä¸€ä¸ªbooleanå€¼<br>åœ¨ç¬¬ä¸€æ¬¡éå†å€¼çš„æ—¶å€™ä¸å†™å…¥æ–‡ä»¶ä¸­ï¼Œè€Œæ˜¯è®°å½•åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åç¬¬äºŒæ¬¡booleanæ›´æ”¹å<br>æŠŠä¸Šä¸€æ¬¡å’Œè¿™ä¸€æ¬¡çš„å€¼ä¸€èµ·å†™å…¥ã€‚</p>
<p>æ¥çœ‹çœ‹ä»£ç å§ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Pair</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">Pair</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Text first;</div><div class="line">    <span class="keyword">private</span> Text second;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(String first, String second)</span> </span>&#123;</div><div class="line">        set(<span class="keyword">new</span> Text(first), <span class="keyword">new</span> Text(second));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">()</span> </span>&#123;</div><div class="line">        set(<span class="keyword">new</span> Text(), <span class="keyword">new</span> Text());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(Text first, String second)</span> </span>&#123;</div><div class="line">        set(first, <span class="keyword">new</span> Text(second));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Pair</span><span class="params">(String first, Text second)</span> </span>&#123;</div><div class="line">        set(<span class="keyword">new</span> Text(first), second);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">set</span><span class="params">(Text first, Text second)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.first = first;</div><div class="line">        <span class="keyword">this</span>.second = second;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Text <span class="title">getFirst</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> first;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> Text <span class="title">getSecond</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> second;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput out)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        first.write(out);</div><div class="line">        second.write(out);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput in)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">        first.readFields(in);</div><div class="line">        second.readFields(in);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> first.hashCode() * <span class="number">163</span> + second.hashCode();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object obj)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> Pair) &#123;</div><div class="line">            Pair pair = (Pair) obj;</div><div class="line">            <span class="keyword">return</span> first.equals(pair.first) &amp;&amp; second.equals(pair.second);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.first.toString();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Pair pair)</span> </span>&#123;</div><div class="line">        <span class="comment">// int cmp = first.compareTo(pair.first);</span></div><div class="line">        <span class="keyword">int</span> cmp = pair.first.compareTo(first);</div><div class="line">        <span class="keyword">if</span> (cmp != <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> cmp;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// return second.compareTo(pair.second);</span></div><div class="line">        <span class="keyword">return</span> pair.second.compareTo(second);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Pair pair, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (index == <span class="number">1</span>) &#123;</div><div class="line"><span class="comment">//            return this.first.compareTo(pair.first);</span></div><div class="line">            <span class="keyword">return</span> pair.first.compareTo(<span class="keyword">this</span>.first);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line"><span class="comment">//            return this.second.compareTo(pair.second);</span></div><div class="line">            <span class="keyword">return</span> pair.second.compareTo(<span class="keyword">this</span>.second);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LJoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Pair</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Text key = <span class="keyword">new</span> Text();</div><div class="line">    <span class="keyword">private</span> Text val = <span class="keyword">new</span> Text();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object line, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">        String[] tokens = value.toString().split(<span class="string">","</span>);</div><div class="line">        <span class="keyword">if</span> (tokens.length &lt; <span class="number">3</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// key</span></div><div class="line">        String k = tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">1</span>];</div><div class="line">        </div><div class="line">        Pair pair = <span class="keyword">new</span> Pair(k, <span class="string">"0"</span>);</div><div class="line"></div><div class="line">        <span class="comment">// val</span></div><div class="line"><span class="comment">//        String v = "left" + "," + tokens[2];</span></div><div class="line">         String v = tokens[<span class="number">2</span>];</div><div class="line"><span class="comment">//        key.set(k);</span></div><div class="line">        val.set(v);</div><div class="line"><span class="comment">//        context.write(key, val);</span></div><div class="line">        context.write(pair, val);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RJoinMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Pair</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line"><span class="comment">//    private Text key = new Text();</span></div><div class="line">    <span class="keyword">private</span> Text val = <span class="keyword">new</span> Text();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object line, Text value, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">        String[] tokens = value.toString().split(<span class="string">","</span>);</div><div class="line">        <span class="keyword">if</span> (tokens.length &lt; <span class="number">5</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// key</span></div><div class="line">        String k = tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">1</span>];</div><div class="line">        </div><div class="line">        Pair pair = <span class="keyword">new</span> Pair(k, <span class="string">"1"</span>);</div><div class="line">        </div><div class="line">        <span class="comment">// val</span></div><div class="line"><span class="comment">//        String v = "right" + "," + tokens[2] + "," + tokens[3] + "," + tokens[4];</span></div><div class="line">      String v = tokens[<span class="number">2</span>] + <span class="string">","</span> + tokens[<span class="number">3</span>] + <span class="string">","</span> + tokens[<span class="number">4</span>];</div><div class="line"><span class="comment">//        key.set(k);</span></div><div class="line">        val.set(v);</div><div class="line"><span class="comment">//        context.write(key, val);</span></div><div class="line">        context.write(pair, val);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Pair</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Text val = <span class="keyword">new</span> Text();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Pair key, Iterable&lt;Text&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line"></div><div class="line">        String deptName = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">boolean</span> set = <span class="keyword">false</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">for</span> (Text v : values) &#123;</div><div class="line">            </div><div class="line">            String[] vs = v.toString().split(<span class="string">","</span>);</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (!set) &#123;</div><div class="line">                deptName = v.toString();</div><div class="line">                set = <span class="keyword">true</span>;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                System.out.println(key.toString() + <span class="string">","</span> + deptName + <span class="string">","</span> + v);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOINGroup</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JOINGroup</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Pair.class, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</div><div class="line">        Pair keyA = (Pair) a;</div><div class="line">        Pair keyB = (Pair) b;</div><div class="line"><span class="comment">//        return keyA.compareTo(keyB, 1);</span></div><div class="line">        <span class="keyword">return</span> keyB.compareTo(keyA, <span class="number">1</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOINPartition</span> <span class="keyword">extends</span> <span class="title">Partitioner</span>&lt;<span class="title">Pair</span>, <span class="title">Text</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(Pair key, Text value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (key.getFirst().hashCode() % numPartitions);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JOINSort</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JOINSort</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(Pair.class, <span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</div><div class="line">        Pair compositeKey1 = (Pair) a;</div><div class="line">        Pair compositeKey2 = (Pair) b;</div><div class="line">        <span class="keyword">return</span> compositeKey2.compareTo(compositeKey1);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Dirver</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (args.length != <span class="number">3</span>) &#123;</div><div class="line">            System.out.printf(<span class="string">"Usage: %s [generic options] &lt;input dir&gt; &lt;output dir&gt;\n"</span>, getClass().getSimpleName());</div><div class="line">            ToolRunner.printGenericCommandUsage(System.out);</div><div class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">        Job job = Job.getInstance(conf, <span class="string">"join"</span>);</div><div class="line">        job.setJarByClass(getClass());</div><div class="line"></div><div class="line">        MultipleInputs.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">0</span>]), TextInputFormat.class, LJoinMapper.class);</div><div class="line">        MultipleInputs.addInputPath(job, <span class="keyword">new</span> Path(args[<span class="number">1</span>]), TextInputFormat.class, RJoinMapper.class);</div><div class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> Path(args[<span class="number">2</span>]));</div><div class="line"></div><div class="line">        job.setReducerClass(JoinReducer.class);</div><div class="line">        </div><div class="line">        job.setGroupingComparatorClass(JOINGroup.class);</div><div class="line">        job.setPartitionerClass(JOINPartition.class);</div><div class="line">        job.setSortComparatorClass(JOINSort.class);</div><div class="line">        </div><div class="line">        job.setMapOutputKeyClass(Pair.class);</div><div class="line">        job.setMapOutputValueClass(Text.class);</div><div class="line"></div><div class="line">        job.setOutputKeyClass(NullWritable.class);</div><div class="line">        job.setOutputValueClass(Text.class);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            args = <span class="keyword">new</span> String[] &#123;<span class="string">"in/l"</span>, <span class="string">"in/r"</span>, <span class="string">"ljoinout"</span>&#125;;</div><div class="line">            ToolRunner.run(<span class="keyword">new</span> Configuration(), <span class="keyword">new</span> Dirver(), args);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>æµ‹è¯•æ•°æ®:</p>
<p>l.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">1,job,beijing</div><div class="line">2,jue,shanghai</div><div class="line">3,role,shenzhen</div><div class="line">4,jie,guangzhou</div></pre></td></tr></table></figure></p>
<p>r.txt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1,job,30,man,333330000</div><div class="line">2,jue,90,woman,9384832</div><div class="line">3,role,100,man,9103841038</div><div class="line">4,jie,0,man,103848103474</div><div class="line">1,job,20,man,333330000</div><div class="line">1,job,10,man,333330000</div></pre></td></tr></table></figure></p>
<p>ä»¥ä¸‹æ˜¯è¾“å‡ºç»“æœï¼š<br><img src="https://github.com/basebase/img_server/blob/master/mapreduce-join/join-01.png?raw=true" alt="join"></p>
<font color="DeepPink" size="2"><br>ä»¥ä¸Šç¨‹åºä½œä¸ºå†…è”å±•ç¤ºç»™äº†å¤§å®¶ï¼Œå¦‚æœå¯¹æ–‡ç« å†…å®¹æœ‰ç–‘é—®ï¼Œæˆ–è€…æœ‰æ›´å¥½çš„å»ºè®®ï¼Œåˆæˆ–è€…æœ‰åœŸè±ªæ‰“èµ<br>éƒ½ä¸è¦åå•¬ã€‚è°¢è°¢ï¼<br></font>


<h3 id="è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥"><a href="#è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥" class="headerlink" title="è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥"></a>è¿˜ä¸é”™çš„æ–‡ç« é“¾æ¥</h3><p><a href="http://codingjunkie.net/mapreduce-reduce-joins/" target="_blank" rel="external">http://codingjunkie.net/mapreduce-reduce-joins/</a><br><a href="https://www.safaribooksonline.com/library/view/data-algorithms/9781491906170/ch01.html" target="_blank" rel="external">https://www.safaribooksonline.com/library/view/data-algorithms/9781491906170/ch01.html</a><br><a href="https://chamibuddhika.wordpress.com/2012/02/26/joins-with-map-reduce/" target="_blank" rel="external">https://chamibuddhika.wordpress.com/2012/02/26/joins-with-map-reduce/</a></p>
<p>æ–¹ä¾¿åäººï¼Œæ–¹ä¾¿è‡ªå·±ï¼ï¼ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[eclipseé…ç½®è¿è¡ŒHDFS]]></title>
      <url>http://yoursite.com/2017/01/23/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/</url>
      <content type="html"><![CDATA[<p>å‰è¨€<br>é€šå¸¸æˆ‘ä»¬åœ¨è¿è¡ŒHDFSéƒ½æ˜¯ç¼–è¯‘æºç å¹¶é…ç½®Hadoopç¯å¢ƒå˜é‡ï¼Œç„¶åè¿›å…¥sbinç›®å½•ä¸­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">start-dfs.sh</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>é€šå¸¸æˆ‘ä»¬åœ¨è¿è¡ŒHDFSéƒ½æ˜¯ç¼–è¯‘æºç å¹¶é…ç½®Hadoopç¯å¢ƒå˜é‡ï¼Œç„¶åè¿›å…¥sbinç›®å½•ä¸­<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">start-dfs.sh</div></pre></td></tr></table></figure></p>
<p>ç”¨æ¥å¯åŠ¨hdfsçš„ï¼Œå¦‚æœæƒ³è¦çœ‹çœ‹NameNodeçš„å¯åŠ¨æ˜¯ä¸æ˜¯éœ€è¦é…ç½®è¿œç¨‹è°ƒè¯•äº†ã€‚ï¼ˆæˆ‘ä»¥å‰å¼„è¿‡ï¼Œä½†æ˜¯ä¹‹å‰æ²¡æœ‰å†™è¿‡åšå®¢ï¼‰ã€‚</p>
<p>å¦‚æœå¯ä»¥åœ¨æœ¬åœ°å°±å¯ä»¥è°ƒè¯•è¿™äº›å†…å®¹æ˜¯ä¸æ˜¯æ›´èƒ½äº†è§£å†…éƒ¨æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><p>éœ€è¦å‡†å¤‡ä»€ä¹ˆä¸œä¸œå‘¢ï¼Ÿ<br>hadoopæºç ï¼ˆæˆ‘ç”¨çš„æ˜¯2.7.0ï¼Œä½ ä»¬éšæ„ï¼‰<br>IDEAæˆ–è€…eclipseç­‰ç­‰ç”¨æ¥å¯¼å…¥æºç ï¼Œæ–¹ä¾¿é˜…è¯»ã€‚</p>
<p>å‡è®¾ä»¥ä¸Šå†…å®¹å·²ç»é½å…¨ï¼Œç°åœ¨å¼€å§‹è¿›å…¥ä¸»é¢˜ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mvn install -DskipTests</div><div class="line">mvn eclipse:eclipse -DdownloadSources=<span class="literal">true</span> -DdownloadJavadocs=<span class="literal">true</span></div></pre></td></tr></table></figure>
<p>å¯¼å…¥ä¹‹åï¼Œæ‰¾åˆ°hdfsé¡¹ç›®çš„NameNodeå’ŒDataNodeè¿è¡Œå³å¯ã€‚<br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/01.png?raw=true" alt="é¡¹ç›®å›¾"><br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/02.png?raw=true" alt="NN"><br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/03.png?raw=true" alt="DT"></p>
<p>ä½ ä»¥ä¸ºè¿™å°±ç»“æŸäº†ï¼Ÿï¼Ÿï¼Ÿ</p>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘æ¥è¯´è¯´åœ¨éƒ¨ç½²å’Œå¯åŠ¨é‡åˆ°çš„é—®é¢˜å§ã€‚</p>
<p>1ã€webapps/hdfs not found in CLASSPATH<br>å‡ºç°è¿™ä¸ªå¼‚å¸¸æ˜¯åœ¨å¯åŠ¨NameNodeçš„æ—¶å€™å‡ºç°çš„ï¼Œä¸‹é¢æ˜¯å…·ä½“æŠ›å‡ºå¼‚å¸¸çš„ä»£ç (hadoop-commoné¡¹ç›®httpåŒ…ä¸‹çš„HttpServer2)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">getWebAppsPath</span><span class="params">(String appName)</span> <span class="keyword">throws</span> FileNotFoundException </span>&#123;</div><div class="line">   URL url = getClass().getClassLoader().getResource(<span class="string">"webapps/"</span> + appName);</div><div class="line">   <span class="keyword">if</span> (url == <span class="keyword">null</span>)</div><div class="line">     <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">"webapps/"</span> + appName</div><div class="line">         + <span class="string">" not found in CLASSPATH"</span>);</div><div class="line">   String urlString = url.toString();</div><div class="line">   <span class="keyword">return</span> urlString.substring(<span class="number">0</span>, urlString.lastIndexOf(<span class="string">'/'</span>));</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>å½“æˆ‘debugçš„æ—¶å€™ï¼Œä»–ä¸€ç›´æ‰¾æˆ‘çš„hadoop-commonçš„jarçš„webappä¸­çš„hdfsç›®å½•ï¼Œæ‰€ä»¥å¯¼è‡´æˆ‘ä¸€ç›´å‡ºç°<br>æ‰¾ä¸åˆ°çš„å¼‚å¸¸ï¼Œåæ¥æˆ‘é‡å†™ä¸€ä¸ªè¯¥ç±»æŒ‡å®šhdfsé¡¹ç›®çš„è·¯å¾„è§£å†³å¯ä»¥è¿è¡Œï¼ˆå¦‚æœè¿˜æœ‰å…¶ä»–çš„è§£å†³æ–¹æ¡ˆè¯·åœ¨è¯„è®ºä¸‹æ–¹è¯´æ˜ä¸€ä¸‹ï¼Œä¸‡åˆ†æ„Ÿè°¢!ï¼‰, è¿˜æœ‰ä¸ªdatanodeç›®å½•æ²¡æœ‰æ‰¾åˆ°çš„å¼‚å¸¸æ˜¯åœ¨è¿è¡ŒDataNodeå‡ºç°çš„<br>å…·ä½“å‡ºç°çš„ä½ç½®æˆ‘ç»™å¿˜è®°äº†ï¼ŒğŸ˜ğŸ˜ğŸ˜ğŸ˜</p>
<p>2ã€Exception in thread â€œmainâ€ java.lang.IllegalArgumentException: Invalid URI for NameNode address (check fs.defaultFS): file:/// has no authority.</p>
<p>å‡ºç°æ­¤å¼‚å¸¸é¦–å…ˆå»stackoverflowæ‰¾äº†ä¸‹ç­”æ¡ˆï¼Œå¦‚ä¸‹ï¼š<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></div><div class="line"> <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>fs.defaultFS<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://10.100.20.168/<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>ä½†æ˜¯å¯¹æˆ‘æ˜¯æ— æ•ˆçš„ï¼Œåæ¥çŸ¥é“åŸå› æˆ‘ä½¿ç”¨çš„æ˜¯core-default.xmlçš„é…ç½®æ²¡æœ‰ç”Ÿæ•ˆã€‚<br>ä½†æ˜¯ä¸€å¼€å§‹æˆ‘å°±æ˜¯defualtçš„é…ç½®ä¹Ÿèƒ½æ­£å¸¸è¿è¡Œã€‚ã€‚ã€‚ï¼ˆå¥‡æ€ªçš„é—®é¢˜ï¼‰</p>
<p>å¦‚ä¸‹ä»£ç æ˜¯æŠ›å‡ºå¼‚å¸¸çš„ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InetSocketAddress <span class="title">getAddress</span><span class="params">(URI filesystemURI)</span> </span>&#123;</div><div class="line">    String authority = filesystemURI.getAuthority();</div><div class="line">    <span class="keyword">if</span> (authority == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</div><div class="line">          <span class="string">"Invalid URI for NameNode address (check %s): %s has no authority."</span>,</div><div class="line">          FileSystem.FS_DEFAULT_NAME_KEY, filesystemURI.toString()));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (!HdfsConstants.HDFS_URI_SCHEME.equalsIgnoreCase(</div><div class="line">        filesystemURI.getScheme())) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(</div><div class="line">          <span class="string">"Invalid URI for NameNode address (check %s): %s is not of scheme '%s'."</span>,</div><div class="line">          FileSystem.FS_DEFAULT_NAME_KEY, filesystemURI.toString(),</div><div class="line">          HdfsConstants.HDFS_URI_SCHEME));</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> getAddress(authority);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>è‡³äºä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Œåœ¨FileSystemç±»ä¸­æœ‰è¿™ä¹ˆä¸€æ®µ<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FS_DEFAULT_NAME_KEY = </div><div class="line">                   CommonConfigurationKeys.FS_DEFAULT_NAME_KEY;</div><div class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_FS = </div><div class="line">                   CommonConfigurationKeys.FS_DEFAULT_NAME_DEFAULT;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line">    // CommonConfigura.java</div><div class="line">    public static final String  FS_DEFAULT_NAME_KEY = "fs.defaultFS";</div><div class="line">    public static final String  FS_DEFAULT_NAME_DEFAULT = "file:///";</div><div class="line"></div><div class="line">*/</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> URI <span class="title">getDefaultUri</span><span class="params">(Configuration conf)</span> </span>&#123;</div><div class="line">    <span class="comment">// è¿™é‡Œå°±æ˜¯åˆ›å»ºURIå¯¹è±¡, å„ä½å¯ä»¥å•ç‹¬å†™ä¸ªTestæ¥çœ‹çœ‹åˆ›å»ºçš„å¯¹è±¡æ•°æ®ã€‚</span></div><div class="line">    <span class="comment">// URI uri = new URI("file:///");</span></div><div class="line">    <span class="keyword">return</span> URI.create(fixName(conf.get(FS_DEFAULT_NAME_KEY, DEFAULT_FS)));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>è‡³æ­¤ï¼Œæˆ‘è¿™é‡Œå°±æŠŠæˆ‘é‡åˆ°çš„é—®é¢˜å…¨éƒ¨è¯´å®Œäº†ã€‚</p>
<p>æœ€åï¼Œåœ¨ç»™å¤§å®¶æ¼”ç¤ºä¸€ä¸‹ï¼Œæˆ‘è¿è¡Œhadoop fs -put localPath hdfsPathæ˜¯å¦‚ä½•æ–­ç‚¹çš„ã€‚<br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/04.png?raw=true" alt="put"><br><img src="https://github.com/basebase/img_server/blob/master/eclipse%E9%85%8D%E7%BD%AE%E8%BF%90%E8%A1%8CHDFS/05.png?raw=true" alt="put-d"></p>
<h3 id="é“¾æ¥"><a href="#é“¾æ¥" class="headerlink" title="é“¾æ¥"></a>é“¾æ¥</h3><p><a href="https://wiki.apache.org/hadoop/EclipseEnvironment" target="_blank" rel="external">https://wiki.apache.org/hadoop/EclipseEnvironment</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[javaè‡ªæ—‹é”]]></title>
      <url>http://yoursite.com/2016/11/14/java%E8%87%AA%E6%97%8B%E9%94%81/</url>
      <content type="html"><![CDATA[<p>æ­¤æ–‡ç« ä¸æ¶‰åŠä¸äº’æ–¥é”ç­‰æ¯”æ¯”è¾ƒï¼Œåªæ˜¯å•çº¯çš„ä»‹ç»ä¸€ä¸ªè‡ªæ—‹é”ï¼Œå¦‚æœæƒ³è¦äº†è§£æ›´å¤šå¯ä»¥ç‚¹å‡»å‚è€ƒé“¾æ¥<br><a id="more"></a></p>
<h3 id="ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­"><a href="#ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­" class="headerlink" title="ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­"></a>ä¸€ä¸ªè‡ªæ—‹é”ä¾‹å­</h3><p>è‡ªæ—‹é”çš„ä»‹ç»åŸç†ç­‰è¿‡ç¨‹æˆ‘å°±ä¸åœ¨æ­¤ä»‹ç»äº†ï¼Œä¸‹é¢çš„å‚è€ƒå·²ç»å†™çš„éå¸¸ä¸é”™äº†ï¼</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="comment">/***</span></div><div class="line"> * è‡ªæ—‹é”</div><div class="line"> * <span class="doctag">@author</span> Joker</div><div class="line"> *</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinLock</span> </span>&#123;</div><div class="line">	</div><div class="line">	AtomicReference&lt;Thread&gt; owner = <span class="keyword">new</span> AtomicReference&lt;Thread&gt;();</div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> count ;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">lock</span><span class="params">()</span> </span>&#123;</div><div class="line">		Thread currentThread = Thread.currentThread();</div><div class="line">		System.out.println(<span class="string">"lock() -&gt; "</span> + currentThread.getName());</div><div class="line">		<span class="keyword">if</span> (currentThread == owner.get()) &#123;</div><div class="line">			count++; <span class="comment">// è·å–é”çš„æ¬¡æ•°</span></div><div class="line">			<span class="keyword">return</span> ;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="comment">// å½“çº¿ç¨‹è¶Šæ¥è¶Šå¤šç”±äºwhileå¾ªç¯ä¼šæµªè´¹cpuæ—¶é—´ç‰‡ï¼ŒcompareAndSetéœ€è¦å¤šæ¬¡å¯¹åŒä¸€å†…å­˜è¿›è¡Œè®¿é—®</span></div><div class="line">		<span class="keyword">while</span> (!owner.compareAndSet(<span class="keyword">null</span>, currentThread)) &#123;</div><div class="line">			</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unLock</span><span class="params">()</span> </span>&#123;</div><div class="line">		Thread currentThread = Thread.currentThread();</div><div class="line">		System.out.println(<span class="string">"unLock() -&gt; "</span> + currentThread.getName());</div><div class="line">		<span class="keyword">if</span> (currentThread == owner.get()) &#123;</div><div class="line">			<span class="keyword">if</span> (count &gt; <span class="number">0</span>) &#123;</div><div class="line">				count--;</div><div class="line">			&#125; <span class="keyword">else</span> &#123;</div><div class="line">				owner.compareAndSet(currentThread, <span class="keyword">null</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpinLockTest</span> <span class="keyword">implements</span> <span class="title">Runnable</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="keyword">int</span> sum ;</div><div class="line">	<span class="keyword">private</span> SpinLock lock;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">SpinLockTest</span><span class="params">(SpinLock lock)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.lock = lock;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.lock.lock();</div><div class="line">		<span class="keyword">this</span>.lock.lock();</div><div class="line">		System.out.println(<span class="string">"å½“å‰çº¿ç¨‹ "</span> + Thread.currentThread().getName() + <span class="string">" start..."</span>);</div><div class="line">		sum++;</div><div class="line">		System.out.println(<span class="string">"å½“å‰çº¿ç¨‹ "</span> + Thread.currentThread().getName() + <span class="string">" end..."</span>);</div><div class="line">		</div><div class="line">		<span class="keyword">this</span>.lock.unLock();</div><div class="line">		<span class="keyword">this</span>.lock.unLock();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		SpinLock lock = <span class="keyword">new</span> SpinLock();</div><div class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; <span class="number">5</span>; i++) &#123;</div><div class="line">			SpinLockTest lockTest = <span class="keyword">new</span> SpinLockTest(lock);</div><div class="line">			Thread t = <span class="keyword">new</span> Thread(lockTest, <span class="string">"thread-lock-"</span>+i);</div><div class="line">			t.start();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		Thread.sleep(<span class="number">1000</span>);</div><div class="line">		System.out.println(sum);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æœ€åé™„ä¸Šä¸€å¼ æˆ‘è‡ªå·±ç”»çš„ä¸€å¼ è¿è¡Œå›¾</p>
<p><img src="https://github.com/basebase/img_server/blob/master/java%E8%87%AA%E6%97%8B%E9%94%81/java%E8%87%AA%E6%97%8B%E9%94%81.png?raw=true" alt="javaè‡ªæ—‹é”"></p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://www.cnblogs.com/cposture/p/SpinLock.html#_label0" target="_blank" rel="external">http://www.cnblogs.com/cposture/p/SpinLock.html#_label0</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[java finalizeæ–¹æ³•]]></title>
      <url>http://yoursite.com/2016/08/27/java-finalize%E6%96%B9%E6%B3%95/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?<br>è¦è¯´finalizeæ–¹æ³•æˆ‘æƒ³åšjavaçš„éƒ½çŸ¥é“ï¼Œé‚£ä¹ˆfinalizeæ–¹æ³•ä¼šä¸ä¼šæ‰§è¡Œï¼Œå¦‚æœä¼šä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿå¦‚æœé‡å†™finalizeæ–¹æ³•åˆæœ‰ä»€ä¹ˆä¸¥é‡çš„åæœ? </p>
<a id="more"></a>
<h3 id="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« "><a href="#ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« " class="headerlink" title="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?"></a>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?</h3><p>è¦è¯´finalizeæ–¹æ³•æˆ‘æƒ³åšjavaçš„éƒ½çŸ¥é“ï¼Œé‚£ä¹ˆfinalizeæ–¹æ³•ä¼šä¸ä¼šæ‰§è¡Œï¼Œå¦‚æœä¼šä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿå¦‚æœé‡å†™finalizeæ–¹æ³•åˆæœ‰ä»€ä¹ˆä¸¥é‡çš„åæœ? </p>
<p>é¢˜å¤–è¯ï¼šä»¥å‰çœ‹Java GCç›¸å…³å†…å®¹ä¸»è¦ä¸ºçš„æ˜¯åº”ä»˜é¢è¯•è€Œå·²ï¼Œä¸è¿‡æœ€è¿‘æœ‰ä¸ªåŒäº‹æäº†ä¸ªé—®é¢˜(é—®é¢˜ä½ ä¹ˆå…ˆYY)ï¼Œä½†ä»–åªè¯´äº†å¯¹è±¡ä¼šè¢«å›æ”¶ï¼Œå…·ä½“ç»†èŠ‚å¹¶æ²¡æœ‰è¯´å‡ºï¼Œè¿›è€Œå¼•å‘æˆ‘å†æ¬¡æ¢ç©¶GC<br>ä¼°è®¡ä¸‹æ¬¡ä¼šä»¥æ­¤é—®é¢˜å±•å¼€è®¨è®ºï¼Œç”±äºæˆ‘ä¹Ÿæ˜¯ä¸ªèœé¸Ÿéœ€è¦å¤§å®¶æŒ‡å‡ºæ–‡ç« ä¸­çš„ä¸è¶³ï¼Œè°¢è°¢ï¼</p>
<h3 id="Java-finalizeæ–¹æ³•"><a href="#Java-finalizeæ–¹æ³•" class="headerlink" title="Java finalizeæ–¹æ³•"></a>Java finalizeæ–¹æ³•</h3><p>finalizeæ–¹æ³•æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œä»»ä½•ç±»éƒ½æ˜¯é‡å†™finalizeæ–¹æ³•ï¼Œå®ç°è‡ªå·±æƒ³è¦çš„åŠŸèƒ½ã€‚<br>é»˜è®¤çš„finalizeæ–¹æ³•ä»€ä¹ˆä¹Ÿæ²¡åš</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123; &#125;</div></pre></td></tr></table></figure>
<p>ä½†æ˜¯ä¸€èˆ¬éƒ½ä¸å»ºè®®è‡ªå·±é‡å†™finalizeæ–¹æ³•ï¼Œç”±äºåœ¨æ¸…ç†å¯¹è±¡æ—¶å€™æ— æ³•ä¿è¯finalizeæ–¹æ³•ä¸€å®šä¼šè¢«æ‰§è¡Œã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸€æ®µå°ç¨‹åºéå¸¸çš„ç®€å•ï¼Œå°±æ˜¯æ‰“å°ä¸€å¥è¯ï¼Œç„¶åç¨‹åºå°±ç»“æŸäº†ã€‚<br>é‚£ä¹ˆï¼Œå¯¹è±¡ä¼šè¢«å›æ”¶å—ï¼Ÿ</p>
<p>ä»€ä¹ˆæ—¶å€™æ‰§è¡ŒGCæˆ‘ä¹ˆæ˜¯ä¸æ¸…æ¥šçš„ï¼Œæ ¹æ®ä¸åŒçš„ç®—æ³•æœ‰ä¸åŒçš„è°ƒåº¦ï¼Œæœ‰çš„æ˜¯æ ¹æ®æ—¶é—´è°ƒåº¦ï¼Œæœ‰çš„æ˜¯æ ¹æ®<br>å†…å­˜ä½¿ç”¨çš„æƒ…å†µè¿›è¡Œè°ƒåº¦ã€‚</p>
<p>ä¸è¿‡è®©æˆ‘æ¥åšçš„è¯ï¼Œæˆ‘æ›´å€¾å‘äºåè€…ï¼Œä¸ç®¡è¿è¡Œå¤šé•¿æ—¶é—´åªè¦å†…å­˜æ²¡åˆ°æˆ‘æŒ‡å®šçš„é˜ˆå€¼å¤§å°æˆ‘å°±ä¸æ‰§è¡Œï¼Œ<br>ç°åœ¨çš„è¿™ä¸ªæƒ³æ³•æ¥æºhadoopçš„spillï¼Œå‡è®¾æœ‰100mçš„å†…å­˜ä½¿ç”¨ä½†æ˜¯åªè¦è¾¾åˆ°ä¸Šé™80mçš„å†…å­˜ç”¨é‡ï¼Œ<br>é‚£ä¹ˆæˆ‘å°±å¼€å§‹æ‰§è¡ŒGCã€‚ã€åªæ˜¯æˆ‘çš„æƒ³æ³•ï¼Œå“ˆå“ˆ~ã€‘</p>
<p>é‚£å¥½ï¼Œæ— è®ºæ˜¯æ ¹æ®æ—¶é—´åˆæˆ–è€…æ˜¯å†…å­˜å¤§å°è¿›è¡ŒGCï¼Œä½†æ˜¯æˆ‘ä¹ˆå°±ä¸€æ®µè¾“å‡ºä»£ç ï¼Œç¨‹åºç»“æŸäº†ä¼°è®¡ä¹Ÿä¸ä¼š<br>æ‰§è¡ŒGCçº¿ç¨‹è¿›è¡Œæ¸…ç†å§ï¼</p>
<p>æ²¡æœ‰æ‰§è¡ŒGCä¹Ÿå°±æ˜¯æ— æ³•æ‰§è¡Œåˆ°finalizeæ–¹æ³•äº†ã€‚</p>
<p>é‚£ä¹ˆï¼Œæœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥æ‰§è¡Œgcå‘¢ï¼Ÿæ–¹æ³•æ˜¯æœ‰çš„ï¼Œä½†æ˜¯ä¹Ÿä¸èƒ½ä¿è¯ä¸€å®šä¼šæ‰§è¡Œgcï¼Œåªèƒ½è¯´ä¼šå‚¬ä¿ƒè¿›è€Œæ‰§è¡Œ<br>GCã€‚</p>
<p>è¿™ä¹Ÿå°±æ˜¯æˆ‘ä¹ˆå¸¸è¯´çš„<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">System.gc()</div></pre></td></tr></table></figure></p>
<p>å½“ç„¶è¿˜å­˜åœ¨å…¶å®ƒæ–¹æ³•ï¼Œåœ¨æœ€åæˆ‘ä¼šå°†æˆ‘å‚è€ƒé“¾æ¥å‘å‡ºã€‚<br>é‚£ä¹ˆï¼Œä»€ä¹ˆæ ·çš„å¯¹è±¡ä¼šè¢«æ‰§è¡Œfinalizeæ–¹æ³•å‘¢ï¼Ÿfinalizeæ–¹æ³•åˆä¼šè¢«æ‰§è¡Œå¤šå°‘æ¬¡å‘¢ï¼Ÿ</p>
<h3 id="å¯¹è±¡é”€æ¯è¿‡ç¨‹"><a href="#å¯¹è±¡é”€æ¯è¿‡ç¨‹" class="headerlink" title="å¯¹è±¡é”€æ¯è¿‡ç¨‹"></a>å¯¹è±¡é”€æ¯è¿‡ç¨‹</h3><p>å¯¹è±¡çš„é”€æ¯è¿‡ç¨‹ä¸­ï¼ŒæŒ‰ç…§å¯¹è±¡çš„finalizeæ‰§è¡Œæƒ…å†µï¼Œå¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ç§ï¼Œç³»ç»Ÿä¼šè®°å½•å¯¹è±¡çš„<br>å¯¹åº”çŠ¶æ€ã€‚</p>
<p>1ã€unfinalized æ²¡æœ‰æ‰§è¡Œfinalizeï¼Œç³»ç»Ÿä¹Ÿä¸å‡†å¤‡æ‰§è¡Œã€‚<br>2ã€finalizable å¯ä»¥æ‰§è¡Œfinalizeäº†ï¼Œç³»ç»Ÿä¼šåœ¨éšåçš„æŸä¸ªæ—¶é—´æ‰§è¡Œfinalizeã€‚<br>3ã€finalizedè¯¥å¯¹è±¡çš„finalizeå·²ç»è¢«æ‰§è¡Œäº†ã€‚ </p>
<p>GCæ€ä¹ˆæ¥ä¿æŒå¯¹finalizableçš„å¯¹è±¡çš„è¿½è¸ªå‘¢ã€‚GCæœ‰ä¸€ä¸ªQueueï¼Œ<br>å«åšF-Queueï¼Œæ‰€æœ‰å¯¹è±¡åœ¨å˜ä¸ºfinalizableçš„æ—¶å€™ä¼šåŠ å…¥åˆ°è¯¥Queueï¼Œç„¶åç­‰å¾…GCæ‰§è¡Œå®ƒçš„<br>finalizeæ–¹æ³•ã€‚</p>
<p>è¿™æ—¶æˆ‘ä»¬å¼•å…¥äº†å¯¹å¯¹è±¡çš„å¦å¤–ä¸€ç§è®°å½•åˆ†ç±»ï¼Œç³»ç»Ÿå¯ä»¥æ£€æŸ¥åˆ°ä¸€ä¸ªå¯¹è±¡å±äºå“ªä¸€ç§ã€‚</p>
<p>a.reachableï¼šæ´»åŠ¨çš„å¯¹è±¡å¼•ç”¨é“¾å¯ä»¥åˆ°è¾¾çš„å¯¹è±¡ï¼ŒåŒ…æ‹¬æ‰€æœ‰çº¿ç¨‹å½“å‰æ ˆçš„å±€éƒ¨å˜é‡ï¼Œ<br>æ‰€æœ‰çš„é™æ€å˜é‡ç­‰ç­‰ã€‚ </p>
<p>b.finalizer-reachableé™¤äº†reachableå¤–ï¼Œä»F-Queueå¯ä»¥é€šè¿‡å¼•ç”¨åˆ°è¾¾çš„å¯¹è±¡ã€‚<br>c.unreachableå…¶å®ƒçš„å¯¹è±¡</p>
<p><img src="https://github.com/basebase/img_server/blob/master/java-finalize%E6%96%B9%E6%B3%95/gc.gif?raw=true" alt="è½¬æ¢è¿‡ç¨‹"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">1.é¦–å…ˆï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½æ˜¯ä»Reachable+Unfinalizedèµ°å‘æ­»äº¡ä¹‹è·¯çš„ã€‚</div><div class="line"></div><div class="line">2.å½“å‰æ´»åŠ¨å¯¹è±¡ä¸å¯è¾¾æ—¶ï¼Œå¯¹è±¡å¯ä»¥ä»ReachableçŠ¶æ€å˜åˆ°F-Reachableæˆ–è€…UnreachableçŠ¶æ€ã€‚</div><div class="line"></div><div class="line">3.å½“å¯¹è±¡ä¸ºéReachable+Unfinalizedæ—¶ï¼ŒGCä¼šæŠŠå®ƒç§»å…¥F-Queueï¼Œ</div><div class="line">  çŠ¶æ€å˜ä¸ºF-Reachable+Finalizableã€‚</div><div class="line"></div><div class="line">4.å¥½äº†ï¼Œå…³é”®çš„æ¥äº†ï¼Œä»»ä½•æ—¶å€™ï¼ŒGCéƒ½å¯ä»¥ä»F-Queueä¸­æ‹¿åˆ°ä¸€ä¸ªFinalizableçš„å¯¹è±¡ï¼Œ</div><div class="line">  æ ‡è®°å®ƒä¸ºFinalizedï¼Œç„¶åæ‰§è¡Œå®ƒçš„finalizeæ–¹æ³•ï¼Œç”±äºè¯¥å¯¹è±¡åœ¨è¿™ä¸ªçº¿ç¨‹ä¸­åˆå¯è¾¾äº†ï¼Œ</div><div class="line">  äºæ˜¯è¯¥å¯¹è±¡å˜æˆReachableäº†ï¼ˆå¹¶ä¸”Finalizedï¼‰ã€‚è€Œfinalizeæ–¹æ³•æ‰§è¡Œæ—¶ï¼Œåˆæœ‰å¯èƒ½æŠŠå…¶å®ƒçš„F-Reachableçš„å¯¹è±¡å˜ä¸ºä¸€ä¸ªReachableçš„ï¼Œè¿™ä¸ªå«åšå¯¹è±¡å†ç”Ÿã€‚</div><div class="line"></div><div class="line">5.å½“ä¸€ä¸ªå¯¹è±¡åœ¨Unreachable+Unfinalizedæ—¶ï¼Œå¦‚æœè¯¥å¯¹è±¡ä½¿ç”¨çš„æ˜¯é»˜è®¤çš„Objectçš„finalizeï¼Œ</div><div class="line">  æˆ–è€…è™½ç„¶é‡å†™äº†ï¼Œä½†æ˜¯æ–°çš„å®ç°ä»€ä¹ˆä¹Ÿä¸å¹²ã€‚ä¸ºäº†æ€§èƒ½ï¼ŒGCå¯ä»¥æŠŠè¯¥å¯¹è±¡ç›´æ¥å˜åˆ°ReclaimedçŠ¶æ€ç›´æ¥é”€æ¯ï¼Œè€Œä¸ç”¨åŠ å…¥åˆ°F-Queueç­‰å¾…GCåšè¿›ä¸€æ­¥å¤„ç†ã€‚</div><div class="line"></div><div class="line">6.ä»çŠ¶æ€å›¾çœ‹å‡ºï¼Œä¸ç®¡æ€ä¹ˆæŠ˜è…¾ï¼Œä»»æ„ä¸€ä¸ªå¯¹è±¡çš„finalizeåªè‡³å¤šæ‰§è¡Œä¸€æ¬¡ï¼Œä¸€æ—¦å¯¹è±¡å˜ä¸ºFinalized</div><div class="line">  å°±æ€ä¹ˆä¹Ÿä¸ä¼šåœ¨å›åˆ°F-Queueå»äº†ã€‚å½“ç„¶æ²¡æœ‰æœºä¼šå†æ‰§è¡Œfinalizeäº†ã€‚ </div><div class="line"></div><div class="line">7.å½“å¯¹è±¡å¤„äºUnreachable+Finalizedæ—¶ï¼Œè¯¥å¯¹è±¡ç¦»çœŸæ­£çš„æ­»äº¡ä¸è¿œäº†ã€‚GCå¯ä»¥å®‰å…¨çš„å›æ”¶è¯¥å¯¹è±¡çš„</div><div class="line">  å†…å­˜äº†ã€‚è¿›å…¥Reclaimedã€‚</div></pre></td></tr></table></figure>
<h3 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test1</span> </span>&#123;</div><div class="line">	Test2 t2 ;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Test1</span><span class="params">(Test2 t2)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.t2 = t2;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Test1 finalize..."</span>);</div><div class="line">		Test3.t1 = <span class="keyword">this</span>;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test2</span> </span>&#123;</div><div class="line">	String name;</div><div class="line">	<span class="keyword">int</span> age;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Test2</span><span class="params">(String name, <span class="keyword">int</span> age)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.name = name;</div><div class="line">		<span class="keyword">this</span>.age = age;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">		System.out.println(<span class="string">"Test2 finalize..."</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.name + <span class="string">"is "</span> + age;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Test3</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> Test1 t1;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">		</div><div class="line">		Test1 t1 = <span class="keyword">new</span> Test1(<span class="keyword">new</span> Test2(<span class="string">"joker"</span>, <span class="number">18</span>));</div><div class="line">		System.out.println(t1);</div><div class="line">		t1 = <span class="keyword">null</span>;</div><div class="line">		</div><div class="line">		System.gc();</div><div class="line">		Thread.sleep(<span class="number">10000</span>);</div><div class="line">		System.out.println(Test3.t1);</div><div class="line">		System.out.println(Test3.t1.t2);</div><div class="line">		</div><div class="line">		t1 = <span class="keyword">null</span>;</div><div class="line">		System.gc();</div><div class="line">		System.out.println(<span class="string">"done."</span>);</div><div class="line">		</div><div class="line">		</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¾“å‡ºå¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cn.base.gc.test.Test1@6b04d3c8</div><div class="line">[GC 2642K-&gt;437K(251392K), 0.0012310 secs]</div><div class="line">[Full GC 437K-&gt;350K(251392K), 0.0102620 secs]</div><div class="line">Test1 finalize...</div><div class="line">Test2 finalize...</div><div class="line">cn.base.gc.test.Test1@6b04d3c8</div><div class="line">jokeris 18</div><div class="line">[GC 2992K-&gt;446K(251392K), 0.0006800 secs]</div><div class="line">[Full GC 446K-&gt;350K(251392K), 0.0069980 secs]</div><div class="line">done.</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°çš„æ˜¯æˆ‘ä»¬åœ¨é‡Šæ”¾test1çš„æ—¶å€™æˆå‘˜å¯¹è±¡test2ä¹Ÿä¸€èµ·è¢«å›æ”¶äº†ï¼Œç”±äºtest1é‡å†™äº†finalize<br>æ–¹æ³•ï¼Œåœ¨æœ€åtest1åˆå¤æ´»äº†ã€‚</p>
<p>ç”±äºåœ¨GC Rootä¸­åˆæœ‰å¼•ç”¨é“¾èµ·æ­»å›ç”Ÿï¼Œä½†æ˜¯æˆ‘ä¹ˆå†ä¸€æ¬¡è®¾ç½®nullå¹¶æ‰§è¡Œgcå¯ä»¥çœ‹åˆ°test1å¯¹è±¡<br>æ²¡æœ‰åœ¨è¿›å…¥finalizeæ–¹æ³•äº†ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>finalizeæ–¹æ³•ä¸æ˜¯æ¯æ¬¡éƒ½ä¼šæ‰§è¡Œçš„ï¼Œä½¿ç”¨System.gc()<br>ä¹Ÿåªä¸è¿‡æ˜¯åŠ å¿«gcè°ƒç”¨ï¼Œå¹¶ä¸”é‡å†™finalizeæ–¹æ³•æœ€å¥½ä¸è¦ä½¿å¯¹è±¡å†ç”Ÿï¼Œè¿™æ ·å®¹æ˜“é€ æˆ<br>å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ··ä¹±ï¼</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="http://mazhuang.org/2015/12/15/java-object-finalize/" target="_blank" rel="external">http://mazhuang.org/2015/12/15/java-object-finalize/</a><br><a href="http://bijian1013.iteye.com/blog/2289661" target="_blank" rel="external">http://bijian1013.iteye.com/blog/2289661</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[mapreduceè®¡ç®—uv]]></title>
      <url>http://yoursite.com/2016/08/23/mapreduce%E8%AE%A1%E7%AE%97uv/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶?<br>æˆ‘ä»¬åœ¨ç»Ÿè®¡çš„æ—¶å€™pvå’Œuvå¯ä»¥è¯´çš„æœ€åŸºç¡€çš„ä¹Ÿæ˜¯æœ€å¸¸è§çš„ï¼Œç›¸ä¿¡åšæ•°æ®çš„éƒ½çŸ¥é“ã€‚è¿™ç§éœ€æ±‚<br>æˆ‘ä»¬ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨hiveè¿›è¡Œç»Ÿè®¡å°±å®Œäº‹äº†ï¼Œéå¸¸çš„ç®€å•ã€‚<br>æ ¹æ®urlè®¡ç®—æ¯ä¸ªé¡µé¢çš„è®¿é—®æ¬¡æ•°å’Œç‹¬ç«‹è®¿å®¢ç”¨æˆ·æ•°ã€‚</p>
<a id="more"></a>
<h3 id="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶"><a href="#ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶" class="headerlink" title="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶?"></a>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ä»¶?</h3><p>æˆ‘ä»¬åœ¨ç»Ÿè®¡çš„æ—¶å€™pvå’Œuvå¯ä»¥è¯´çš„æœ€åŸºç¡€çš„ä¹Ÿæ˜¯æœ€å¸¸è§çš„ï¼Œç›¸ä¿¡åšæ•°æ®çš„éƒ½çŸ¥é“ã€‚è¿™ç§éœ€æ±‚<br>æˆ‘ä»¬ä¸€èˆ¬å°±æ˜¯ä½¿ç”¨hiveè¿›è¡Œç»Ÿè®¡å°±å®Œäº‹äº†ï¼Œéå¸¸çš„ç®€å•ã€‚<br>æ ¹æ®urlè®¡ç®—æ¯ä¸ªé¡µé¢çš„è®¿é—®æ¬¡æ•°å’Œç‹¬ç«‹è®¿å®¢ç”¨æˆ·æ•°ã€‚</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(gi) <span class="keyword">as</span> <span class="string">'pv'</span>, <span class="keyword">count</span>(<span class="keyword">distinct</span> gi) <span class="keyword">as</span> <span class="string">'uv'</span> <span class="keyword">from</span> </div><div class="line"><span class="keyword">table</span> <span class="keyword">where</span> cdate = <span class="string">'2016-06-01'</span> <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">url</span></div></pre></td></tr></table></figure>
<p>é‚£å¥½ï¼Œæˆ‘ä»¬é€šè¿‡mapreduceå¦‚ä½•è®¡ç®—å‘¢?<br>æˆ‘æƒ³æˆ‘å¤§å¤šæ•°äººéƒ½æ˜¯é€šè¿‡åœ¨reduceä¸­ä½¿ç”¨Setæˆ–è€…Listè¿›è¡Œåˆ¤æ–­æ˜¯å¦åœ¨é›†åˆä¸­å­˜åœ¨ï¼Œ<br>å¦‚æœä¸å­˜åœ¨é‚£ä¹ˆå°±åŠ 1ã€‚<br>äº‹å®å´æ˜¯å¦‚æ­¤ï¼Œæˆ‘æœç´¢å‘ç°å¾ˆå¤šblogéƒ½æ˜¯æ­¤æ–¹æ³•å¹¶ä¸”å†…å®¹å¤§è‡´ç›¸åŒï¼ŒåŒ…æ‹¬æˆ‘æœ€å¼€å§‹å†™çš„mapreduceä¹Ÿæ˜¯<br>æŒ‰ç…§è¿™ç§æ–¹æ³•åšçš„ã€‚</p>
<p>ä½†æ˜¯ï¼Œä½¿ç”¨è¿™ç§æ–¹æ³•åšæ•°æ®é‡å°çœ‹ä¸å‡ºé—®é¢˜ï¼Œä½†æ˜¯æ•°æ®é‡ä¸€æ—¦éå¸¸å¤§å°±é©¬ä¸Šå‡ºç°é—®é¢˜ã€‚<br>å› ä¸ºä½ çš„æ•°æ®æ”¾åœ¨äº†å†…å­˜ï¼Œå¾ˆå®¹æ˜“å°±oomäº†ã€‚</p>
<p>å…¶å®æˆ‘ä»¬éœ€è¦é€šè¿‡ä¸¤ä¸ªmapreduceè¿›è¡Œè®¡ç®—ã€‚<br>ç¬¬ä¸€ä¸ªmapå°±æ˜¯åˆ†å‰²url+uidä½œä¸ºkeyï¼Œvalueä¸º1<br>æ•°æ®æ ¼å¼å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http://www.google.com,zhangsan 1</div><div class="line">http://www.google.com,zhangsan 1</div><div class="line">http://www.google.com,zhangsan 1</div></pre></td></tr></table></figure>
<p>ç›¸åŒçš„keyå€¼å‘é€åˆ°åŒä¸€ä¸ªreduceä¸­ï¼Œè¿™æ ·çš„è¯zhangsançš„æ•°æ®éƒ½ä¸º1äº†ï¼Œreduceä¸ç”¨åšä»€ä¹ˆå°±æ˜¯<br>æŠŠkeyå†™å…¥å°±è¡Œã€‚</p>
<p>ç„¶ååˆ°äº†ç¬¬äºŒä¸ªmapä¸­ï¼Œæˆ‘ä»¬å°†ç¬¬ä¸€ä¸ªreduceçš„æ•°æ®è¿›è¡Œæ‹†è§£å°±å¾—åˆ°äº†urlå’Œuidçš„æ•°æ®äº†<br>ç”±äºåœ¨ç¬¬ä¸€ä¸ªmrä¸­å·²ç»å°†ç›¸åŒçš„uidå’Œurlå½’ä¸ºä¸€ç±»ï¼Œæ‰€ä»¥ä¸ä¼šå­˜åœ¨é‡å¤æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œå°±å’Œ<br>wordcountä¸€æ ·è®¡ç®—å°±è¡Œäº†ã€‚</p>
<h3 id="å®è·µ"><a href="#å®è·µ" class="headerlink" title="å®è·µ"></a>å®è·µ</h3><p>ä¸Šé¢å·²ç»è¯´äº†è¿™ä¹ˆå¤šäº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰å¾ˆä¹å‘³äº†ã€‚æ¥çœ‹çœ‹ä»£ç é†’é†’è„‘å§ï¼Œå˜¿å˜¿å˜¿~</p>
<p>ä½¿ç”¨hadoop2.7.0</p>
<p>æµ‹è¯•æ•°æ®:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">http://www.google.com,2016-01-02,dsadasd-dasd-as-das</div><div class="line">https://www.ibm.com/developerworks/cn/opensource/os-cn-hadoop-name-node/,2016-01-02,000-111-11-22</div><div class="line">http://www.jd.com/?keyword=dadas&amp;keywordid=34879410794&amp;re_dcp=202m0QjIIg==&amp;traffic_source=1004&amp;test=1&amp;enc=utf8&amp;cu=true&amp;utm_source=baidu-search&amp;utm_medium=cpc&amp;utm_campaign=t_262767352_baidusearch&amp;utm_term=34879410794_0_b0d37d1995654fdb9c013c4eb7544071,2016-01-02,dasdsa-ds-ad-as-da</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsddddd-dsss</div><div class="line">http://mall.jd.com/index-56654.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://item.jd.com/3148810.html,2016-01-02,d99dsa-dsdasdsa-dasdj</div><div class="line">http://item.jd.com/3148810.html,2016-01-02,d99dsa-dsdasdasda-sadas</div><div class="line">http://item.jd.com/3148762.html,2016-01-02,d99dsa-dsdasdsa-xxxx</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVMapper</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Text k = <span class="keyword">new</span> Text();</div><div class="line">	<span class="keyword">private</span> LongWritable v = <span class="keyword">new</span> LongWritable(<span class="number">1</span>);</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">		</div><div class="line">		String line = value.toString();</div><div class="line">		String[] tokens = line.split(<span class="string">","</span>);</div><div class="line">		</div><div class="line">		<span class="comment">// url + uid</span></div><div class="line">		k.set(tokens[<span class="number">0</span>] + <span class="string">","</span> + tokens[<span class="number">2</span>]);</div><div class="line">		context.write(k, v);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVReducer</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">NullWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;LongWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">		context.write(key, NullWritable.get());</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVMapperUp</span> <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Text k = <span class="keyword">new</span> Text();</div><div class="line">	<span class="keyword">private</span> LongWritable v = <span class="keyword">new</span> LongWritable(<span class="number">1</span>);</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, InterruptedException &#123;</div><div class="line">		</div><div class="line">		String line = value.toString();</div><div class="line">		String[] tokens = line.split(<span class="string">","</span>);</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (tokens.length != <span class="number">2</span>) &#123;</div><div class="line">			<span class="keyword">return</span> ;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		String url = tokens[<span class="number">0</span>];</div><div class="line">		</div><div class="line">		k.set(url);</div><div class="line">		context.write(k, v);</div><div class="line">		</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVReducerUp</span> <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>, <span class="title">LongWritable</span>, <span class="title">Text</span>, <span class="title">LongWritable</span>&gt; </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> LongWritable res = <span class="keyword">new</span> LongWritable();</div><div class="line">	</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;LongWritable&gt; values, Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</div><div class="line">		<span class="keyword">long</span> sum = <span class="number">0</span>;</div><div class="line">		<span class="keyword">for</span> (LongWritable val : values) &#123;</div><div class="line">			sum += val.get();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		res.set(sum);</div><div class="line">		</div><div class="line">		context.write(key, res);</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configured;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.LongWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.NullWritable;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.TextInputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.util.Tool;</div><div class="line"><span class="keyword">import</span> org.apache.hadoop.util.ToolRunner;</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UVApp</span> <span class="keyword">extends</span> <span class="title">Configured</span> <span class="keyword">implements</span> <span class="title">Tool</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			</div><div class="line">			args = <span class="keyword">new</span> String[]&#123;<span class="string">"in/browse.txt"</span>, <span class="string">"uv_out"</span>, <span class="string">"f_uv_out"</span>&#125;;</div><div class="line">			ToolRunner.run(<span class="keyword">new</span> Configuration(), <span class="keyword">new</span> UVApp(), args);</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">run</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">		</div><div class="line">		</div><div class="line">		Configuration conf = <span class="keyword">new</span> Configuration();</div><div class="line">		Job job1 = Job.getInstance(conf, <span class="string">"uv"</span>);</div><div class="line">		Job job2 = Job.getInstance(conf, <span class="string">"uv"</span>);</div><div class="line">		</div><div class="line">		job1.setJarByClass(UVApp.class);</div><div class="line">		job2.setJarByClass(UVApp.class);</div><div class="line">		</div><div class="line">		job1.setMapperClass(UVMapper.class);</div><div class="line">		job1.setReducerClass(UVReducer.class);</div><div class="line">		</div><div class="line">		job2.setMapperClass(UVMapperUp.class);</div><div class="line">		job2.setReducerClass(UVReducerUp.class);</div><div class="line">		</div><div class="line">		job1.setMapOutputKeyClass(Text.class);</div><div class="line">		job1.setMapOutputValueClass(LongWritable.class);</div><div class="line">		</div><div class="line">		job2.setMapOutputKeyClass(Text.class);</div><div class="line">		job2.setOutputValueClass(LongWritable.class);</div><div class="line">		</div><div class="line">		job1.setOutputKeyClass(Text.class);</div><div class="line">		job1.setOutputValueClass(NullWritable.class);</div><div class="line">		</div><div class="line">		job2.setOutputKeyClass(Text.class);</div><div class="line">		job2.setOutputValueClass(LongWritable.class);</div><div class="line">		</div><div class="line">		FileInputFormat.addInputPath(job1, <span class="keyword">new</span> Path(args[<span class="number">0</span>]));</div><div class="line">		FileOutputFormat.setOutputPath(job1, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line">		</div><div class="line">		FileInputFormat.addInputPath(job2, <span class="keyword">new</span> Path(args[<span class="number">1</span>]));</div><div class="line">		FileOutputFormat.setOutputPath(job2, <span class="keyword">new</span> Path(args[<span class="number">2</span>]));</div><div class="line">		</div><div class="line">		<span class="keyword">int</span> code = job1.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span>(code != <span class="number">0</span>)&#123;</div><div class="line">			System.exit(<span class="number">1</span>);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">return</span> job2.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p> ä¸€èˆ¬ä½¿ç”¨åˆ†å¸ƒå¼æ¡†æ¶è¡¨ç¤ºæˆ‘ä»¬æ•°æ®æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œæ”¾å†…å­˜è‚¯å®šæ˜¯ä¸åˆç†çš„ã€‚<br> çœ‹æ¥ä»£ç è´¨é‡æœ‰å¾…æé«˜ï¼ï¼ï¼</p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[stormæ•´åˆkafkaé‡å¤æ¶ˆè´¹é—®é¢˜åˆ†æ]]></title>
      <url>http://yoursite.com/2016/08/11/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?<br>æœ€è¿‘åœ¨æ•´åˆstorm+kafkaä¸€ç›´çº ç»“äºé‡å¤æ•°æ®çš„è¯»å–ï¼Œé‡æ–°å¯åŠ¨topologyæ›´æ˜¯æŠŠkafkaçš„æ•°æ®æ‰«æä¸€éï¼Œ<br>ã€å¦‚æœçº¿ä¸Šé€»è¾‘è¾ƒé‡ï¼Œå¹¶ä¸”è¿˜è¦å¾€æ•°æ®åº“é‡Œé¢æ’å…¥æ•°æ®æ˜¯ä¸æ˜¯æœ‰å¾ˆå¤šé‡å¤æ•°æ®äº†ï¼ã€‘</p>
<a id="more"></a>
<h3 id="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« "><a href="#ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« " class="headerlink" title="ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?"></a>ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ?</h3><p>æœ€è¿‘åœ¨æ•´åˆstorm+kafkaä¸€ç›´çº ç»“äºé‡å¤æ•°æ®çš„è¯»å–ï¼Œé‡æ–°å¯åŠ¨topologyæ›´æ˜¯æŠŠkafkaçš„æ•°æ®æ‰«æä¸€éï¼Œ<br>ã€å¦‚æœçº¿ä¸Šé€»è¾‘è¾ƒé‡ï¼Œå¹¶ä¸”è¿˜è¦å¾€æ•°æ®åº“é‡Œé¢æ’å…¥æ•°æ®æ˜¯ä¸æ˜¯æœ‰å¾ˆå¤šé‡å¤æ•°æ®äº†ï¼ã€‘</p>
<h3 id="è½¯ä»¶ç¯å¢ƒ"><a href="#è½¯ä»¶ç¯å¢ƒ" class="headerlink" title="è½¯ä»¶ç¯å¢ƒ"></a>è½¯ä»¶ç¯å¢ƒ</h3><p>zookeeper-3.4.6.tar.gz<br>kafka_2.9.2-0.8.1.1<br>apache-storm-1.0.1.tar.gz</p>
<h3 id="å®è·µå‡ºçœŸçŸ¥"><a href="#å®è·µå‡ºçœŸçŸ¥" class="headerlink" title="å®è·µå‡ºçœŸçŸ¥"></a>å®è·µå‡ºçœŸçŸ¥</h3><p>é‚£æˆ‘ä»¬çŸ¥é“è¿™kafkaå’Œstorméƒ½æ˜¯ä¾èµ–zkçš„ï¼Œå¹¶ä¸”æˆ‘ä»¬åœ¨åˆ›å»ºtopologyçš„æ—¶å€™ä¹Ÿæ˜¯æŠŠoffsetå†™å…¥åˆ°zk<br>ä½†æ˜¯ä¸€å¼€å§‹çš„ç¨‹åºæ˜¯éå¸¸å¥‡æ€ªçš„ï¼Œzkå¹¶æ²¡æœ‰åˆ›å»ºæˆ‘æ‰€æŒ‡å®šçš„ç›®å½•å’Œidã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸ªâ€é”™è¯¯â€çš„ä¾‹å­</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> cn.base.sk.ex03;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SplitBolt</span> <span class="keyword">extends</span> <span class="title">BaseRichBolt</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = -<span class="number">1380001209433177193L</span>;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> OutputCollector collector = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map stormConf, TopologyContext context, OutputCollector collector)</span> </span>&#123;</div><div class="line">		<span class="keyword">this</span>.collector = collector;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input)</span> </span>&#123;</div><div class="line">		String word = input.getString(<span class="number">0</span>);</div><div class="line">		System.out.println(<span class="string">"source data =&gt; "</span> + word);</div><div class="line">		<span class="comment">//collector.ack(input);</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.base.sk.ex03;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Arrays;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.storm.Config;</div><div class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.BrokerHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.KafkaSpout;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.SpoutConfig;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.StringScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.ZkHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.spout.SchemeAsMultiScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</div><div class="line"></div><div class="line"><span class="keyword">import</span> cn.base.sk.ex02.MyKafkaTopology;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaTopology</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		String zks = <span class="string">"localhost:2181/kafka"</span>;</div><div class="line">		String topic = <span class="string">"topic2"</span>;</div><div class="line">		String zkRoot = <span class="string">"/topic2"</span>;</div><div class="line">		String id = <span class="string">"split"</span>;</div><div class="line"></div><div class="line">		BrokerHosts brokerHosts = <span class="keyword">new</span> ZkHosts(zks);</div><div class="line">		SpoutConfig spoutConf = <span class="keyword">new</span> SpoutConfig(brokerHosts, topic, zkRoot, id);</div><div class="line">		spoutConf.scheme = <span class="keyword">new</span> SchemeAsMultiScheme(<span class="keyword">new</span> StringScheme());</div><div class="line">		spoutConf.zkServers = Arrays.asList(<span class="keyword">new</span> String[] &#123;<span class="string">"localhost"</span>&#125;);</div><div class="line">		spoutConf.zkPort = <span class="number">2181</span>;</div><div class="line"></div><div class="line"></div><div class="line">		TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">		builder.setSpout(<span class="string">"kafka-spoutx"</span>, <span class="keyword">new</span> KafkaSpout(spoutConf));</div><div class="line">		builder.setBolt(<span class="string">"word-splitx"</span>, <span class="keyword">new</span> SplitBolt()).shuffleGrouping(<span class="string">"kafka-spoutx"</span>);</div><div class="line"></div><div class="line">		Config conf = <span class="keyword">new</span> Config();</div><div class="line">		String name = MyKafkaTopology.class.getSimpleName();</div><div class="line">		conf.setMaxTaskParallelism(<span class="number">3</span>);</div><div class="line"></div><div class="line">		LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</div><div class="line">		cluster.submitTopology(name, conf, builder.createTopology());</div><div class="line"></div><div class="line"><span class="comment">//		Utils.sleep(10000);</span></div><div class="line"><span class="comment">//		cluster.shutdown();</span></div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªä¾‹å­æ˜¯æ— æ³•åœ¨zkä¸­åˆ›å»º/topic2/splitçš„ï¼Œè‡³äºä¸ºä»€ä¹ˆæˆ‘åœ¨åé¢ä¼šè¯´æ˜ã€‚<br>ç”±äºä¹Ÿæ˜¯æœ€è¿‘å‡ å¤©æ‰å¼€å§‹æ’¸èµ·æ¥çš„æ‰€ä»¥æˆ‘å°±å„ç§æœç´¢ï¼Œåœ¨ä¸€ä¸ªblogä¸­æ‰¾åˆ°äº†è¯´æ˜</p>
<p><font color="DeepPink" size="2">åŸæ–‡<br>    æ­¤å¤„éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œè¦ä½¿ç”¨backtype.storm.topology.base.BaseBasicBoltå¯¹è±¡ä½œä¸ºçˆ¶ç±»ï¼Œå¦åˆ™ä¸ä¼šåœ¨zkè®°å½•åç§»é‡offsetæ•°æ®ã€‚<br></font><br>åæ¥æˆ‘ä¿®æ”¹boltç»§æ‰¿è¯¥ç±»ç¡®å®åœ¨zkä¸­åˆ›å»ºå‡ºäº†topicï¼Œä½†æ˜¯è‡³äºä¸ºä»€ä¹ˆå¹¶æ²¡æœ‰è¯¦ç»†è¯´æ˜ã€‚<br>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ä¿®æ”¹åçš„codeã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">package</span> cn.base.sk.ex02;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</div><div class="line"><span class="keyword">import</span> org.apache.log4j.Logger;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.BasicOutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseBasicBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Values;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KafkaWordSplitter</span> <span class="keyword">extends</span> <span class="title">BaseBasicBolt</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Log logger = LogFactory.getLog(KafkaWordSplitter.class);</div><div class="line">	<span class="keyword">private</span> OutputCollector collector;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input, BasicOutputCollector collector)</span> </span>&#123;</div><div class="line">		String line = input.getString(<span class="number">0</span>);</div><div class="line">		System.out.println(<span class="string">"RECV[kafka -&gt; splitter] "</span> + line);</div><div class="line"></div><div class="line">		String[] words = line.split(<span class="string">","</span>);</div><div class="line">		<span class="keyword">for</span> (String word : words) &#123;</div><div class="line">			System.out.println(<span class="string">"EMIT[splitter -&gt; counter] "</span> + word);</div><div class="line">			collector.emit(<span class="keyword">new</span> Values(word, <span class="number">1</span>));</div><div class="line">		&#125;</div><div class="line"></div><div class="line"><span class="comment">//		collector.ack(input);</span></div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;</div><div class="line">		declarer.declare(<span class="keyword">new</span> Fields(<span class="string">"word"</span>, <span class="string">"count"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line">`</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.base.sk.ex02;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.util.HashMap;</div><div class="line"><span class="keyword">import</span> java.util.Iterator;</div><div class="line"><span class="keyword">import</span> java.util.Map;</div><div class="line"><span class="keyword">import</span> java.util.Map.Entry;</div><div class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.Log;</div><div class="line"><span class="keyword">import</span> org.apache.commons.logging.LogFactory;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.OutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.task.TopologyContext;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.BasicOutputCollector;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.OutputFieldsDeclarer;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseBasicBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.base.BaseRichBolt;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Tuple;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WordCounter</span> <span class="keyword">extends</span> <span class="title">BaseBasicBolt</span> </span>&#123;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Log logger = LogFactory.getLog(WordCounter.class);</div><div class="line">	<span class="keyword">private</span> OutputCollector collector;</div><div class="line">	<span class="keyword">private</span> Map&lt;String, AtomicInteger&gt; countMap;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">prepare</span><span class="params">(Map stormConf, TopologyContext context)</span> </span>&#123;</div><div class="line">		countMap = <span class="keyword">new</span> HashMap&lt;String, AtomicInteger&gt;();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">cleanup</span><span class="params">()</span> </span>&#123;</div><div class="line">		System.out.println(<span class="string">"The final result:"</span>);</div><div class="line">		Iterator&lt;Entry&lt;String, AtomicInteger&gt;&gt; iter = <span class="keyword">this</span>.countMap.entrySet().iterator();</div><div class="line">		<span class="keyword">while</span> (iter.hasNext()) &#123;</div><div class="line"></div><div class="line">			Entry&lt;String, AtomicInteger&gt; entry = iter.next();</div><div class="line">			System.out.println(entry.getKey() + <span class="string">"\t:\t"</span> + entry.getValue().get());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(Tuple input, BasicOutputCollector collector)</span> </span>&#123;</div><div class="line">		String word = input.getString(<span class="number">0</span>);</div><div class="line">		Integer count = input.getInteger(<span class="number">1</span>);</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"RECV[splitter -&gt; counter] "</span> + word + <span class="string">" : "</span> + count);</div><div class="line">		AtomicInteger ai = <span class="keyword">this</span>.countMap.get(word);</div><div class="line">		<span class="keyword">if</span> (ai == <span class="keyword">null</span>) &#123;</div><div class="line">			ai = <span class="keyword">new</span> AtomicInteger(<span class="number">1</span>);</div><div class="line">			<span class="keyword">this</span>.countMap.put(word, ai);</div><div class="line">		&#125;<span class="keyword">else</span> &#123;</div><div class="line">			ai.addAndGet(count);</div><div class="line"><span class="comment">//			collector.ack(input);</span></div><div class="line">			System.out.println(<span class="string">"CHECK statistics map: "</span> + <span class="keyword">this</span>.countMap);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">declareOutputFields</span><span class="params">(OutputFieldsDeclarer declarer)</span> </span>&#123;&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> cn.base.sk.ex02;</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.apache.kafka.common.utils.Utils;</div><div class="line"><span class="keyword">import</span> org.apache.storm.Config;</div><div class="line"><span class="keyword">import</span> org.apache.storm.LocalCluster;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.BrokerHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.KafkaSpout;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.SpoutConfig;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.StringScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.kafka.ZkHosts;</div><div class="line"><span class="keyword">import</span> org.apache.storm.spout.SchemeAsMultiScheme;</div><div class="line"><span class="keyword">import</span> org.apache.storm.topology.TopologyBuilder;</div><div class="line"><span class="keyword">import</span> org.apache.storm.tuple.Fields;</div><div class="line"></div><div class="line"><span class="keyword">import</span> scala.actors.threadpool.Arrays;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyKafkaTopology</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		String zks = <span class="string">"localhost:2181/kafka"</span>;</div><div class="line">		String topic = <span class="string">"topic1"</span>;</div><div class="line">		String zkRoot = <span class="string">"/topic1"</span>;</div><div class="line">		String id = <span class="string">"word"</span>;</div><div class="line"></div><div class="line">		BrokerHosts brokerHosts = <span class="keyword">new</span> ZkHosts(zks);</div><div class="line">		SpoutConfig spoutConf = <span class="keyword">new</span> SpoutConfig(brokerHosts, topic, zkRoot, id);</div><div class="line">		spoutConf.scheme = <span class="keyword">new</span> SchemeAsMultiScheme(<span class="keyword">new</span> StringScheme());</div><div class="line">		spoutConf.zkServers = Arrays.asList(<span class="keyword">new</span> String[] &#123;<span class="string">"localhost"</span>&#125;);</div><div class="line">		spoutConf.zkPort = <span class="number">2181</span>;</div><div class="line"></div><div class="line"></div><div class="line">		TopologyBuilder builder = <span class="keyword">new</span> TopologyBuilder();</div><div class="line">		builder.setSpout(<span class="string">"kafka-spout"</span>, <span class="keyword">new</span> KafkaSpout(spoutConf));</div><div class="line">		builder.setBolt(<span class="string">"word-split"</span>, <span class="keyword">new</span> KafkaWordSplitter()).shuffleGrouping(<span class="string">"kafka-spout"</span>);</div><div class="line">		builder.setBolt(<span class="string">"word-count"</span>, <span class="keyword">new</span> WordCounter()).fieldsGrouping(<span class="string">"word-split"</span>, <span class="keyword">new</span> Fields(<span class="string">"word"</span>));</div><div class="line"></div><div class="line">		Config conf = <span class="keyword">new</span> Config();</div><div class="line">		String name = MyKafkaTopology.class.getSimpleName();</div><div class="line">		conf.setMaxTaskParallelism(<span class="number">3</span>);</div><div class="line"></div><div class="line">		LocalCluster cluster = <span class="keyword">new</span> LocalCluster();</div><div class="line">		cluster.submitTopology(name, conf, builder.createTopology());</div><div class="line"></div><div class="line"><span class="comment">//		Utils.sleep(10000);</span></div><div class="line"><span class="comment">//		cluster.shutdown();</span></div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŸè°…æˆ‘å†™äº†ä¸¤ä¸ªä¾‹å­å§!<br>å¥½çš„ï¼Œä¸Šé¢ä¸€å¤§æ®µä»£ç æ˜¯ä¿®æ”¹è¿‡çš„ã€‚æ­¤æ—¶è¿›å…¥zkcliå·²ç»åˆ›å»ºå‡ºæ¥äº†æˆ‘ä»¬æ‰€éœ€çš„è·¯å¾„<br>å¹¶ä¸”å·²ç»è®°å½•äº†offset</p>
<p><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/01.png?raw=true" alt="zkæ•°æ®"></p>
<p>è¯»å–æ•°æ®çš„æ—¶å€™å°±ä»è¿™é‡Œå¼€å§‹äº†ã€‚<br>é‚£å¥½ï¼Œä¸ºå•¥ç»§æ‰¿äº†BaseBasicBoltç±»å°±å¯ä»¥ï¼Œè€ŒBaseRichBoltç±»å°±ä¸è¡Œå‘¢ã€‚</p>
<h3 id="èµ°è¿›æºç "><a href="#èµ°è¿›æºç " class="headerlink" title="èµ°è¿›æºç "></a>èµ°è¿›æºç </h3><p>é¦–å…ˆçœ‹çœ‹KafkaSpoutç±»çš„openæ–¹æ³•åšäº†ä¸€äº›åˆå§‹åŒ–çš„å·¥ä½œ<br>ä¸‹å›¾æ‰æ˜¯æˆ‘ä¹ˆè¦çœ‹çš„</p>
<p><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/02.png?raw=true" alt="kafkaSpout!nextTuple"></p>
<p>ä¸ç”¨åœ¨æ„å…¶å®ƒæ–¹æ³•ï¼Œç›´æ¥è¿›å…¥commit()æ–¹æ³•<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/03.png?raw=true" alt="kafkaSpout!commit"></p>
<p>çœ‹åˆ°æ²¡ï¼Œ åªè¦ifæˆç«‹å°±ä¼šåœ¨zkä¸­åˆ›å»ºæ•°æ®ã€‚ä½†æ˜¯ä¸ºä»€ä¹ˆä¸èƒ½è¿›å…¥å‘¢ï¼Œæ¥çœ‹çœ‹lastCompletedOffset<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/04.png?raw=true" alt="kafkaSpout!lastCompletedOffset"></p>
<p>å½“ä½ debugåˆ°è¿™é‡Œçš„æ—¶å€™é¦–å…ˆè·å–çš„æ˜¯ç¬¬ä¸€ä¸ªkeyï¼Œè¿™ä¸ªmapçš„keyæ˜¯offsetï¼Œvalueæ˜¯timestamp<br>è¯»ä¸€æ¬¡ä¼šå’Œä¸Šä¸€æ¬¡è¿›è¡Œæ¯”è¾ƒï¼Œæœ€ç»ˆåœ¨é‡Œé¢é‡æ–°èµ‹å€¼æœ€æ–°çš„offsetã€‚</p>
<p>ä»”ç»†è§‚å¯Ÿï¼Œå¦‚æœç»§æ‰¿BaseRichSpoutç±»ï¼Œè°ƒç”¨è¿‡åmapçš„keyä¾æ—§å­˜åœ¨ï¼Œè€ŒBaseBasicBoltä¼šè¿›è¡Œåˆ é™¤ï¼Œå¦‚æœä¸åˆ é™¤çš„è¯ä¼šåœ¨commitåˆ¤æ–­æ—¶å€™ä¸€ç›´ç›¸ç­‰ã€‚</p>
<p>é‚£ä¹ˆï¼Œæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™è¿›è¡Œåˆ é™¤çš„å‘¢ï¼Ÿå¦‚æœæ˜¯ä½ ï¼Œä½ ä¼šæƒ³åœ¨ä»€ä¹ˆæ—¶å€™æŠŠè¿™ä»½æ•°æ®è¿›è¡Œåˆ é™¤ï¼Ÿ<br>å¯¹çš„ï¼Œå½“æˆ‘ä»¬ç¡®è®¤å®Œæ¯•è¿™æ¡æ•°æ®è¢«æ¶ˆè´¹åï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆ é™¤äº†ã€‚</p>
<p>åœ¨è¿›è¡Œackä¹‹åï¼Œæˆ‘ä»¬çœ‹åˆ°åˆ é™¤mapçš„æ•°æ®ï¼Œè¿™æ ·å°±é¡ºåˆ©çš„åœ¨zké‡Œé¢åˆ›å»ºå¹¶å†™å…¥æ•°æ®ã€‚<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/05.png?raw=true" alt="kafkaSpout!ack"></p>
<p>é‚£ä¹ˆï¼Œå¦‚æœæˆ‘å°±æƒ³ç»§æ‰¿è‡ªBaseRichBoltç±»ï¼Œé‚£æœ‰åŠæ³•å®ç°å—ï¼Ÿè‚¯å®šçš„ï¼Œä½ åªéœ€è¦è‡ªå·±ackä¸€ä¸‹å°±è¡Œäº†<br><img src="https://github.com/basebase/img_server/blob/master/storm%E6%95%B4%E5%90%88kafka%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9%E9%97%AE%E9%A2%98%E5%88%86%E6%9E%90_img/06.png?raw=true" alt="UserBolt!ack"></p>
<p>okï¼Œæ­¤æ—¶ä½ åœ¨æ¬¡æ‰“å¼€zkcliæŸ¥çœ‹å°±å­˜åœ¨æŒ‡å®šçš„ç›®å½•å’Œidï¼Œå¹¶ä¸”é‡å¯topologyä¹Ÿä¸ä¼šé‡æ–°è¯»å–å†å²ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>BaseBasicBoltæ²¡æœ‰æä¾›ackè€Œæ˜¯éšç¤ºè¿›è¡Œäº†è°ƒç”¨ï¼Œè€ŒBaseRichSpoutéœ€è¦æ˜¾ç¤ºè°ƒç”¨ã€‚</p>
<h3 id="ç»“å°¾"><a href="#ç»“å°¾" class="headerlink" title="ç»“å°¾"></a>ç»“å°¾</h3><p>å‚è€ƒï¼š<a href="http://www.howardliu.cn/a-few-notes-about-storm/" target="_blank" rel="external">http://www.howardliu.cn/a-few-notes-about-storm/</a></p>
]]></content>
    </entry>
    
  
  
</search>
